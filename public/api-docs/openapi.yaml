openapi: 3.0.3
info:
  title: MenuLab Public API
  description: |
    Enterprise API для интеграции с ресторанными системами.

    ## Аутентификация

    API поддерживает два метода аутентификации:

    ### API Key (для серверных интеграций)
    ```
    X-API-Key: ml_your_api_key
    X-API-Secret: your_api_secret
    ```

    ### Bearer Token (для клиентских приложений)
    ```
    Authorization: Bearer your_access_token
    ```

    ## Rate Limiting

    | План | Лимит | Burst |
    |------|-------|-------|
    | Free | 60/мин | 10 |
    | Business | 300/мин | 50 |
    | Enterprise | 1000/мин | 100 |

    Заголовки ответа:
    - `X-RateLimit-Limit` — лимит запросов
    - `X-RateLimit-Remaining` — оставшиеся запросы
    - `X-RateLimit-Reset` — время сброса (Unix timestamp)

    ## Idempotency

    Для POST/PATCH запросов рекомендуется использовать заголовок `X-Idempotency-Key`
    для безопасных повторных запросов. Ключ действует 24 часа.

    ## Webhooks

    API отправляет webhook-уведомления о событиях. Настройте URL в разделе Webhooks.
    Подпись запроса в заголовке `X-MenuLab-Signature` (HMAC-SHA256).

  version: 1.0.0
  contact:
    name: MenuLab API Support
    email: api@menulab.ru
  license:
    name: Proprietary

servers:
  - url: https://api.menulab.ru/api/v1
    description: Production
  - url: https://sandbox.menulab.ru/api/v1
    description: Sandbox

tags:
  - name: Auth
    description: Аутентификация и токены
  - name: Menu
    description: Меню, категории, блюда
  - name: Orders
    description: Заказы
  - name: Customers
    description: Клиенты
  - name: Tables
    description: Столы и зоны
  - name: Reservations
    description: Бронирования
  - name: Delivery
    description: Доставка
  - name: Loyalty
    description: Программа лояльности
  - name: Kitchen
    description: Кухня (KDS)
  - name: Payments
    description: Платежи
  - name: Batch
    description: Пакетные операции
  - name: Webhooks
    description: Управление вебхуками

paths:
  # ==================== AUTH ====================
  /auth/refresh:
    post:
      tags: [Auth]
      summary: Обновить токен
      description: Получить новый access token используя refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
                  example: "1|abc123..."
      responses:
        '200':
          description: Токен обновлён
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/me:
    get:
      tags: [Auth]
      summary: Информация о токене
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Информация о текущем токене
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      client_id:
                        type: integer
                      client_name:
                        type: string
                      scopes:
                        type: array
                        items:
                          type: string
                      plan:
                        type: string
                        enum: [free, business, enterprise]

  # ==================== MENU ====================
  /menu/categories:
    get:
      tags: [Menu]
      summary: Список категорий
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/IncludeParam'
      responses:
        '200':
          description: Список категорий
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Category'

  /menu/categories/{id}:
    get:
      tags: [Menu]
      summary: Получить категорию
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Категория
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Category'
        '404':
          $ref: '#/components/responses/NotFound'

  /menu/dishes:
    get:
      tags: [Menu]
      summary: Список блюд
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: category_id
          in: query
          schema:
            type: integer
          description: Фильтр по категории
        - name: is_available
          in: query
          schema:
            type: boolean
          description: Только доступные
        - name: search
          in: query
          schema:
            type: string
          description: Поиск по названию
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Список блюд
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Dish'
                      meta:
                        $ref: '#/components/schemas/Pagination'

  /menu/dishes/{id}:
    get:
      tags: [Menu]
      summary: Получить блюдо
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Блюдо
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Dish'

  /menu/stop-list:
    get:
      tags: [Menu]
      summary: Стоп-лист
      description: Список недоступных блюд
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Стоп-лист
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            dish_id:
                              type: integer
                            name:
                              type: string
                            reason:
                              type: string

  /menu/full:
    get:
      tags: [Menu]
      summary: Полное меню
      description: Категории с вложенными блюдами
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Полное меню
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          allOf:
                            - $ref: '#/components/schemas/Category'
                            - type: object
                              properties:
                                dishes:
                                  type: array
                                  items:
                                    $ref: '#/components/schemas/Dish'

  # ==================== ORDERS ====================
  /orders:
    get:
      tags: [Orders]
      summary: Список заказов
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [new, confirmed, cooking, ready, delivering, completed, cancelled]
        - name: type
          in: query
          schema:
            type: string
            enum: [dine_in, delivery, pickup]
        - name: date
          in: query
          schema:
            type: string
            format: date
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Список заказов
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Order'
                      meta:
                        $ref: '#/components/schemas/Pagination'

    post:
      tags: [Orders]
      summary: Создать заказ
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: Заказ создан
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '422':
          $ref: '#/components/responses/ValidationError'

  /orders/{id}:
    get:
      tags: [Orders]
      summary: Получить заказ
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Заказ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [Orders]
      summary: Обновить заказ
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                comment:
                  type: string
                delivery_address:
                  type: string
                scheduled_at:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Заказ обновлён
        '404':
          $ref: '#/components/responses/NotFound'

  /orders/{id}/confirm:
    post:
      tags: [Orders]
      summary: Подтвердить заказ
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                estimated_time:
                  type: integer
                  description: Время готовности в минутах
      responses:
        '200':
          description: Заказ подтверждён

  /orders/{id}/ready:
    post:
      tags: [Orders]
      summary: Заказ готов
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Статус обновлён

  /orders/{id}/complete:
    post:
      tags: [Orders]
      summary: Завершить заказ
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Заказ завершён

  /orders/{id}/cancel:
    post:
      tags: [Orders]
      summary: Отменить заказ
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
                  description: Причина отмены
      responses:
        '200':
          description: Заказ отменён

  /orders/calculate:
    post:
      tags: [Orders]
      summary: Расчёт стоимости заказа
      description: Предварительный расчёт без создания заказа
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '200':
          description: Расчёт
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      subtotal:
                        type: string
                      discount:
                        type: string
                      delivery_fee:
                        type: string
                      total:
                        type: string

  # ==================== CUSTOMERS ====================
  /customers:
    get:
      tags: [Customers]
      summary: Список клиентов
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: search
          in: query
          schema:
            type: string
          description: Поиск по имени или телефону
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Список клиентов
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Customer'

    post:
      tags: [Customers]
      summary: Создать клиента
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phone]
              properties:
                phone:
                  type: string
                  example: "+79991234567"
                name:
                  type: string
                email:
                  type: string
                  format: email
                birthday:
                  type: string
                  format: date
                notes:
                  type: string
      responses:
        '201':
          description: Клиент создан

  /customers/{id}:
    get:
      tags: [Customers]
      summary: Получить клиента
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Клиент
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Customer'

    patch:
      tags: [Customers]
      summary: Обновить клиента
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                email:
                  type: string
                birthday:
                  type: string
                  format: date
                notes:
                  type: string
      responses:
        '200':
          description: Клиент обновлён

  /customers/phone/{phone}:
    get:
      tags: [Customers]
      summary: Найти по телефону
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: phone
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Клиент найден
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== LOYALTY ====================
  /loyalty/program:
    get:
      tags: [Loyalty]
      summary: Информация о программе лояльности
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Программа лояльности
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                      earn_rate:
                        type: number
                        description: Процент начисления бонусов
                      max_spend_percent:
                        type: integer
                        description: Макс. процент оплаты бонусами
                      levels:
                        type: array
                        items:
                          $ref: '#/components/schemas/LoyaltyLevel'

  /loyalty/balance/{customerId}:
    get:
      tags: [Loyalty]
      summary: Баланс бонусов клиента
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Баланс
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      customer_id:
                        type: integer
                      balance:
                        type: integer
                      total_spent:
                        type: string
                      level:
                        $ref: '#/components/schemas/LoyaltyLevel'
                      next_level:
                        type: object
                        nullable: true
                        properties:
                          next_level_name:
                            type: string
                          remaining:
                            type: string
                          progress_percent:
                            type: number

  /loyalty/transactions/{customerId}:
    get:
      tags: [Loyalty]
      summary: История транзакций
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: integer
        - name: type
          in: query
          schema:
            type: string
            enum: [earn, spend, expire, manual, birthday, promo]
        - name: since
          in: query
          schema:
            type: string
            format: date
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Транзакции
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      transactions:
                        type: array
                        items:
                          $ref: '#/components/schemas/BonusTransaction'

  /loyalty/calculate-earning:
    post:
      tags: [Loyalty]
      summary: Расчёт начисления бонусов
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [order_total]
              properties:
                order_total:
                  type: number
                customer_id:
                  type: integer
      responses:
        '200':
          description: Расчёт
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      bonus_to_earn:
                        type: integer
                      earn_rate:
                        type: number

  /loyalty/calculate-spending:
    post:
      tags: [Loyalty]
      summary: Расчёт списания бонусов
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [order_total, customer_id]
              properties:
                order_total:
                  type: number
                customer_id:
                  type: integer
      responses:
        '200':
          description: Расчёт
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      customer_balance:
                        type: integer
                      max_spend:
                        type: integer
                      max_spend_percent:
                        type: integer

  /loyalty/earn:
    post:
      tags: [Loyalty]
      summary: Начислить бонусы
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [customer_id, amount]
              properties:
                customer_id:
                  type: integer
                amount:
                  type: integer
                  minimum: 1
                order_id:
                  type: integer
                type:
                  type: string
                  enum: [earn, promo, birthday, referral, registration, manual]
                description:
                  type: string
      responses:
        '200':
          description: Бонусы начислены

  /loyalty/spend:
    post:
      tags: [Loyalty]
      summary: Списать бонусы
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [customer_id, amount]
              properties:
                customer_id:
                  type: integer
                amount:
                  type: integer
                  minimum: 1
                order_id:
                  type: integer
                description:
                  type: string
      responses:
        '200':
          description: Бонусы списаны
        '422':
          description: Недостаточно бонусов

  # ==================== KITCHEN ====================
  /kitchen/stations:
    get:
      tags: [Kitchen]
      summary: Список станций кухни
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Станции
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        name:
                          type: string
                        slug:
                          type: string
                        color:
                          type: string
                        is_bar:
                          type: boolean

  /kitchen/queue:
    get:
      tags: [Kitchen]
      summary: Очередь заказов на кухне
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: station
          in: query
          schema:
            type: string
          description: Фильтр по станции
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, sent, cooking, ready]
      responses:
        '200':
          description: Очередь
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/KitchenOrder'

  /kitchen/items/{itemId}/start:
    post:
      tags: [Kitchen]
      summary: Начать готовку позиции
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: itemId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Готовка начата

  /kitchen/items/{itemId}/ready:
    post:
      tags: [Kitchen]
      summary: Позиция готова
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: itemId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Статус обновлён

  /kitchen/items/{itemId}/served:
    post:
      tags: [Kitchen]
      summary: Позиция подана
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: itemId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Статус обновлён

  /kitchen/items/bulk-status:
    post:
      tags: [Kitchen]
      summary: Массовое обновление статусов
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [item_ids, status]
              properties:
                item_ids:
                  type: array
                  items:
                    type: integer
                  maxItems: 50
                status:
                  type: string
                  enum: [cooking, ready, served]
      responses:
        '200':
          description: Статусы обновлены

  /kitchen/stats:
    get:
      tags: [Kitchen]
      summary: Статистика кухни
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: station
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Статистика
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      queue:
                        type: object
                        properties:
                          pending:
                            type: integer
                          cooking:
                            type: integer
                          ready:
                            type: integer
                      today:
                        type: object
                        properties:
                          completed:
                            type: integer
                          avg_cooking_time_minutes:
                            type: number

  # ==================== PAYMENTS ====================
  /payments/methods:
    get:
      tags: [Payments]
      summary: Доступные способы оплаты
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Способы оплаты
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      methods:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            name:
                              type: string
                            icon:
                              type: string

  /payments/calculate:
    post:
      tags: [Payments]
      summary: Расчёт оплаты
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [order_id]
              properties:
                order_id:
                  type: integer
                bonus_use:
                  type: integer
                promo_code:
                  type: string
      responses:
        '200':
          description: Расчёт

  /payments/pay:
    post:
      tags: [Payments]
      summary: Провести оплату
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [order_id, method]
              properties:
                order_id:
                  type: integer
                method:
                  type: string
                  enum: [cash, card, online, mixed]
                amount:
                  type: number
                cash_amount:
                  type: number
                card_amount:
                  type: number
                bonus_use:
                  type: integer
      responses:
        '200':
          description: Оплата проведена

  /payments/status/{orderId}:
    get:
      tags: [Payments]
      summary: Статус оплаты
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Статус

  /payments/refund:
    post:
      tags: [Payments]
      summary: Оформить возврат
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [order_id, amount, reason]
              properties:
                order_id:
                  type: integer
                amount:
                  type: number
                reason:
                  type: string
                refund_method:
                  type: string
                  enum: [cash, card, original]
      responses:
        '200':
          description: Возврат оформлен

  # ==================== BATCH ====================
  /batch:
    post:
      tags: [Batch]
      summary: Пакетное выполнение операций
      description: |
        Выполнить до 25 операций в одном запросе.

        С `atomic: true` все операции выполняются в транзакции —
        при ошибке любой операции все изменения откатываются.
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [operations]
              properties:
                operations:
                  type: array
                  maxItems: 25
                  items:
                    type: object
                    required: [method, path]
                    properties:
                      method:
                        type: string
                        enum: [GET, POST, PATCH, PUT, DELETE]
                      path:
                        type: string
                        example: "/menu/dishes/123"
                      body:
                        type: object
                      id:
                        type: string
                        description: Идентификатор для результата
                atomic:
                  type: boolean
                  default: false
                  description: Выполнить в транзакции
            example:
              operations:
                - method: GET
                  path: "/menu/dishes/1"
                  id: dish1
                - method: PATCH
                  path: "/orders/5"
                  body:
                    status: confirmed
                  id: order1
              atomic: false
      responses:
        '200':
          description: Результаты операций

  /batch/stop-list:
    post:
      tags: [Batch]
      summary: Массовое обновление стоп-листа
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [items]
              properties:
                items:
                  type: array
                  maxItems: 100
                  items:
                    type: object
                    required: [dish_id, is_available]
                    properties:
                      dish_id:
                        type: integer
                      is_available:
                        type: boolean
                      reason:
                        type: string
            example:
              items:
                - dish_id: 1
                  is_available: false
                  reason: "Закончился ингредиент"
                - dish_id: 2
                  is_available: true
      responses:
        '200':
          description: Стоп-лист обновлён

  /batch/confirm-orders:
    post:
      tags: [Batch]
      summary: Массовое подтверждение заказов
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [order_ids]
              properties:
                order_ids:
                  type: array
                  maxItems: 50
                  items:
                    type: integer
                estimated_time:
                  type: integer
                  description: Время готовности в минутах
      responses:
        '200':
          description: Заказы подтверждены

  # ==================== WEBHOOKS ====================
  /webhooks:
    get:
      tags: [Webhooks]
      summary: Текущая конфигурация вебхуков
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Конфигурация
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      url:
                        type: string
                      secret:
                        type: string
                        description: Последние 4 символа
                      events:
                        type: array
                        items:
                          type: string
                      is_configured:
                        type: boolean

    put:
      tags: [Webhooks]
      summary: Обновить конфигурацию
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                events:
                  type: array
                  items:
                    type: string
                regenerate_secret:
                  type: boolean
      responses:
        '200':
          description: Конфигурация обновлена

  /webhooks/test:
    post:
      tags: [Webhooks]
      summary: Тестовый вебхук
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Результат теста

  /webhooks/events:
    get:
      tags: [Webhooks]
      summary: Доступные события
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: События
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        event:
                          type: string
                        description:
                          type: string

  /webhooks/deliveries:
    get:
      tags: [Webhooks]
      summary: История доставок вебхуков
      description: Для восстановления пропущенных событий
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, delivered, failed, expired]
        - name: event_type
          in: query
          schema:
            type: string
        - name: since
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: История доставок

  /webhooks/deliveries/{eventId}/retry:
    post:
      tags: [Webhooks]
      summary: Повторить доставку
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: eventId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Результат повторной доставки

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: Bearer token (Authorization header)
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API Key + X-API-Secret header

  parameters:
    IdempotencyKey:
      name: X-Idempotency-Key
      in: header
      schema:
        type: string
      description: Ключ идемпотентности (UUID)

    PageParam:
      name: page
      in: query
      schema:
        type: integer
        default: 1
      description: Номер страницы

    PerPageParam:
      name: per_page
      in: query
      schema:
        type: integer
        default: 20
        maximum: 100
      description: Элементов на странице

    IncludeParam:
      name: include
      in: query
      schema:
        type: string
      description: Связанные ресурсы через запятую

  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
        message:
          type: string

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            errors:
              type: object

    Pagination:
      type: object
      properties:
        total:
          type: integer
        per_page:
          type: integer
        current_page:
          type: integer
        last_page:
          type: integer

    TokenResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            access_token:
              type: string
            token_type:
              type: string
              example: Bearer
            expires_in:
              type: integer
            refresh_token:
              type: string

    Category:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        image_url:
          type: string
        sort_order:
          type: integer
        is_active:
          type: boolean
        dishes_count:
          type: integer

    Dish:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        price:
          type: string
          example: "350.00"
        image_url:
          type: string
        category_id:
          type: integer
        is_available:
          type: boolean
        weight:
          type: string
        calories:
          type: integer
        cooking_time:
          type: integer
          description: Время готовки в минутах
        modifiers:
          type: array
          items:
            $ref: '#/components/schemas/Modifier'

    Modifier:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        price:
          type: string
        is_required:
          type: boolean
        max_quantity:
          type: integer

    Order:
      type: object
      properties:
        id:
          type: integer
        order_number:
          type: string
        type:
          type: string
          enum: [dine_in, delivery, pickup]
        status:
          type: string
          enum: [new, confirmed, cooking, ready, delivering, completed, cancelled]
        payment_status:
          type: string
          enum: [pending, paid, partial, refunded]
        subtotal:
          type: string
        discount_amount:
          type: string
        delivery_fee:
          type: string
        total:
          type: string
        customer:
          $ref: '#/components/schemas/Customer'
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        comment:
          type: string
        created_at:
          type: string
          format: date-time
        confirmed_at:
          type: string
          format: date-time

    OrderItem:
      type: object
      properties:
        id:
          type: integer
        dish_id:
          type: integer
        name:
          type: string
        quantity:
          type: integer
        price:
          type: string
        total:
          type: string
        status:
          type: string
          enum: [new, sent, cooking, ready, served, cancelled]
        modifiers:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              price:
                type: string
        comment:
          type: string

    CreateOrderRequest:
      type: object
      required: [type, items]
      properties:
        type:
          type: string
          enum: [dine_in, delivery, pickup]
        customer_id:
          type: integer
        table_id:
          type: integer
          description: Для dine_in
        items:
          type: array
          minItems: 1
          items:
            type: object
            required: [dish_id, quantity]
            properties:
              dish_id:
                type: integer
              quantity:
                type: integer
                minimum: 1
              modifiers:
                type: array
                items:
                  type: object
                  properties:
                    modifier_id:
                      type: integer
                    quantity:
                      type: integer
              comment:
                type: string
        delivery_address:
          type: string
          description: Для delivery
        scheduled_at:
          type: string
          format: date-time
          description: Предзаказ на время
        comment:
          type: string

    Customer:
      type: object
      properties:
        id:
          type: integer
        phone:
          type: string
        name:
          type: string
        email:
          type: string
        birthday:
          type: string
          format: date
        bonus_balance:
          type: integer
        total_orders:
          type: integer
        total_spent:
          type: string
        loyalty_level:
          $ref: '#/components/schemas/LoyaltyLevel'
        created_at:
          type: string
          format: date-time

    LoyaltyLevel:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        icon:
          type: string
        color:
          type: string
        min_total_spent:
          type: string
        discount_percent:
          type: number
        cashback_percent:
          type: number
        bonus_multiplier:
          type: number

    BonusTransaction:
      type: object
      properties:
        id:
          type: integer
        type:
          type: string
          enum: [earn, spend, expire, manual, birthday, promo]
        type_label:
          type: string
        amount:
          type: integer
        balance_after:
          type: integer
        description:
          type: string
        order_id:
          type: integer
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time

    KitchenOrder:
      type: object
      properties:
        order_id:
          type: integer
        order_number:
          type: string
        status:
          type: string
        table:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        waiter:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        created_at:
          type: string
          format: date-time
        elapsed_minutes:
          type: integer
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              name:
                type: string
              quantity:
                type: integer
              status:
                type: string
              station:
                type: string
              modifiers_text:
                type: string
              comment:
                type: string

  responses:
    Unauthorized:
      description: Требуется аутентификация
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: UNAUTHORIZED
              message: Authentication required

    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: NOT_FOUND
              message: Resource not found

    ValidationError:
      description: Ошибка валидации
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: VALIDATION_ERROR
              message: Validation failed
              errors:
                field_name:
                  - Error message

    RateLimitExceeded:
      description: Превышен лимит запросов
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Remaining:
          schema:
            type: integer
        X-RateLimit-Reset:
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: RATE_LIMIT_EXCEEDED
              message: Too many requests
