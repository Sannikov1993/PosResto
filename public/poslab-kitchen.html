<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç≥ –ö—É—Ö–Ω—è ‚Äî PosLab</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-gray-800 px-6 py-4 flex items-center justify-between sticky top-0 z-50 shadow-lg">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold">üç≥ –ö—É—Ö–Ω—è</h1>
                <span class="text-gray-400">PosLab</span>
            </div>
            <div class="flex items-center gap-6">
                <!-- Stats -->
                <div class="flex gap-4">
                    <div class="bg-blue-500/20 px-4 py-2 rounded-xl flex items-center gap-2">
                        <span class="text-2xl">üì•</span>
                        <div>
                            <p class="text-xs text-blue-300">–ù–æ–≤—ã–µ</p>
                            <p class="text-2xl font-bold text-blue-400">{{ newOrders.length }}</p>
                        </div>
                    </div>
                    <div class="bg-orange-500/20 px-4 py-2 rounded-xl flex items-center gap-2">
                        <span class="text-2xl">üî•</span>
                        <div>
                            <p class="text-xs text-orange-300">–í —Ä–∞–±–æ—Ç–µ</p>
                            <p class="text-2xl font-bold text-orange-400">{{ cookingOrders.length }}</p>
                        </div>
                    </div>
                    <div class="bg-green-500/20 px-4 py-2 rounded-xl flex items-center gap-2">
                        <span class="text-2xl">‚úÖ</span>
                        <div>
                            <p class="text-xs text-green-300">–ì–æ—Ç–æ–≤–æ</p>
                            <p class="text-2xl font-bold text-green-400">{{ readyOrders.length }}</p>
                        </div>
                    </div>
                </div>
                <!-- Time -->
                <div class="text-right">
                    <p class="text-3xl font-bold">{{ currentTime }}</p>
                    <p class="text-sm text-gray-400">{{ currentDate }}</p>
                </div>
                <!-- Sound toggle -->
                <button @click="soundEnabled = !soundEnabled" 
                        :class="['p-3 rounded-xl text-2xl transition', soundEnabled ? 'bg-green-500/20 text-green-400' : 'bg-gray-700 text-gray-500']">
                    {{ soundEnabled ? 'üîî' : 'üîï' }}
                </button>
                <!-- Fullscreen -->
                <button @click="toggleFullscreen" class="p-3 rounded-xl bg-gray-700 text-2xl hover:bg-gray-600 transition">
                    ‚õ∂
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-6">
            <!-- Three Columns -->
            <div class="grid grid-cols-3 gap-6 h-[calc(100vh-120px)]">
                
                <!-- NEW Orders -->
                <div class="flex flex-col">
                    <div class="bg-blue-500 text-white px-4 py-3 rounded-t-2xl font-bold text-xl flex items-center justify-between">
                        <span>üì• –ù–û–í–´–ï</span>
                        <span class="bg-white text-blue-500 px-3 py-1 rounded-full text-lg">{{ newOrders.length }}</span>
                    </div>
                    <div class="bg-gray-800 rounded-b-2xl flex-1 overflow-y-auto p-4 space-y-4">
                        <div v-for="order in newOrders" :key="order.id" 
                             :class="['bg-blue-500/10 border-2 border-blue-500 rounded-2xl p-4 slide-in', order.isNew ? 'shake' : '']">
                            <!-- Order Header -->
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-4xl font-extrabold text-blue-400">#{{ order.order_number }}</p>
                                    <p class="text-lg text-gray-400 mt-1">
                                        {{ getTypeIcon(order.type) }} 
                                        <span v-if="order.table">–°—Ç–æ–ª {{ order.table.number }}</span>
                                        <span v-else>{{ getTypeLabel(order.type) }}</span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">–ü–æ—Å—Ç—É–ø–∏–ª</p>
                                    <p class="text-xl font-bold">{{ formatTime(order.created_at) }}</p>
                                    <p class="text-orange-400 font-bold mt-1">{{ getWaitTime(order.created_at) }}</p>
                                </div>
                            </div>
                            
                            <!-- Items -->
                            <div class="space-y-2 mb-4">
                                <div v-for="item in order.items" :key="item.id" 
                                     class="bg-gray-800 rounded-xl p-3 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="bg-blue-500 text-white w-10 h-10 rounded-lg flex items-center justify-center text-xl font-bold">
                                            {{ item.quantity }}
                                        </span>
                                        <div>
                                            <p class="font-bold text-lg">{{ item.name }}</p>
                                            <p v-if="item.notes" class="text-sm text-yellow-400">üìù {{ item.notes }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div v-if="order.notes" class="bg-yellow-500/20 rounded-xl p-3 mb-4">
                                <p class="text-yellow-400 font-medium">üìù {{ order.notes }}</p>
                            </div>
                            
                            <!-- Action Button -->
                            <button @click="startCooking(order)" 
                                    class="w-full py-4 bg-blue-500 hover:bg-blue-600 rounded-xl text-xl font-bold transition flex items-center justify-center gap-2">
                                üë®‚Äçüç≥ –í–ó–Ø–¢–¨ –í –†–ê–ë–û–¢–£
                            </button>
                        </div>
                        
                        <div v-if="newOrders.length === 0" class="flex flex-col items-center justify-center h-full text-gray-600">
                            <p class="text-6xl mb-4">üì≠</p>
                            <p class="text-xl">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                        </div>
                    </div>
                </div>

                <!-- COOKING Orders -->
                <div class="flex flex-col">
                    <div class="bg-orange-500 text-white px-4 py-3 rounded-t-2xl font-bold text-xl flex items-center justify-between">
                        <span>üî• –ì–û–¢–û–í–Ø–¢–°–Ø</span>
                        <span class="bg-white text-orange-500 px-3 py-1 rounded-full text-lg">{{ cookingOrders.length }}</span>
                    </div>
                    <div class="bg-gray-800 rounded-b-2xl flex-1 overflow-y-auto p-4 space-y-4">
                        <div v-for="order in cookingOrders" :key="order.id" 
                             :class="['border-2 rounded-2xl p-4', getCookingUrgency(order)]">
                            <!-- Order Header -->
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-4xl font-extrabold text-orange-400">#{{ order.order_number }}</p>
                                    <p class="text-lg text-gray-400 mt-1">
                                        {{ getTypeIcon(order.type) }} 
                                        <span v-if="order.table">–°—Ç–æ–ª {{ order.table.number }}</span>
                                        <span v-else>{{ getTypeLabel(order.type) }}</span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">–í —Ä–∞–±–æ—Ç–µ</p>
                                    <p :class="['text-2xl font-bold', getCookingTimeColor(order)]">
                                        {{ getCookingTime(order) }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Items with checkboxes -->
                            <div class="space-y-2 mb-4">
                                <div v-for="item in order.items" :key="item.id" 
                                     @click="toggleItemDone(order, item)"
                                     :class="['rounded-xl p-3 flex items-center gap-3 cursor-pointer transition', 
                                              item.done ? 'bg-green-500/20 line-through opacity-50' : 'bg-gray-700']">
                                    <div :class="['w-8 h-8 rounded-lg flex items-center justify-center text-lg font-bold border-2',
                                                  item.done ? 'bg-green-500 border-green-500 text-white' : 'border-orange-500 text-orange-500']">
                                        {{ item.done ? '‚úì' : item.quantity }}
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-lg">{{ item.name }}</p>
                                        <p v-if="item.notes" class="text-sm text-yellow-400">üìù {{ item.notes }}</p>
                                    </div>
                                    <span v-if="!item.done" class="text-2xl">üëÜ</span>
                                </div>
                            </div>
                            
                            <!-- Progress -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-400 mb-1">
                                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                    <span>{{ getOrderProgress(order) }}%</span>
                                </div>
                                <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-orange-500 transition-all duration-300" 
                                         :style="{ width: getOrderProgress(order) + '%' }"></div>
                                </div>
                            </div>
                            
                            <!-- Action Button -->
                            <button @click="markReady(order)" 
                                    :disabled="getOrderProgress(order) < 100"
                                    :class="['w-full py-4 rounded-xl text-xl font-bold transition flex items-center justify-center gap-2',
                                             getOrderProgress(order) >= 100 
                                                ? 'bg-green-500 hover:bg-green-600 text-white' 
                                                : 'bg-gray-700 text-gray-500 cursor-not-allowed']">
                                ‚úÖ –ì–û–¢–û–í–û
                            </button>
                        </div>
                        
                        <div v-if="cookingOrders.length === 0" class="flex flex-col items-center justify-center h-full text-gray-600">
                            <p class="text-6xl mb-4">üë®‚Äçüç≥</p>
                            <p class="text-xl">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ</p>
                        </div>
                    </div>
                </div>

                <!-- READY Orders -->
                <div class="flex flex-col">
                    <div class="bg-green-500 text-white px-4 py-3 rounded-t-2xl font-bold text-xl flex items-center justify-between">
                        <span>‚úÖ –ì–û–¢–û–í–´</span>
                        <span class="bg-white text-green-500 px-3 py-1 rounded-full text-lg">{{ readyOrders.length }}</span>
                    </div>
                    <div class="bg-gray-800 rounded-b-2xl flex-1 overflow-y-auto p-4 space-y-4">
                        <div v-for="order in readyOrders" :key="order.id" 
                             class="bg-green-500/10 border-2 border-green-500 rounded-2xl p-4 pulse">
                            <!-- Order Header -->
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-4xl font-extrabold text-green-400">#{{ order.order_number }}</p>
                                    <p class="text-lg text-gray-400 mt-1">
                                        {{ getTypeIcon(order.type) }} 
                                        <span v-if="order.table">–°—Ç–æ–ª {{ order.table.number }}</span>
                                        <span v-else>{{ getTypeLabel(order.type) }}</span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">–ì–æ—Ç–æ–≤</p>
                                    <p class="text-xl font-bold text-green-400">{{ getWaitTime(order.ready_at) }}</p>
                                </div>
                            </div>
                            
                            <!-- Items Summary -->
                            <div class="bg-gray-800 rounded-xl p-4 mb-4">
                                <div v-for="item in order.items" :key="item.id" class="flex items-center gap-2 py-1">
                                    <span class="text-green-400 font-bold">{{ item.quantity }}√ó</span>
                                    <span>{{ item.name }}</span>
                                </div>
                            </div>
                            
                            <!-- Status -->
                            <div class="bg-green-500 text-white rounded-xl py-4 text-center">
                                <p class="text-2xl font-bold">üîî –û–ñ–ò–î–ê–ï–¢ –í–´–î–ê–ß–ò</p>
                            </div>
                        </div>
                        
                        <div v-if="readyOrders.length === 0" class="flex flex-col items-center justify-center h-full text-gray-600">
                            <p class="text-6xl mb-4">‚ú®</p>
                            <p class="text-xl">–ù–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- New Order Alert -->
        <div v-if="showNewOrderAlert" 
             class="fixed inset-0 bg-blue-500/90 flex items-center justify-center z-50"
             @click="dismissAlert">
            <div class="text-center text-white">
                <p class="text-9xl mb-8">üì•</p>
                <p class="text-6xl font-bold mb-4">–ù–û–í–´–ô –ó–ê–ö–ê–ó!</p>
                <p class="text-4xl font-bold">#{{ newOrderNumber }}</p>
                <p class="text-2xl mt-8 opacity-75">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å</p>
            </div>
        </div>

        <!-- Audio element for notifications -->
        <audio ref="notificationSound" preload="auto">
            <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2JkZuTi4OAfoKGi5GWm5mVkIqFgX58fn6ChYmNkZWYmZmXlZKOioaCf31+f4GFiY2RlZiZmpmXlZKOioaCf318foGFiY2RlZiampmXlZKOioaCf318fn+ChYmNkZWYmZqZl5WSjoqGgn99fH5/goWJjZGVmJmamZeVko6KhoJ/fXx+f4KFiY2RlZiZmpmXlZKOioaCf318fn+ChYmNkZWYmZqZl5WSjoqGgn99fH5/goWJjQ==" type="audio/wav">
        </audio>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                const API_URL = 'http://127.0.0.1:8000/api';
                
                // State
                const orders = ref([]);
                const currentTime = ref('');
                const currentDate = ref('');
                const soundEnabled = ref(true);
                const showNewOrderAlert = ref(false);
                const newOrderNumber = ref('');
                const notificationSound = ref(null);
                const lastOrderIds = ref(new Set());
                const itemDoneState = ref({}); // Track which items are marked done

                // Computed
                const newOrders = computed(() => orders.value.filter(o => o.status === 'new'));
                const cookingOrders = computed(() => orders.value.filter(o => o.status === 'cooking').map(o => ({
                    ...o,
                    items: o.items.map(item => ({
                        ...item,
                        done: itemDoneState.value[`${o.id}-${item.id}`] || false
                    }))
                })));
                const readyOrders = computed(() => orders.value.filter(o => o.status === 'ready'));

                // Time update
                const updateTime = () => {
                    const now = new Date();
                    currentTime.value = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    currentDate.value = now.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
                };

                // Helpers
                const formatTime = (dateStr) => {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                };

                const getWaitTime = (dateStr) => {
                    if (!dateStr) return '';
                    const diff = Math.floor((new Date() - new Date(dateStr)) / 60000);
                    if (diff < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                    if (diff < 60) return `${diff} –º–∏–Ω`;
                    return `${Math.floor(diff / 60)} —á ${diff % 60} –º–∏–Ω`;
                };

                const getCookingTime = (order) => {
                    const startTime = order.cooking_started_at || order.updated_at;
                    if (!startTime) return '0:00';
                    const diff = Math.floor((new Date() - new Date(startTime)) / 1000);
                    const mins = Math.floor(diff / 60);
                    const secs = diff % 60;
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                const getCookingTimeColor = (order) => {
                    const startTime = order.cooking_started_at || order.updated_at;
                    if (!startTime) return 'text-white';
                    const diff = Math.floor((new Date() - new Date(startTime)) / 60000);
                    if (diff < 10) return 'text-green-400';
                    if (diff < 20) return 'text-yellow-400';
                    return 'text-red-400';
                };

                const getCookingUrgency = (order) => {
                    const startTime = order.cooking_started_at || order.updated_at;
                    if (!startTime) return 'bg-orange-500/10 border-orange-500';
                    const diff = Math.floor((new Date() - new Date(startTime)) / 60000);
                    if (diff < 10) return 'bg-orange-500/10 border-orange-500';
                    if (diff < 20) return 'bg-yellow-500/10 border-yellow-500';
                    return 'bg-red-500/10 border-red-500 pulse';
                };

                const getTypeIcon = (type) => ({ dine_in: 'üçΩÔ∏è', delivery: 'üõµ', pickup: 'üèÉ' }[type] || 'üìã');
                const getTypeLabel = (type) => ({ dine_in: '–í –∑–∞–ª–µ', delivery: '–î–æ—Å—Ç–∞–≤–∫–∞', pickup: '–°–∞–º–æ–≤—ã–≤–æ–∑' }[type] || type);

                const getOrderProgress = (order) => {
                    if (!order.items || order.items.length === 0) return 0;
                    const done = order.items.filter(i => i.done).length;
                    return Math.round((done / order.items.length) * 100);
                };

                // Actions
                const toggleItemDone = (order, item) => {
                    const key = `${order.id}-${item.id}`;
                    itemDoneState.value[key] = !itemDoneState.value[key];
                };

                const startCooking = async (order) => {
                    try {
                        const res = await fetch(`${API_URL}/orders/${order.id}/status`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'cooking' })
                        });
                        if ((await res.json()).success) {
                            fetchOrders();
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const markReady = async (order) => {
                    try {
                        const res = await fetch(`${API_URL}/orders/${order.id}/status`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'ready' })
                        });
                        if ((await res.json()).success) {
                            // Clear done states for this order
                            Object.keys(itemDoneState.value).forEach(key => {
                                if (key.startsWith(`${order.id}-`)) {
                                    delete itemDoneState.value[key];
                                }
                            });
                            fetchOrders();
                            playNotification();
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const fetchOrders = async () => {
                    try {
                        const res = await fetch(`${API_URL}/orders?today=true`);
                        const data = await res.json();
                        if (data.success) {
                            const activeStatuses = ['new', 'cooking', 'ready'];
                            const newData = data.data.filter(o => activeStatuses.includes(o.status));
                            
                            // Check for new orders
                            const currentIds = new Set(newData.filter(o => o.status === 'new').map(o => o.id));
                            currentIds.forEach(id => {
                                if (!lastOrderIds.value.has(id)) {
                                    // New order detected!
                                    const newOrder = newData.find(o => o.id === id);
                                    if (newOrder) {
                                        newOrderNumber.value = newOrder.order_number;
                                        showNewOrderAlert.value = true;
                                        playNotification();
                                        setTimeout(() => showNewOrderAlert.value = false, 5000);
                                    }
                                }
                            });
                            lastOrderIds.value = currentIds;
                            
                            orders.value = newData;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const playNotification = () => {
                    if (soundEnabled.value && notificationSound.value) {
                        notificationSound.value.currentTime = 0;
                        notificationSound.value.play().catch(() => {});
                    }
                };

                const dismissAlert = () => {
                    showNewOrderAlert.value = false;
                };

                const toggleFullscreen = () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                };

                // Lifecycle
                let timeInterval, fetchInterval, cookingTimeInterval;
                
                onMounted(() => {
                    updateTime();
                    fetchOrders();
                    
                    timeInterval = setInterval(updateTime, 1000);
                    fetchInterval = setInterval(fetchOrders, 5000); // Poll every 5 seconds
                    cookingTimeInterval = setInterval(() => {
                        // Force re-render for cooking times
                        orders.value = [...orders.value];
                    }, 1000);
                });

                onUnmounted(() => {
                    clearInterval(timeInterval);
                    clearInterval(fetchInterval);
                    clearInterval(cookingTimeInterval);
                });

                return {
                    orders,
                    newOrders,
                    cookingOrders,
                    readyOrders,
                    currentTime,
                    currentDate,
                    soundEnabled,
                    showNewOrderAlert,
                    newOrderNumber,
                    notificationSound,
                    formatTime,
                    getWaitTime,
                    getCookingTime,
                    getCookingTimeColor,
                    getCookingUrgency,
                    getTypeIcon,
                    getTypeLabel,
                    getOrderProgress,
                    toggleItemDone,
                    startCooking,
                    markReady,
                    dismissAlert,
                    toggleFullscreen,
                    playNotification
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
