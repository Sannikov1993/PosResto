<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßæ –°–∫–ª–∞–¥ ‚Äî PosLab</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-800">üßæ –°–∫–ª–∞–¥ –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h1>
                <a href="/poslab-crm.html" class="text-gray-500 hover:text-orange-500 text-sm">‚Üê –ù–∞–∑–∞–¥ –≤ CRM</a>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex gap-3">
                    <div class="bg-blue-100 px-4 py-2 rounded-xl">
                        <p class="text-xs text-blue-600">–ü–æ–∑–∏—Ü–∏–π</p>
                        <p class="text-xl font-bold text-blue-600">{{ stats.summary?.total_items || 0 }}</p>
                    </div>
                    <div class="bg-green-100 px-4 py-2 rounded-xl">
                        <p class="text-xs text-green-600">–°—Ç–æ–∏–º–æ—Å—Ç—å</p>
                        <p class="text-xl font-bold text-green-600">{{ formatMoney(stats.summary?.total_value) }}</p>
                    </div>
                    <div v-if="stats.summary?.low_stock_count > 0" class="bg-red-100 px-4 py-2 rounded-xl cursor-pointer" @click="showLowStock">
                        <p class="text-xs text-red-600">‚ö†Ô∏è –ú–∞–ª–æ</p>
                        <p class="text-xl font-bold text-red-600">{{ stats.summary?.low_stock_count }}</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="bg-white border-b px-6">
            <div class="flex gap-1">
                <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                        :class="['px-6 py-3 font-medium border-b-2 transition', currentTab === tab.id ? 'border-orange-500 text-orange-500' : 'border-transparent text-gray-500 hover:text-gray-700']">
                    {{ tab.icon }} {{ tab.name }}
                </button>
            </div>
        </div>

        <main class="p-6">
            <!-- TAB: –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã -->
            <div v-if="currentTab === 'ingredients'" class="fade-in">
                <div class="flex justify-between mb-4">
                    <div class="flex gap-2">
                        <button @click="filterCategory = null" 
                                :class="['px-4 py-2 rounded-lg text-sm font-medium', !filterCategory ? 'bg-orange-500 text-white' : 'bg-white hover:bg-gray-50']">
                            –í—Å–µ
                        </button>
                        <button v-for="cat in categories" :key="cat.id" @click="filterCategory = cat.id"
                                :class="['px-4 py-2 rounded-lg text-sm font-medium', filterCategory === cat.id ? 'bg-orange-500 text-white' : 'bg-white hover:bg-gray-50']">
                            {{ cat.icon }} {{ cat.name }}
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="searchQuery" type="text" placeholder="üîç –ü–æ–∏—Å–∫..." class="border rounded-lg px-3 py-2 w-64">
                        <button @click="openIngredientModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-600">
                            + –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-4 py-3 font-medium text-gray-600">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th class="text-left px-4 py-3 font-medium text-gray-600">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th class="text-right px-4 py-3 font-medium text-gray-600">–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th class="text-right px-4 py-3 font-medium text-gray-600">–ú–∏–Ω.</th>
                                <th class="text-right px-4 py-3 font-medium text-gray-600">–¶–µ–Ω–∞</th>
                                <th class="text-right px-4 py-3 font-medium text-gray-600">–°—É–º–º–∞</th>
                                <th class="text-center px-4 py-3 font-medium text-gray-600">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in filteredIngredients" :key="item.id" 
                                :class="['border-t hover:bg-gray-50', item.status === 'low_stock' ? 'bg-yellow-50' : '', item.status === 'out_of_stock' ? 'bg-red-50' : '']">
                                <td class="px-4 py-3">
                                    <p class="font-medium">{{ item.name }}</p>
                                    <p v-if="item.sku" class="text-xs text-gray-400">{{ item.sku }}</p>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-600">
                                    {{ item.category?.icon }} {{ item.category?.name || '-' }}
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span :class="['font-bold', item.status === 'low_stock' ? 'text-yellow-600' : '', item.status === 'out_of_stock' ? 'text-red-600' : '']">
                                        {{ item.quantity }}
                                    </span>
                                    <span class="text-gray-500 text-sm ml-1">{{ item.unit_name }}</span>
                                </td>
                                <td class="px-4 py-3 text-right text-gray-500">{{ item.min_quantity }} {{ item.unit_name }}</td>
                                <td class="px-4 py-3 text-right">{{ formatMoney(item.cost_price) }}</td>
                                <td class="px-4 py-3 text-right font-medium">{{ formatMoney(item.stock_value) }}</td>
                                <td class="px-4 py-3 text-center">
                                    <button @click="openIncomeModal(item)" class="p-2 hover:bg-green-100 rounded text-green-600" title="–ü—Ä–∏—Ö–æ–¥">üì•</button>
                                    <button @click="openWriteOffModal(item)" class="p-2 hover:bg-red-100 rounded text-red-600" title="–°–ø–∏—Å–∞–Ω–∏–µ">üóëÔ∏è</button>
                                    <button @click="openIngredientModal(item)" class="p-2 hover:bg-gray-100 rounded" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                    <button @click="showMovements(item)" class="p-2 hover:bg-blue-100 rounded text-blue-600" title="–ò—Å—Ç–æ—Ä–∏—è">üìã</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="filteredIngredients.length === 0" class="p-8 text-center text-gray-400">
                        –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                    </div>
                </div>
            </div>

            <!-- TAB: –†–µ—Ü–µ–ø—Ç—ã -->
            <div v-if="currentTab === 'recipes'" class="fade-in">
                <div class="flex justify-between mb-4">
                    <h2 class="text-lg font-semibold">–¢–µ—Ö–∫–∞—Ä—Ç—ã –±–ª—é–¥</h2>
                    <button @click="openRecipeModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-600">
                        + –°–æ–∑–¥–∞—Ç—å —Ç–µ—Ö–∫–∞—Ä—Ç—É
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div v-for="recipe in recipes" :key="recipe.id" 
                         @click="openRecipeModal(recipe)"
                         class="bg-white rounded-xl p-4 shadow-sm cursor-pointer hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <p class="font-semibold">{{ recipe.dish?.name }}</p>
                                <p class="text-sm text-gray-500">{{ recipe.items?.length || 0 }} –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</p>
                            </div>
                            <span class="text-2xl">üìñ</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                            <span class="font-bold text-orange-500">{{ formatMoney(recipe.cost_per_portion) }}</span>
                        </div>
                        <div v-if="recipe.total_time" class="text-xs text-gray-400 mt-2">
                            ‚è±Ô∏è {{ recipe.total_time }} –º–∏–Ω.
                        </div>
                    </div>
                    <div v-if="recipes.length === 0" class="col-span-3 bg-white rounded-xl p-8 text-center text-gray-400">
                        <p class="text-4xl mb-2">üìñ</p>
                        <p>–ù–µ—Ç —Ç–µ—Ö–∫–∞—Ä—Ç</p>
                    </div>
                </div>
            </div>

            <!-- TAB: –î–≤–∏–∂–µ–Ω–∏–µ -->
            <div v-if="currentTab === 'movements'" class="fade-in">
                <div class="flex justify-between mb-4">
                    <div class="flex gap-2">
                        <select v-model="movementFilter" @change="loadMovements" class="border rounded-lg px-3 py-2">
                            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="income">üì• –ü—Ä–∏—Ö–æ–¥</option>
                            <option value="expense">üì§ –†–∞—Å—Ö–æ–¥</option>
                            <option value="write_off">üóëÔ∏è –°–ø–∏—Å–∞–Ω–∏–µ</option>
                            <option value="inventory">üìã –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</option>
                        </select>
                        <input type="date" v-model="movementDateFrom" @change="loadMovements" class="border rounded-lg px-3 py-2">
                        <span class="py-2">‚Äî</span>
                        <input type="date" v-model="movementDateTo" @change="loadMovements" class="border rounded-lg px-3 py-2">
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-4 py-3 font-medium text-gray-600">–î–∞—Ç–∞</th>
                                <th class="text-left px-4 py-3 font-medium text-gray-600">–¢–∏–ø</th>
                                <th class="text-left px-4 py-3 font-medium text-gray-600">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                                <th class="text-right px-4 py-3 font-medium text-gray-600">–ö–æ–ª-–≤–æ</th>
                                <th class="text-right px-4 py-3 font-medium text-gray-600">–°—É–º–º–∞</th>
                                <th class="text-left px-4 py-3 font-medium text-gray-600">–û—Å–Ω–æ–≤–∞–Ω–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="m in movements" :key="m.id" class="border-t hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm">{{ formatDateTime(m.created_at) }}</td>
                                <td class="px-4 py-3">
                                    <span :class="['px-2 py-1 rounded text-xs font-medium', getMovementBadge(m.type)]">
                                        {{ m.type_icon }} {{ m.type_label }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 font-medium">{{ m.ingredient?.name }}</td>
                                <td class="px-4 py-3 text-right">
                                    <span :class="[m.quantity > 0 ? 'text-green-600' : 'text-red-600']">
                                        {{ m.quantity > 0 ? '+' : '' }}{{ m.quantity }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right">{{ formatMoney(m.total_cost) }}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">
                                    {{ m.document_number || m.reason || '-' }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è -->
            <div v-if="currentTab === 'inventory'" class="fade-in">
                <div class="flex justify-between mb-4">
                    <h2 class="text-lg font-semibold">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</h2>
                    <button @click="createInventoryCheck" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-600">
                        + –ù–æ–≤–∞—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div v-for="check in inventoryChecks" :key="check.id" 
                         @click="openInventoryCheck(check)"
                         class="bg-white rounded-xl p-4 shadow-sm cursor-pointer hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <p class="font-semibold">{{ check.number }}</p>
                                <p class="text-sm text-gray-500">{{ formatDate(check.date) }}</p>
                            </div>
                            <span :class="['px-2 py-1 rounded text-xs font-medium', getInventoryStatusBadge(check.status)]">
                                {{ check.status_label }}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span>–ü–æ–∑–∏—Ü–∏–π: {{ check.items_count }}</span>
                            <span v-if="check.discrepancy_count > 0" class="text-red-500">
                                ‚ö†Ô∏è –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π: {{ check.discrepancy_count }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ -->
            <div v-if="currentTab === 'suppliers'" class="fade-in">
                <div class="flex justify-between mb-4">
                    <h2 class="text-lg font-semibold">–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</h2>
                    <button @click="openSupplierModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-600">
                        + –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div v-for="supplier in suppliers" :key="supplier.id" 
                         @click="openSupplierModal(supplier)"
                         class="bg-white rounded-xl p-4 shadow-sm cursor-pointer hover:shadow-md transition">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-xl">üè¢</div>
                            <div>
                                <p class="font-semibold">{{ supplier.name }}</p>
                                <p class="text-sm text-gray-500">{{ supplier.contact_person || '–ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω' }}</p>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            <p v-if="supplier.phone">üì± {{ supplier.phone }}</p>
                            <p v-if="supplier.email">‚úâÔ∏è {{ supplier.email }}</p>
                        </div>
                        <div class="mt-2 text-xs text-gray-400">
                            –¢–æ–≤–∞—Ä–æ–≤: {{ supplier.ingredients_count }}
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Ingredient Modal -->
        <div v-if="showIngredientModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl w-[550px] max-h-[90vh] overflow-y-auto fade-in">
                <div class="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white">
                    <h3 class="text-xl font-bold">{{ editingIngredient ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '‚ûï –ù–æ–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç' }}</h3>
                    <button @click="showIngredientModal = false" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input v-model="ingredientForm.name" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–æ–º–∞—Ç—ã —Å–≤–µ–∂–∏–µ">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select v-model="ingredientForm.category_id" class="w-full border rounded-lg px-3 py-2">
                                <option :value="null">‚Äî –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî</option>
                                <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.icon }} {{ cat.name }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è *</label>
                            <select v-model="ingredientForm.unit_id" class="w-full border rounded-lg px-3 py-2">
                                <option v-for="unit in units" :key="unit.id" :value="unit.id">{{ unit.name }} ({{ unit.short_name }})</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">–û—Å—Ç–∞—Ç–æ–∫</label>
                            <input v-model.number="ingredientForm.quantity" type="number" step="0.001" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input v-model.number="ingredientForm.min_quantity" type="number" step="0.001" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–¶–µ–Ω–∞ –∑–∞ –µ–¥.</label>
                            <input v-model.number="ingredientForm.cost_price" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">–ê—Ä—Ç–∏–∫—É–ª (SKU)</label>
                            <input v-model="ingredientForm.sku" type="text" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                            <select v-model="ingredientForm.supplier_id" class="w-full border rounded-lg px-3 py-2">
                                <option :value="null">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>
                                <option v-for="s in suppliers" :key="s.id" :value="s.id">{{ s.name }}</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">–ó–∞–º–µ—Ç–∫–∏</label>
                        <textarea v-model="ingredientForm.notes" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
                    </div>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" v-model="ingredientForm.track_stock" class="rounded">
                        <span class="text-sm">–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏</span>
                    </label>
                </div>
                <div class="px-6 py-4 border-t flex gap-3">
                    <button @click="showIngredientModal = false" class="flex-1 py-2 rounded-xl bg-gray-200">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="saveIngredient" class="flex-1 py-2 rounded-xl bg-orange-500 text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Income Modal -->
        <div v-if="showIncomeModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl w-[450px] fade-in">
                <div class="px-6 py-4 border-b bg-green-500 text-white rounded-t-2xl">
                    <h3 class="text-xl font-bold">üì• –ü—Ä–∏—Ö–æ–¥ —Ç–æ–≤–∞—Ä–∞</h3>
                    <p class="text-green-100">{{ selectedIngredient?.name }}</p>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                            <input v-model.number="incomeForm.quantity" type="number" step="0.001" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–¶–µ–Ω–∞ –∑–∞ –µ–¥.</label>
                            <input v-model.number="incomeForm.cost_price" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                        <select v-model="incomeForm.supplier_id" class="w-full border rounded-lg px-3 py-2">
                            <option :value="null">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>
                            <option v-for="s in suppliers" :key="s.id" :value="s.id">{{ s.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">‚Ññ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</label>
                        <input v-model="incomeForm.document_number" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–ù-12345">
                    </div>
                </div>
                <div class="px-6 py-4 border-t flex gap-3">
                    <button @click="showIncomeModal = false" class="flex-1 py-2 rounded-xl bg-gray-200">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="submitIncome" class="flex-1 py-2 rounded-xl bg-green-500 text-white">–û–ø—Ä–∏—Ö–æ–¥–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Write-off Modal -->
        <div v-if="showWriteOffModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl w-[450px] fade-in">
                <div class="px-6 py-4 border-b bg-red-500 text-white rounded-t-2xl">
                    <h3 class="text-xl font-bold">üóëÔ∏è –°–ø–∏—Å–∞–Ω–∏–µ</h3>
                    <p class="text-red-100">{{ selectedIngredient?.name }} (–æ—Å—Ç–∞—Ç–æ–∫: {{ selectedIngredient?.quantity }})</p>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                        <input v-model.number="writeOffForm.quantity" type="number" step="0.001" :max="selectedIngredient?.quantity" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">–ü—Ä–∏—á–∏–Ω–∞ *</label>
                        <select v-model="writeOffForm.reason" class="w-full border rounded-lg px-3 py-2">
                            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                            <option value="–ò—Å—Ç—ë–∫ —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏">–ò—Å—Ç—ë–∫ —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</option>
                            <option value="–ë—Ä–∞–∫">–ë—Ä–∞–∫</option>
                            <option value="–ü–æ—Ä—á–∞">–ü–æ—Ä—á–∞</option>
                            <option value="–ù–µ–¥–æ—Å—Ç–∞—á–∞">–ù–µ–¥–æ—Å—Ç–∞—á–∞</option>
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div v-if="writeOffForm.reason === '–î—Ä—É–≥–æ–µ'">
                        <label class="block text-sm font-medium mb-1">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</label>
                        <input v-model="writeOffForm.customReason" type="text" class="w-full border rounded-lg px-3 py-2">
                    </div>
                </div>
                <div class="px-6 py-4 border-t flex gap-3">
                    <button @click="showWriteOffModal = false" class="flex-1 py-2 rounded-xl bg-gray-200">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="submitWriteOff" class="flex-1 py-2 rounded-xl bg-red-500 text-white">–°–ø–∏—Å–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.show" :class="['fixed bottom-6 right-6 px-6 py-3 rounded-xl shadow-lg z-50 fade-in', toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white']">
            {{ toast.message }}
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const API_URL = 'http://127.0.0.1:8000/api';

                // State
                const ingredients = ref([]);
                const categories = ref([]);
                const units = ref([]);
                const suppliers = ref([]);
                const recipes = ref([]);
                const movements = ref([]);
                const inventoryChecks = ref([]);
                const stats = ref({});

                const currentTab = ref('ingredients');
                const filterCategory = ref(null);
                const searchQuery = ref('');
                const movementFilter = ref('');
                const movementDateFrom = ref(new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0]);
                const movementDateTo = ref(new Date().toISOString().split('T')[0]);

                const showIngredientModal = ref(false);
                const showIncomeModal = ref(false);
                const showWriteOffModal = ref(false);
                const editingIngredient = ref(null);
                const selectedIngredient = ref(null);

                const ingredientForm = ref({ name: '', category_id: null, unit_id: 1, quantity: 0, min_quantity: 0, cost_price: 0, sku: '', supplier_id: null, notes: '', track_stock: true });
                const incomeForm = ref({ quantity: 0, cost_price: null, supplier_id: null, document_number: '' });
                const writeOffForm = ref({ quantity: 0, reason: '', customReason: '' });

                const toast = ref({ show: false, message: '', type: 'success' });

                const tabs = [
                    { id: 'ingredients', name: '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', icon: 'üì¶' },
                    { id: 'recipes', name: '–¢–µ—Ö–∫–∞—Ä—Ç—ã', icon: 'üìñ' },
                    { id: 'movements', name: '–î–≤–∏–∂–µ–Ω–∏–µ', icon: 'üìä' },
                    { id: 'inventory', name: '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è', icon: 'üìã' },
                    { id: 'suppliers', name: '–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏', icon: 'üè¢' },
                ];

                // Computed
                const filteredIngredients = computed(() => {
                    let result = ingredients.value;
                    if (filterCategory.value) {
                        result = result.filter(i => i.category_id === filterCategory.value);
                    }
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        result = result.filter(i => i.name.toLowerCase().includes(q));
                    }
                    return result;
                });

                // Methods
                const showToast = (message, type = 'success') => {
                    toast.value = { show: true, message, type };
                    setTimeout(() => toast.value.show = false, 3000);
                };

                const formatMoney = (a) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0 }).format(a || 0);
                const formatDate = (d) => d ? new Date(d).toLocaleDateString('ru-RU') : '';
                const formatDateTime = (d) => d ? new Date(d).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';

                const getMovementBadge = (type) => ({
                    income: 'bg-green-100 text-green-600',
                    expense: 'bg-blue-100 text-blue-600',
                    write_off: 'bg-red-100 text-red-600',
                    inventory: 'bg-purple-100 text-purple-600',
                }[type] || 'bg-gray-100');

                const getInventoryStatusBadge = (status) => ({
                    draft: 'bg-gray-100 text-gray-600',
                    in_progress: 'bg-yellow-100 text-yellow-600',
                    completed: 'bg-green-100 text-green-600',
                    cancelled: 'bg-red-100 text-red-600',
                }[status] || 'bg-gray-100');

                // API
                const loadData = async () => {
                    try {
                        const [ingRes, catRes, unitRes, supRes, recRes, statsRes] = await Promise.all([
                            fetch(`${API_URL}/inventory/ingredients`),
                            fetch(`${API_URL}/inventory/categories`),
                            fetch(`${API_URL}/inventory/units`),
                            fetch(`${API_URL}/inventory/suppliers`),
                            fetch(`${API_URL}/inventory/recipes`),
                            fetch(`${API_URL}/inventory/stats`),
                        ]);

                        const [ingData, catData, unitData, supData, recData, statsData] = await Promise.all([
                            ingRes.json(), catRes.json(), unitRes.json(), supRes.json(), recRes.json(), statsRes.json()
                        ]);

                        if (ingData.success) ingredients.value = ingData.data;
                        if (catData.success) categories.value = catData.data;
                        if (unitData.success) units.value = unitData.data;
                        if (supData.success) suppliers.value = supData.data;
                        if (recData.success) recipes.value = recData.data;
                        if (statsData.success) stats.value = statsData.data;
                    } catch (e) { console.error(e); }
                };

                const loadMovements = async () => {
                    try {
                        let url = `${API_URL}/inventory/movements?from=${movementDateFrom.value}&to=${movementDateTo.value}`;
                        if (movementFilter.value) url += `&type=${movementFilter.value}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.success) movements.value = data.data;
                    } catch (e) { console.error(e); }
                };

                const loadInventoryChecks = async () => {
                    try {
                        const res = await fetch(`${API_URL}/inventory/checks`);
                        const data = await res.json();
                        if (data.success) inventoryChecks.value = data.data;
                    } catch (e) { console.error(e); }
                };

                // Modals
                const openIngredientModal = (item = null) => {
                    editingIngredient.value = item;
                    if (item) {
                        ingredientForm.value = { ...item };
                    } else {
                        ingredientForm.value = { name: '', category_id: null, unit_id: 1, quantity: 0, min_quantity: 0, cost_price: 0, sku: '', supplier_id: null, notes: '', track_stock: true };
                    }
                    showIngredientModal.value = true;
                };

                const openIncomeModal = (item) => {
                    selectedIngredient.value = item;
                    incomeForm.value = { quantity: 0, cost_price: item.cost_price, supplier_id: item.supplier_id, document_number: '' };
                    showIncomeModal.value = true;
                };

                const openWriteOffModal = (item) => {
                    selectedIngredient.value = item;
                    writeOffForm.value = { quantity: 0, reason: '', customReason: '' };
                    showWriteOffModal.value = true;
                };

                // Actions
                const saveIngredient = async () => {
                    if (!ingredientForm.value.name) return showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
                    try {
                        const url = editingIngredient.value 
                            ? `${API_URL}/inventory/ingredients/${editingIngredient.value.id}`
                            : `${API_URL}/inventory/ingredients`;
                        const res = await fetch(url, {
                            method: editingIngredient.value ? 'PUT' : 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(ingredientForm.value),
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast(data.message);
                            showIngredientModal.value = false;
                            loadData();
                        } else {
                            showToast(data.message, 'error');
                        }
                    } catch (e) { showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error'); }
                };

                const submitIncome = async () => {
                    if (!incomeForm.value.quantity || incomeForm.value.quantity <= 0) return showToast('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');
                    try {
                        const res = await fetch(`${API_URL}/inventory/stock/income`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ingredient_id: selectedIngredient.value.id, ...incomeForm.value }),
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast('–ü—Ä–∏—Ö–æ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω');
                            showIncomeModal.value = false;
                            loadData();
                        } else {
                            showToast(data.message, 'error');
                        }
                    } catch (e) { showToast('–û—à–∏–±–∫–∞', 'error'); }
                };

                const submitWriteOff = async () => {
                    if (!writeOffForm.value.quantity) return showToast('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');
                    const reason = writeOffForm.value.reason === '–î—Ä—É–≥–æ–µ' ? writeOffForm.value.customReason : writeOffForm.value.reason;
                    if (!reason) return showToast('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É', 'error');
                    try {
                        const res = await fetch(`${API_URL}/inventory/stock/write-off`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ingredient_id: selectedIngredient.value.id, quantity: writeOffForm.value.quantity, reason }),
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast('–°–ø–∏—Å–∞–Ω–∏–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ');
                            showWriteOffModal.value = false;
                            loadData();
                        } else {
                            showToast(data.message, 'error');
                        }
                    } catch (e) { showToast('–û—à–∏–±–∫–∞', 'error'); }
                };

                const createInventoryCheck = async () => {
                    if (!confirm('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é?')) return;
                    try {
                        const res = await fetch(`${API_URL}/inventory/checks`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({}),
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast('–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞');
                            loadInventoryChecks();
                        }
                    } catch (e) { showToast('–û—à–∏–±–∫–∞', 'error'); }
                };

                const showLowStock = () => {
                    filterCategory.value = null;
                    currentTab.value = 'ingredients';
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –Ω–∏–∑–∫–æ–º—É –æ—Å—Ç–∞—Ç–∫—É
                };

                const showMovements = (item) => {
                    currentTab.value = 'movements';
                    // TODO: filter by ingredient
                };

                const openRecipeModal = (recipe = null) => {
                    showToast('–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ—Ö–∫–∞—Ä—Ç –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                };

                const openInventoryCheck = (check) => {
                    showToast('–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                };

                const openSupplierModal = (supplier = null) => {
                    showToast('–†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                };

                // Watch
                watch(currentTab, (tab) => {
                    if (tab === 'movements') loadMovements();
                    if (tab === 'inventory') loadInventoryChecks();
                });

                onMounted(() => {
                    loadData();
                });

                return {
                    ingredients, categories, units, suppliers, recipes, movements, inventoryChecks, stats,
                    currentTab, filterCategory, searchQuery, movementFilter, movementDateFrom, movementDateTo,
                    showIngredientModal, showIncomeModal, showWriteOffModal, editingIngredient, selectedIngredient,
                    ingredientForm, incomeForm, writeOffForm, toast, tabs,
                    filteredIngredients,
                    showToast, formatMoney, formatDate, formatDateTime, getMovementBadge, getInventoryStatusBadge,
                    loadData, loadMovements, loadInventoryChecks,
                    openIngredientModal, openIncomeModal, openWriteOffModal,
                    saveIngredient, submitIncome, submitWriteOff, createInventoryCheck,
                    showLowStock, showMovements, openRecipeModal, openInventoryCheck, openSupplierModal,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
