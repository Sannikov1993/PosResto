<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî PosLab</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-800">üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–æ–≤</h1>
                <a href="/poslab-crm.html" class="text-gray-500 hover:text-orange-500 text-sm">‚Üê –ù–∞–∑–∞–¥ –≤ CRM</a>
            </div>
            <div class="flex items-center gap-4">
                <!-- Stats -->
                <div class="flex gap-3">
                    <div class="bg-yellow-100 px-4 py-2 rounded-xl">
                        <p class="text-xs text-yellow-600">–û–∂–∏–¥–∞—é—Ç</p>
                        <p class="text-xl font-bold text-yellow-600">{{ stats.today?.pending || 0 }}</p>
                    </div>
                    <div class="bg-green-100 px-4 py-2 rounded-xl">
                        <p class="text-xs text-green-600">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</p>
                        <p class="text-xl font-bold text-green-600">{{ stats.today?.confirmed || 0 }}</p>
                    </div>
                    <div class="bg-blue-100 px-4 py-2 rounded-xl">
                        <p class="text-xs text-blue-600">–ì–æ—Å—Ç–µ–π —Å–µ–≥–æ–¥–Ω—è</p>
                        <p class="text-xl font-bold text-blue-600">{{ stats.today?.total_guests || 0 }}</p>
                    </div>
                </div>
                <button @click="openNewReservation" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-600">
                    + –ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                </button>
            </div>
        </header>

        <main class="p-6">
            <div class="flex gap-6">
                <!-- Calendar -->
                <div class="w-80 shrink-0">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <!-- Month Navigation -->
                        <div class="flex items-center justify-between mb-4">
                            <button @click="prevMonth" class="p-2 hover:bg-gray-100 rounded-lg">‚Üê</button>
                            <h3 class="font-bold text-lg">{{ monthName }} {{ currentYear }}</h3>
                            <button @click="nextMonth" class="p-2 hover:bg-gray-100 rounded-lg">‚Üí</button>
                        </div>
                        
                        <!-- Weekdays -->
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div v-for="day in ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å']" :key="day" 
                                 class="text-center text-xs text-gray-500 font-medium py-1">{{ day }}</div>
                        </div>
                        
                        <!-- Days -->
                        <div class="grid grid-cols-7 gap-1">
                            <!-- Empty cells for offset -->
                            <div v-for="n in firstDayOffset" :key="'empty-'+n"></div>
                            
                            <!-- Calendar days -->
                            <div v-for="day in calendarDays" :key="day.date"
                                 @click="selectDate(day.date)"
                                 :class="[
                                     'aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer transition text-sm',
                                     day.date === selectedDate ? 'bg-orange-500 text-white' :
                                     day.isToday ? 'bg-orange-100 text-orange-600' :
                                     day.isPast ? 'text-gray-300' : 'hover:bg-gray-100',
                                     day.reservations_count > 0 && day.date !== selectedDate ? 'font-bold' : ''
                                 ]">
                                <span>{{ day.day }}</span>
                                <span v-if="day.reservations_count > 0" 
                                      :class="['text-xs', day.date === selectedDate ? 'text-orange-100' : 'text-orange-500']">
                                    {{ day.reservations_count }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Summary -->
                    <div class="bg-white rounded-xl shadow-sm p-4 mt-4">
                        <h4 class="font-semibold mb-3">üìä –ù–∞ {{ formatDateShort(selectedDate) }}</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">–í—Å–µ–≥–æ –±—Ä–æ–Ω–µ–π:</span>
                                <span class="font-semibold">{{ selectedDateReservations.length }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">–ì–æ—Å—Ç–µ–π:</span>
                                <span class="font-semibold">{{ totalGuestsForDate }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Filters -->
                    <div class="bg-white rounded-xl shadow-sm p-4 mt-4">
                        <h4 class="font-semibold mb-3">üîç –§–∏–ª—å—Ç—Ä</h4>
                        <div class="space-y-2">
                            <button v-for="status in statuses" :key="status.value"
                                    @click="toggleFilter(status.value)"
                                    :class="[
                                        'w-full text-left px-3 py-2 rounded-lg text-sm transition',
                                        activeFilters.includes(status.value) ? status.activeClass : 'hover:bg-gray-100'
                                    ]">
                                {{ status.icon }} {{ status.label }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reservations List -->
                <div class="flex-1">
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="px-6 py-4 border-b flex justify-between items-center">
                            <h3 class="font-bold text-lg">
                                {{ formatDateFull(selectedDate) }}
                            </h3>
                            <div class="flex gap-2">
                                <button @click="viewMode = 'list'" 
                                        :class="['px-3 py-1 rounded-lg text-sm', viewMode === 'list' ? 'bg-gray-200' : 'hover:bg-gray-100']">
                                    üìã –°–ø–∏—Å–æ–∫
                                </button>
                                <button @click="viewMode = 'timeline'" 
                                        :class="['px-3 py-1 rounded-lg text-sm', viewMode === 'timeline' ? 'bg-gray-200' : 'hover:bg-gray-100']">
                                    ‚è±Ô∏è –¢–∞–π–º–ª–∞–π–Ω
                                </button>
                            </div>
                        </div>

                        <!-- List View -->
                        <div v-if="viewMode === 'list'" class="divide-y">
                            <div v-for="res in filteredReservations" :key="res.id"
                                 @click="selectReservation(res)"
                                 class="px-6 py-4 hover:bg-gray-50 cursor-pointer flex items-center gap-4 fade-in">
                                
                                <!-- Time -->
                                <div class="w-24 text-center">
                                    <p class="text-2xl font-bold text-gray-800">{{ formatTime(res.time_from) }}</p>
                                    <p class="text-xs text-gray-400">–¥–æ {{ formatTime(res.time_to) }}</p>
                                </div>

                                <!-- Status -->
                                <div :class="['w-3 h-12 rounded-full', getStatusColor(res.status)]"></div>

                                <!-- Guest Info -->
                                <div class="flex-1">
                                    <p class="font-semibold text-lg">{{ res.guest_name }}</p>
                                    <p class="text-gray-500">üì± {{ res.guest_phone }}</p>
                                </div>

                                <!-- Table & Guests -->
                                <div class="text-center">
                                    <p class="text-2xl">ü™ë</p>
                                    <p class="text-sm font-medium">–°—Ç–æ–ª {{ res.table?.number }}</p>
                                </div>

                                <div class="text-center">
                                    <p class="text-2xl">üë•</p>
                                    <p class="text-sm font-medium">{{ res.guests_count }} —á–µ–ª</p>
                                </div>

                                <!-- Status Badge -->
                                <div :class="['px-3 py-1 rounded-full text-sm font-medium', getStatusBadge(res.status)]">
                                    {{ res.status_label }}
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-1">
                                    <button v-if="res.status === 'pending'" 
                                            @click.stop="confirmReservation(res)"
                                            class="p-2 hover:bg-green-100 rounded-lg text-green-600" title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å">‚úì</button>
                                    <button v-if="res.status === 'confirmed'" 
                                            @click.stop="seatReservation(res)"
                                            class="p-2 hover:bg-blue-100 rounded-lg text-blue-600" title="–ì–æ—Å—Ç–∏ —Å–µ–ª–∏">ü™ë</button>
                                    <button @click.stop="callGuest(res)"
                                            class="p-2 hover:bg-gray-100 rounded-lg" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">üìû</button>
                                </div>
                            </div>

                            <div v-if="filteredReservations.length === 0" class="px-6 py-12 text-center text-gray-400">
                                <p class="text-4xl mb-2">üìÖ</p>
                                <p>–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É</p>
                                <button @click="openNewReservation" class="mt-4 text-orange-500 hover:underline">
                                    + –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                                </button>
                            </div>
                        </div>

                        <!-- Timeline View -->
                        <div v-if="viewMode === 'timeline'" class="p-6">
                            <div class="relative">
                                <!-- Time slots -->
                                <div class="flex">
                                    <div class="w-16 shrink-0"></div>
                                    <div class="flex-1 flex">
                                        <div v-for="hour in workHours" :key="hour" class="flex-1 text-center text-xs text-gray-400 border-l">
                                            {{ hour }}:00
                                        </div>
                                    </div>
                                </div>

                                <!-- Tables rows -->
                                <div v-for="table in tables" :key="table.id" class="flex items-center mt-2">
                                    <div class="w-16 shrink-0 text-sm font-medium text-gray-600">
                                        –°—Ç–æ–ª {{ table.number }}
                                    </div>
                                    <div class="flex-1 h-10 bg-gray-100 rounded relative flex">
                                        <!-- Reservations blocks -->
                                        <div v-for="res in getTableReservations(table.id)" :key="res.id"
                                             @click="selectReservation(res)"
                                             :class="['absolute h-full rounded cursor-pointer flex items-center px-2 text-white text-xs font-medium truncate', getStatusBg(res.status)]"
                                             :style="getTimelineStyle(res)"
                                             :title="res.guest_name + ' (' + res.guests_count + ' —á–µ–ª)'">
                                            {{ res.guest_name }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- New/Edit Reservation Modal -->
        <div v-if="showModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl w-[600px] max-h-[90vh] overflow-hidden flex flex-col fade-in">
                <div class="px-6 py-4 border-b flex justify-between items-center bg-orange-500 text-white">
                    <h3 class="text-xl font-bold">{{ editingReservation ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : 'üìÖ –ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' }}</h3>
                    <button @click="closeModal" class="text-white/80 hover:text-white text-2xl">&times;</button>
                </div>

                <div class="p-6 overflow-y-auto space-y-4">
                    <!-- Date & Time -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">–î–∞—Ç–∞ *</label>
                            <input type="date" v-model="form.date" :min="today" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–° *</label>
                            <select v-model="form.time_from" class="w-full border rounded-lg px-3 py-2">
                                <option v-for="t in timeSlots" :key="t" :value="t">{{ t }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–î–æ *</label>
                            <select v-model="form.time_to" class="w-full border rounded-lg px-3 py-2">
                                <option v-for="t in timeSlots.filter(t => t > form.time_from)" :key="t" :value="t">{{ t }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Table & Guests -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">–°—Ç–æ–ª *</label>
                            <select v-model="form.table_id" class="w-full border rounded-lg px-3 py-2">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª</option>
                                <option v-for="table in tables" :key="table.id" :value="table.id">
                                    –°—Ç–æ–ª {{ table.number }} ({{ table.seats }} –º–µ—Å—Ç)
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–ì–æ—Å—Ç–µ–π *</label>
                            <input type="number" v-model.number="form.guests_count" min="1" max="20" class="w-full border rounded-lg px-3 py-2">
                        </div>
                    </div>

                    <!-- Guest Info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">–ò–º—è –≥–æ—Å—Ç—è *</label>
                            <input type="text" v-model="form.guest_name" class="w-full border rounded-lg px-3 py-2" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                            <input type="tel" v-model="form.guest_phone" class="w-full border rounded-lg px-3 py-2" placeholder="+7 (999) 123-45-67">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" v-model="form.guest_email" class="w-full border rounded-lg px-3 py-2" placeholder="email@example.com">
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-medium mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea v-model="form.notes" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
                        <textarea v-model="form.special_requests" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="–î–µ—Ç—Å–∫–∏–π —Å—Ç—É–ª, –≤–∏–¥ –∏–∑ –æ–∫–Ω–∞, —Ç–∏—Ö–æ–µ –º–µ—Å—Ç–æ..."></textarea>
                    </div>

                    <!-- Deposit -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">–î–µ–ø–æ–∑–∏—Ç (‚ÇΩ)</label>
                            <input type="number" v-model.number="form.deposit" min="0" class="w-full border rounded-lg px-3 py-2" placeholder="0">
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" v-model="form.deposit_paid" class="w-5 h-5">
                                <span>–î–µ–ø–æ–∑–∏—Ç –æ–ø–ª–∞—á–µ–Ω</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t bg-gray-50 flex gap-3">
                    <button @click="closeModal" class="flex-1 py-3 rounded-xl bg-gray-200 font-medium">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="saveReservation" class="flex-1 py-3 rounded-xl bg-orange-500 text-white font-medium">
                        {{ editingReservation ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Reservation Detail Modal -->
        <div v-if="selectedReservation" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl w-[500px] overflow-hidden fade-in">
                <div :class="['px-6 py-4 text-white', getStatusHeaderBg(selectedReservation.status)]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">{{ formatDateFull(selectedReservation.date) }}</p>
                            <h3 class="text-2xl font-bold">{{ formatTime(selectedReservation.time_from) }} - {{ formatTime(selectedReservation.time_to) }}</h3>
                        </div>
                        <button @click="selectedReservation = null" class="text-white/80 hover:text-white text-2xl">&times;</button>
                    </div>
                </div>

                <div class="p-6 space-y-4">
                    <!-- Guest -->
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center text-2xl font-bold text-orange-500">
                            {{ selectedReservation.guest_name.charAt(0) }}
                        </div>
                        <div>
                            <p class="font-bold text-lg">{{ selectedReservation.guest_name }}</p>
                            <p class="text-gray-500">üì± {{ selectedReservation.guest_phone }}</p>
                            <p v-if="selectedReservation.guest_email" class="text-gray-500">üìß {{ selectedReservation.guest_email }}</p>
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-xl p-4 text-center">
                            <p class="text-3xl">ü™ë</p>
                            <p class="font-bold">–°—Ç–æ–ª {{ selectedReservation.table?.number }}</p>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 text-center">
                            <p class="text-3xl">üë•</p>
                            <p class="font-bold">{{ selectedReservation.guests_count }} –≥–æ—Å—Ç–µ–π</p>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <p class="text-sm text-gray-500 mb-1">–°—Ç–∞—Ç—É—Å</p>
                        <p :class="['font-bold text-lg', getStatusTextColor(selectedReservation.status)]">
                            {{ selectedReservation.status_label }}
                        </p>
                    </div>

                    <!-- Notes -->
                    <div v-if="selectedReservation.notes" class="bg-yellow-50 rounded-xl p-4">
                        <p class="text-sm text-yellow-600 mb-1">üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</p>
                        <p>{{ selectedReservation.notes }}</p>
                    </div>

                    <div v-if="selectedReservation.special_requests" class="bg-blue-50 rounded-xl p-4">
                        <p class="text-sm text-blue-600 mb-1">‚ú® –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</p>
                        <p>{{ selectedReservation.special_requests }}</p>
                    </div>

                    <!-- Deposit -->
                    <div v-if="selectedReservation.deposit" class="bg-green-50 rounded-xl p-4 flex justify-between items-center">
                        <div>
                            <p class="text-sm text-green-600">–î–µ–ø–æ–∑–∏—Ç</p>
                            <p class="font-bold text-lg">{{ formatMoney(selectedReservation.deposit) }}</p>
                        </div>
                        <span :class="['px-3 py-1 rounded-full text-sm', selectedReservation.deposit_paid ? 'bg-green-500 text-white' : 'bg-red-100 text-red-600']">
                            {{ selectedReservation.deposit_paid ? '‚úì –û–ø–ª–∞—á–µ–Ω' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω' }}
                        </span>
                    </div>
                </div>

                <div class="px-6 py-4 border-t bg-gray-50 flex gap-2">
                    <!-- Status Actions -->
                    <button v-if="selectedReservation.status === 'pending'" 
                            @click="confirmReservation(selectedReservation)"
                            class="flex-1 py-2 rounded-xl bg-green-500 text-white font-medium">‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    
                    <button v-if="selectedReservation.status === 'confirmed'" 
                            @click="seatReservation(selectedReservation)"
                            class="flex-1 py-2 rounded-xl bg-blue-500 text-white font-medium">ü™ë –ì–æ—Å—Ç–∏ —Å–µ–ª–∏</button>
                    
                    <button v-if="selectedReservation.status === 'seated'" 
                            @click="completeReservation(selectedReservation)"
                            class="flex-1 py-2 rounded-xl bg-gray-700 text-white font-medium">‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>

                    <button @click="editReservation(selectedReservation)" 
                            class="px-4 py-2 rounded-xl bg-gray-200">‚úèÔ∏è</button>
                    
                    <button @click="callGuest(selectedReservation)" 
                            class="px-4 py-2 rounded-xl bg-gray-200">üìû</button>

                    <button v-if="!['completed', 'cancelled'].includes(selectedReservation.status)"
                            @click="cancelReservation(selectedReservation)" 
                            class="px-4 py-2 rounded-xl bg-red-100 text-red-600">‚úó</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.show" :class="['fixed bottom-6 right-6 px-6 py-3 rounded-xl shadow-lg z-50 fade-in', toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white']">
            {{ toast.message }}
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const API_URL = 'http://127.0.0.1:8000/api';

                // State
                const reservations = ref([]);
                const tables = ref([]);
                const stats = ref({});
                const currentMonth = ref(new Date().getMonth() + 1);
                const currentYear = ref(new Date().getFullYear());
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const calendarData = ref([]);
                const viewMode = ref('list');
                const activeFilters = ref([]);
                const showModal = ref(false);
                const selectedReservation = ref(null);
                const editingReservation = ref(null);
                const toast = ref({ show: false, message: '', type: 'success' });

                const today = new Date().toISOString().split('T')[0];
                const workHours = Array.from({ length: 13 }, (_, i) => i + 10); // 10:00 - 22:00

                const form = ref({
                    date: today,
                    time_from: '12:00',
                    time_to: '14:00',
                    table_id: '',
                    guests_count: 2,
                    guest_name: '',
                    guest_phone: '',
                    guest_email: '',
                    notes: '',
                    special_requests: '',
                    deposit: null,
                    deposit_paid: false,
                });

                const statuses = [
                    { value: 'pending', label: '–û–∂–∏–¥–∞—é—Ç', icon: 'üïê', activeClass: 'bg-yellow-100 text-yellow-700' },
                    { value: 'confirmed', label: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ', icon: '‚úì', activeClass: 'bg-green-100 text-green-700' },
                    { value: 'seated', label: '–ì–æ—Å—Ç–∏ —Å–µ–ª–∏', icon: 'ü™ë', activeClass: 'bg-blue-100 text-blue-700' },
                    { value: 'completed', label: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ', icon: '‚úÖ', activeClass: 'bg-gray-100 text-gray-700' },
                    { value: 'cancelled', label: '–û—Ç–º–µ–Ω–µ–Ω–æ', icon: '‚úó', activeClass: 'bg-red-100 text-red-700' },
                ];

                const timeSlots = computed(() => {
                    const slots = [];
                    for (let h = 10; h <= 22; h++) {
                        slots.push(`${String(h).padStart(2, '0')}:00`);
                        if (h < 22) slots.push(`${String(h).padStart(2, '0')}:30`);
                    }
                    return slots;
                });

                // Calendar
                const monthName = computed(() => {
                    return new Date(currentYear.value, currentMonth.value - 1).toLocaleString('ru', { month: 'long' });
                });

                const firstDayOffset = computed(() => {
                    const first = new Date(currentYear.value, currentMonth.value - 1, 1);
                    return (first.getDay() + 6) % 7; // Monday = 0
                });

                const calendarDays = computed(() => {
                    const days = [];
                    const daysInMonth = new Date(currentYear.value, currentMonth.value, 0).getDate();
                    const todayStr = new Date().toISOString().split('T')[0];
                    
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dateStr = `${currentYear.value}-${String(currentMonth.value).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        const calData = calendarData.value.find(c => c.date === dateStr);
                        days.push({
                            day: d,
                            date: dateStr,
                            isToday: dateStr === todayStr,
                            isPast: dateStr < todayStr,
                            reservations_count: calData?.reservations_count || 0,
                        });
                    }
                    return days;
                });

                const selectedDateReservations = computed(() => {
                    return reservations.value.filter(r => r.date === selectedDate.value);
                });

                const filteredReservations = computed(() => {
                    let result = selectedDateReservations.value;
                    if (activeFilters.value.length > 0) {
                        result = result.filter(r => activeFilters.value.includes(r.status));
                    }
                    return result.sort((a, b) => a.time_from.localeCompare(b.time_from));
                });

                const totalGuestsForDate = computed(() => {
                    return selectedDateReservations.value
                        .filter(r => ['pending', 'confirmed', 'seated'].includes(r.status))
                        .reduce((sum, r) => sum + r.guests_count, 0);
                });

                // Methods
                const showToast = (message, type = 'success') => {
                    toast.value = { show: true, message, type };
                    setTimeout(() => toast.value.show = false, 3000);
                };

                const formatTime = (t) => t ? t.substring(0, 5) : '';
                const formatMoney = (a) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0 }).format(a || 0);
                const formatDateShort = (d) => new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                const formatDateFull = (d) => new Date(d).toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });

                const getStatusColor = (s) => ({
                    pending: 'bg-yellow-400',
                    confirmed: 'bg-green-500',
                    seated: 'bg-blue-500',
                    completed: 'bg-gray-400',
                    cancelled: 'bg-red-400',
                    no_show: 'bg-red-300',
                }[s] || 'bg-gray-300');

                const getStatusBg = (s) => ({
                    pending: 'bg-yellow-500',
                    confirmed: 'bg-green-500',
                    seated: 'bg-blue-500',
                    completed: 'bg-gray-500',
                    cancelled: 'bg-red-400',
                }[s] || 'bg-gray-400');

                const getStatusBadge = (s) => ({
                    pending: 'bg-yellow-100 text-yellow-700',
                    confirmed: 'bg-green-100 text-green-700',
                    seated: 'bg-blue-100 text-blue-700',
                    completed: 'bg-gray-100 text-gray-700',
                    cancelled: 'bg-red-100 text-red-700',
                    no_show: 'bg-red-100 text-red-700',
                }[s] || 'bg-gray-100');

                const getStatusHeaderBg = (s) => ({
                    pending: 'bg-yellow-500',
                    confirmed: 'bg-green-500',
                    seated: 'bg-blue-500',
                    completed: 'bg-gray-600',
                    cancelled: 'bg-red-500',
                }[s] || 'bg-gray-500');

                const getStatusTextColor = (s) => ({
                    pending: 'text-yellow-600',
                    confirmed: 'text-green-600',
                    seated: 'text-blue-600',
                    completed: 'text-gray-600',
                    cancelled: 'text-red-600',
                }[s] || 'text-gray-600');

                const getTableReservations = (tableId) => {
                    return filteredReservations.value.filter(r => r.table_id === tableId);
                };

                const getTimelineStyle = (res) => {
                    const startHour = parseInt(res.time_from.split(':')[0]);
                    const startMin = parseInt(res.time_from.split(':')[1]);
                    const endHour = parseInt(res.time_to.split(':')[0]);
                    const endMin = parseInt(res.time_to.split(':')[1]);
                    
                    const totalMinutes = (22 - 10) * 60;
                    const startOffset = (startHour - 10) * 60 + startMin;
                    const duration = (endHour - startHour) * 60 + (endMin - startMin);
                    
                    return {
                        left: (startOffset / totalMinutes * 100) + '%',
                        width: (duration / totalMinutes * 100) + '%',
                    };
                };

                const toggleFilter = (status) => {
                    const idx = activeFilters.value.indexOf(status);
                    if (idx >= 0) activeFilters.value.splice(idx, 1);
                    else activeFilters.value.push(status);
                };

                const prevMonth = () => {
                    if (currentMonth.value === 1) {
                        currentMonth.value = 12;
                        currentYear.value--;
                    } else {
                        currentMonth.value--;
                    }
                    loadCalendar();
                };

                const nextMonth = () => {
                    if (currentMonth.value === 12) {
                        currentMonth.value = 1;
                        currentYear.value++;
                    } else {
                        currentMonth.value++;
                    }
                    loadCalendar();
                };

                const selectDate = (date) => {
                    selectedDate.value = date;
                    loadReservations();
                };

                // API
                const loadCalendar = async () => {
                    try {
                        const res = await fetch(`${API_URL}/reservations/calendar?month=${currentMonth.value}&year=${currentYear.value}`);
                        const data = await res.json();
                        if (data.success) calendarData.value = data.data.days;
                    } catch (e) { console.error(e); }
                };

                const loadReservations = async () => {
                    try {
                        const res = await fetch(`${API_URL}/reservations?date=${selectedDate.value}`);
                        const data = await res.json();
                        if (data.success) reservations.value = data.data;
                    } catch (e) { console.error(e); }
                };

                const loadTables = async () => {
                    try {
                        const res = await fetch(`${API_URL}/tables`);
                        const data = await res.json();
                        if (data.success) tables.value = data.data;
                    } catch (e) { console.error(e); }
                };

                const loadStats = async () => {
                    try {
                        const res = await fetch(`${API_URL}/reservations/stats`);
                        const data = await res.json();
                        if (data.success) stats.value = data.data;
                    } catch (e) { console.error(e); }
                };

                const openNewReservation = () => {
                    editingReservation.value = null;
                    form.value = {
                        date: selectedDate.value,
                        time_from: '12:00',
                        time_to: '14:00',
                        table_id: '',
                        guests_count: 2,
                        guest_name: '',
                        guest_phone: '',
                        guest_email: '',
                        notes: '',
                        special_requests: '',
                        deposit: null,
                        deposit_paid: false,
                    };
                    showModal.value = true;
                };

                const editReservation = (res) => {
                    editingReservation.value = res;
                    form.value = {
                        date: res.date,
                        time_from: res.time_from.substring(0, 5),
                        time_to: res.time_to.substring(0, 5),
                        table_id: res.table_id,
                        guests_count: res.guests_count,
                        guest_name: res.guest_name,
                        guest_phone: res.guest_phone,
                        guest_email: res.guest_email || '',
                        notes: res.notes || '',
                        special_requests: res.special_requests || '',
                        deposit: res.deposit,
                        deposit_paid: res.deposit_paid,
                    };
                    selectedReservation.value = null;
                    showModal.value = true;
                };

                const closeModal = () => {
                    showModal.value = false;
                    editingReservation.value = null;
                };

                const selectReservation = (res) => {
                    selectedReservation.value = res;
                };

                const saveReservation = async () => {
                    if (!form.value.guest_name || !form.value.guest_phone || !form.value.table_id) {
                        return showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                    }

                    try {
                        const url = editingReservation.value 
                            ? `${API_URL}/reservations/${editingReservation.value.id}`
                            : `${API_URL}/reservations`;
                        
                        const res = await fetch(url, {
                            method: editingReservation.value ? 'PUT' : 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(form.value),
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            showToast(editingReservation.value ? '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
                            closeModal();
                            loadReservations();
                            loadCalendar();
                            loadStats();
                        } else {
                            showToast(data.message, 'error');
                        }
                    } catch (e) {
                        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                    }
                };

                const confirmReservation = async (res) => {
                    try {
                        const response = await fetch(`${API_URL}/reservations/${res.id}/confirm`, { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            showToast('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ');
                            loadReservations();
                            loadStats();
                            selectedReservation.value = null;
                        }
                    } catch (e) { showToast('–û—à–∏–±–∫–∞', 'error'); }
                };

                const seatReservation = async (res) => {
                    try {
                        const response = await fetch(`${API_URL}/reservations/${res.id}/seat`, { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            showToast('–ì–æ—Å—Ç–∏ —Å–µ–ª–∏ –∑–∞ —Å—Ç–æ–ª');
                            loadReservations();
                            loadStats();
                            selectedReservation.value = null;
                        }
                    } catch (e) { showToast('–û—à–∏–±–∫–∞', 'error'); }
                };

                const completeReservation = async (res) => {
                    try {
                        const response = await fetch(`${API_URL}/reservations/${res.id}/complete`, { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            showToast('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                            loadReservations();
                            loadStats();
                            selectedReservation.value = null;
                        }
                    } catch (e) { showToast('–û—à–∏–±–∫–∞', 'error'); }
                };

                const cancelReservation = async (res) => {
                    if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) return;
                    try {
                        const response = await fetch(`${API_URL}/reservations/${res.id}/cancel`, { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            showToast('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                            loadReservations();
                            loadCalendar();
                            loadStats();
                            selectedReservation.value = null;
                        }
                    } catch (e) { showToast('–û—à–∏–±–∫–∞', 'error'); }
                };

                const callGuest = (res) => {
                    window.open(`tel:${res.guest_phone}`);
                };

                onMounted(() => {
                    loadCalendar();
                    loadReservations();
                    loadTables();
                    loadStats();
                });

                return {
                    reservations, tables, stats, currentMonth, currentYear, selectedDate, calendarData,
                    viewMode, activeFilters, showModal, selectedReservation, editingReservation, form, toast,
                    today, workHours, statuses, timeSlots,
                    monthName, firstDayOffset, calendarDays, selectedDateReservations, filteredReservations, totalGuestsForDate,
                    showToast, formatTime, formatMoney, formatDateShort, formatDateFull,
                    getStatusColor, getStatusBg, getStatusBadge, getStatusHeaderBg, getStatusTextColor,
                    getTableReservations, getTimelineStyle, toggleFilter,
                    prevMonth, nextMonth, selectDate,
                    loadCalendar, loadReservations, loadTables, loadStats,
                    openNewReservation, editReservation, closeModal, selectReservation, saveReservation,
                    confirmReservation, seatReservation, completeReservation, cancelReservation, callGuest,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
