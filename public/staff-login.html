<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É - MenuLab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .pin-input {
            width: 3.5rem;
            height: 4rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            background: rgba(51, 65, 85, 0.5);
            border: 2px solid rgba(71, 85, 105, 0.5);
            border-radius: 0.75rem;
            color: white;
            transition: all 0.2s;
        }
        .pin-input:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15);
        }
        .app-card {
            padding: 1rem 1.25rem;
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.25s;
            background: rgba(51, 65, 85, 0.3);
        }
        .app-card:hover {
            border-color: rgba(168, 85, 247, 0.5);
            background: rgba(168, 85, 247, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen flex items-center justify-center p-4">
    <div id="app">
        <div class="w-full max-w-md">
            <!-- Logo -->
            <div class="text-center mb-10">
                <img src="/images/logo/menulab_logo_dark_bg.svg" alt="MenuLab" class="h-16 mx-auto mb-4" />
                <p class="text-gray-400 text-lg">–í—Ö–æ–¥ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
            </div>

            <!-- Card -->
            <div class="bg-slate-800/50 rounded-2xl shadow-xl border border-slate-700/50 overflow-hidden">

                <!-- Login Tabs -->
                <div class="flex border-b border-slate-700/50" v-if="!showAppSelector">
                    <button @click="loginMode = 'password'"
                            :class="['flex-1 py-3.5 text-sm font-medium transition-colors',
                                loginMode === 'password'
                                    ? 'text-purple-400 border-b-2 border-purple-500 bg-purple-500/5'
                                    : 'text-gray-500 hover:text-gray-300']">
                        Email / –ü–∞—Ä–æ–ª—å
                    </button>
                    <button @click="loginMode = 'pin'"
                            :class="['flex-1 py-3.5 text-sm font-medium transition-colors',
                                loginMode === 'pin'
                                    ? 'text-purple-400 border-b-2 border-purple-500 bg-purple-500/5'
                                    : 'text-gray-500 hover:text-gray-300']">
                        PIN-–∫–æ–¥
                    </button>
                </div>

                <!-- App Selector (after login if multiple apps available) -->
                <div v-if="showAppSelector" class="p-6">
                    <div class="text-center mb-5">
                        <div class="w-14 h-14 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg class="w-7 h-7 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h2 class="text-lg font-semibold text-white">{{ user?.name }}</h2>
                    </div>

                    <!-- Shift Status -->
                    <div class="mb-5 p-4 rounded-xl border"
                         :class="shiftStatus.is_clocked_in
                            ? 'bg-green-500/5 border-green-500/20'
                            : 'bg-slate-700/30 border-slate-600/30'">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-medium"
                                     :class="shiftStatus.is_clocked_in ? 'text-green-400' : 'text-gray-400'">
                                    {{ shiftStatus.is_clocked_in ? '–°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞' : '–°–º–µ–Ω–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞' }}
                                </div>
                                <div v-if="shiftStatus.is_clocked_in && shiftStatus.session"
                                     class="text-xs text-green-500/70 mt-0.5">
                                    –° {{ formatTime(shiftStatus.session.clock_in) }} ({{ shiftStatus.session.duration_formatted }})
                                </div>
                            </div>
                            <button @click="toggleShift"
                                    :disabled="shiftLoading"
                                    :class="[
                                        'px-4 py-2 rounded-lg font-medium text-sm transition-all flex items-center gap-2',
                                        shiftStatus.is_clocked_in
                                            ? 'bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30'
                                            : 'bg-green-500/20 hover:bg-green-500/30 text-green-400 border border-green-500/30'
                                    ]">
                                <svg v-if="shiftLoading" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                                {{ shiftStatus.is_clocked_in ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å' : '–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É' }}
                            </button>
                        </div>
                    </div>

                    <p class="text-gray-500 text-sm text-center mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>

                    <div class="space-y-2.5">
                        <div v-for="app in availableApps" :key="app.url"
                             @click="goToApp(app.url)"
                             class="app-card flex items-center gap-4">
                            <div :class="['w-11 h-11 rounded-xl flex items-center justify-center text-xl', app.bgClass]">
                                {{ app.icon }}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-white text-sm">{{ app.name }}</div>
                                <div class="text-xs text-gray-500">{{ app.description }}</div>
                            </div>
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>

                    <button @click="logout"
                            class="w-full mt-6 text-sm text-gray-500 hover:text-gray-300 transition-colors">
                        –í—ã–π—Ç–∏
                    </button>
                </div>

                <!-- Password Login Form -->
                <form v-else-if="loginMode === 'password'" @submit.prevent="loginWithPassword" class="p-6 space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1.5">Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω</label>
                        <input v-model="form.login" type="text"
                               placeholder="+7 999 123-45-67 –∏–ª–∏ email"
                               required
                               class="w-full bg-slate-700/50 rounded-xl px-4 py-3 text-white text-sm placeholder-gray-500 border border-slate-600/50 transition-colors focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500">
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1.5">
                            <label class="block text-sm font-medium text-gray-300">–ü–∞—Ä–æ–ª—å</label>
                            <a href="/forgot-password" class="text-xs text-purple-400 hover:text-purple-300 transition-colors">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                        </div>
                        <input v-model="form.password" type="password"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                               required
                               class="w-full bg-slate-700/50 rounded-xl px-4 py-3 text-white text-sm placeholder-gray-500 border border-slate-600/50 transition-colors focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500">
                    </div>

                    <div v-if="error" class="bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-xl text-sm">
                        {{ error }}
                    </div>

                    <button type="submit" :disabled="loading"
                            :class="[
                                'w-full py-3.5 rounded-xl text-white font-semibold text-sm transition-all flex items-center justify-center gap-2',
                                loading
                                    ? 'bg-purple-500/40 cursor-not-allowed'
                                    : 'bg-gradient-to-r from-purple-600 to-violet-700 hover:from-purple-500 hover:to-violet-600 hover:shadow-lg hover:shadow-purple-500/25'
                            ]">
                        <svg v-if="loading" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                        </svg>
                        <span>{{ loading ? '–í—Ö–æ–¥...' : '–í–æ–π—Ç–∏' }}</span>
                    </button>
                </form>

                <!-- PIN Login Form -->
                <form v-else @submit.prevent="loginWithPin" class="p-6">
                    <p class="text-center text-gray-400 mb-6">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à 4-–∑–Ω–∞—á–Ω—ã–π PIN-–∫–æ–¥</p>

                    <div class="flex justify-center gap-3 mb-6">
                        <input v-for="(digit, index) in 4" :key="index"
                               :ref="el => pinInputs[index] = el"
                               v-model="pin[index]"
                               @input="onPinInput(index, $event)"
                               @keydown="onPinKeydown(index, $event)"
                               type="password"
                               maxlength="1"
                               class="pin-input"
                               inputmode="numeric">
                    </div>

                    <div v-if="error" class="bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-xl text-sm text-center mb-4">
                        {{ error }}
                    </div>

                    <button type="submit" :disabled="loading || pinCode.length !== 4"
                            :class="[
                                'w-full py-3.5 rounded-xl text-white font-semibold text-sm transition-all flex items-center justify-center gap-2',
                                (loading || pinCode.length !== 4)
                                    ? 'bg-purple-500/40 cursor-not-allowed'
                                    : 'bg-gradient-to-r from-purple-600 to-violet-700 hover:from-purple-500 hover:to-violet-600 hover:shadow-lg hover:shadow-purple-500/25'
                            ]">
                        <svg v-if="loading" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                        </svg>
                        <span>{{ loading ? '–ü—Ä–æ–≤–µ—Ä–∫–∞...' : '–í–æ–π—Ç–∏' }}</span>
                    </button>
                </form>
            </div>

            <!-- Footer link -->
            <div v-if="!showAppSelector" class="mt-6 text-center">
                <a href="/" class="text-sm text-gray-500 hover:text-gray-300 transition-colors">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        // Role to app mapping
        const ROLE_APPS = {
            'super_admin': [
                { url: '/backoffice-vue', name: '–ë—ç–∫-–æ—Ñ–∏—Å', icon: 'üìä', description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º', bgClass: 'bg-purple-500/20' },
                { url: '/pos-vue', name: 'POS —Ç–µ—Ä–º–∏–Ω–∞–ª', icon: 'üí≥', description: '–ö–∞—Å—Å–∞ –∏ –∑–∞–∫–∞–∑—ã', bgClass: 'bg-blue-500/20' },
            ],
            'owner': [
                { url: '/backoffice-vue', name: '–ë—ç–∫-–æ—Ñ–∏—Å', icon: 'üìä', description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º', bgClass: 'bg-purple-500/20' },
                { url: '/pos-vue', name: 'POS —Ç–µ—Ä–º–∏–Ω–∞–ª', icon: 'üí≥', description: '–ö–∞—Å—Å–∞ –∏ –∑–∞–∫–∞–∑—ã', bgClass: 'bg-blue-500/20' },
            ],
            'admin': [
                { url: '/backoffice-vue', name: '–ë—ç–∫-–æ—Ñ–∏—Å', icon: 'üìä', description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º', bgClass: 'bg-purple-500/20' },
                { url: '/pos-vue', name: 'POS —Ç–µ—Ä–º–∏–Ω–∞–ª', icon: 'üí≥', description: '–ö–∞—Å—Å–∞ –∏ –∑–∞–∫–∞–∑—ã', bgClass: 'bg-blue-500/20' },
            ],
            'manager': [
                { url: '/backoffice-vue', name: '–ë—ç–∫-–æ—Ñ–∏—Å', icon: 'üìä', description: '–û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞', bgClass: 'bg-purple-500/20' },
                { url: '/pos-vue', name: 'POS —Ç–µ—Ä–º–∏–Ω–∞–ª', icon: 'üí≥', description: '–ö–∞—Å—Å–∞ –∏ –∑–∞–∫–∞–∑—ã', bgClass: 'bg-blue-500/20' },
            ],
            'cashier': [
                { url: '/pos-vue', name: 'POS —Ç–µ—Ä–º–∏–Ω–∞–ª', icon: 'üí≥', description: '–ö–∞—Å—Å–∞ –∏ –∑–∞–∫–∞–∑—ã', bgClass: 'bg-blue-500/20' },
            ],
            'waiter': [
                { url: '/waiter-vue', name: '–û—Ñ–∏—Ü–∏–∞–Ω—Ç', icon: 'üçΩÔ∏è', description: '–†–∞–±–æ—Ç–∞ —Å –∑–∞–∫–∞–∑–∞–º–∏', bgClass: 'bg-green-500/20' },
            ],
            'cook': [
                { url: '/kitchen-vue', name: '–ö—É—Ö–Ω—è', icon: 'üë®‚Äçüç≥', description: '–ö—É—Ö–æ–Ω–Ω—ã–π –¥–∏—Å–ø–ª–µ–π', bgClass: 'bg-orange-500/20' },
            ],
            'courier': [
                { url: '/courier', name: '–ö—É—Ä—å–µ—Ä', icon: 'üö¥', description: '–î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–∫–∞–∑–æ–≤', bgClass: 'bg-cyan-500/20' },
            ],
            'hostess': [
                { url: '/reservations-vue', name: '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', icon: 'üìÖ', description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω—è–º–∏', bgClass: 'bg-pink-500/20' },
            ],
        };

        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const loginMode = ref('password');
                const loading = ref(false);
                const error = ref(null);
                const showAppSelector = ref(false);
                const user = ref(null);

                const form = ref({
                    login: '',
                    password: ''
                });

                const pin = ref(['', '', '', '']);
                const pinInputs = ref([]);

                // Shift status
                const shiftStatus = ref({
                    is_clocked_in: false,
                    session: null
                });
                const shiftLoading = ref(false);

                const pinCode = computed(() => pin.value.join(''));

                const availableApps = computed(() => {
                    if (!user.value?.role) return [];
                    return ROLE_APPS[user.value.role] || ROLE_APPS['waiter'];
                });

                const onPinInput = (index, event) => {
                    const value = event.target.value;
                    if (value && index < 3) {
                        nextTick(() => pinInputs.value[index + 1]?.focus());
                    }
                    // Auto-submit when all 4 digits entered
                    if (pinCode.value.length === 4) {
                        loginWithPin();
                    }
                };

                const onPinKeydown = (index, event) => {
                    if (event.key === 'Backspace' && !pin.value[index] && index > 0) {
                        pinInputs.value[index - 1]?.focus();
                    }
                };

                const loginWithPassword = async () => {
                    error.value = null;
                    loading.value = true;

                    try {
                        const res = await axios.post(`${API_URL}/auth/login`, {
                            login: form.value.login,
                            password: form.value.password
                        });

                        if (res.data.success) {
                            handleLoginSuccess(res.data);
                        } else {
                            error.value = res.data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                        }
                    } catch (e) {
                        error.value = e.response?.data?.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    } finally {
                        loading.value = false;
                    }
                };

                const loginWithPin = async () => {
                    if (pinCode.value.length !== 4) return;

                    error.value = null;
                    loading.value = true;

                    try {
                        const res = await axios.post(`${API_URL}/auth/login-pin`, {
                            pin: pinCode.value
                        });

                        if (res.data.success) {
                            handleLoginSuccess(res.data);
                        } else {
                            error.value = res.data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥';
                            clearPin();
                        }
                    } catch (e) {
                        error.value = e.response?.data?.message || '–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥';
                        clearPin();
                    } finally {
                        loading.value = false;
                    }
                };

                const handleLoginSuccess = async (data) => {
                    user.value = data.user || data.data?.user || data.data;

                    // Save token if provided
                    if (data.token || data.data?.token) {
                        localStorage.setItem('staff_token', data.token || data.data?.token);
                    }

                    // Save user data
                    localStorage.setItem('staff_user', JSON.stringify(user.value));

                    const apps = ROLE_APPS[user.value.role] || [];

                    if (apps.length === 1) {
                        // Direct redirect if only one app available
                        goToApp(apps[0].url);
                    } else if (apps.length > 1) {
                        // Show app selector and load shift status
                        showAppSelector.value = true;
                        await loadShiftStatus();
                    } else {
                        // Fallback to home
                        window.location.href = '/';
                    }
                };

                const goToApp = (url) => {
                    window.location.href = url;
                };

                const logout = () => {
                    localStorage.removeItem('staff_token');
                    localStorage.removeItem('staff_user');
                    user.value = null;
                    showAppSelector.value = false;
                    form.value = { login: '', password: '' };
                    clearPin();
                };

                const clearPin = () => {
                    pin.value = ['', '', '', ''];
                    nextTick(() => pinInputs.value[0]?.focus());
                };

                // Shift management
                const loadShiftStatus = async () => {
                    const token = localStorage.getItem('staff_token');
                    if (!token) return;

                    try {
                        const res = await axios.get(`${API_URL}/payroll/my-status`, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        shiftStatus.value = res.data;
                    } catch (e) {
                        console.error('Failed to load shift status:', e);
                    }
                };

                const toggleShift = async () => {
                    const token = localStorage.getItem('staff_token');
                    if (!token) return;

                    shiftLoading.value = true;
                    try {
                        const endpoint = shiftStatus.value.is_clocked_in ? 'my-clock-out' : 'my-clock-in';
                        const res = await axios.post(`${API_URL}/payroll/${endpoint}`, {}, {
                            headers: { Authorization: `Bearer ${token}` }
                        });

                        if (res.data.success) {
                            await loadShiftStatus();
                        }
                    } catch (e) {
                        console.error('Failed to toggle shift:', e);
                        error.value = e.response?.data?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–º–µ–Ω—ã';
                    } finally {
                        shiftLoading.value = false;
                    }
                };

                const formatTime = (datetime) => {
                    if (!datetime) return '';
                    const date = new Date(datetime);
                    return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                };

                // Check if already logged in
                onMounted(async () => {
                    const savedUser = localStorage.getItem('staff_user');
                    if (savedUser) {
                        try {
                            user.value = JSON.parse(savedUser);
                            const apps = ROLE_APPS[user.value.role] || [];
                            if (apps.length > 1) {
                                showAppSelector.value = true;
                                await loadShiftStatus();
                            } else if (apps.length === 1) {
                                goToApp(apps[0].url);
                            }
                        } catch (e) {
                            localStorage.removeItem('staff_user');
                        }
                    }
                });

                return {
                    loginMode,
                    loading,
                    error,
                    showAppSelector,
                    user,
                    form,
                    pin,
                    pinInputs,
                    pinCode,
                    availableApps,
                    shiftStatus,
                    shiftLoading,
                    onPinInput,
                    onPinKeydown,
                    loginWithPassword,
                    loginWithPin,
                    goToApp,
                    logout,
                    toggleShift,
                    formatTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
