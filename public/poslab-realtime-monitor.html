<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Real-time Monitor ‚Äî PosLab</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/poslab-realtime.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease; }
        .slide-in { animation: slideIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <div id="app">
        <!-- Header -->
        <header class="bg-gray-800 px-6 py-4 flex items-center justify-between border-b border-gray-700">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold">‚ö° Real-time Monitor</h1>
                <span :class="['px-3 py-1 rounded-full text-sm font-medium', connected ? 'bg-green-500' : 'bg-red-500']">
                    {{ connected ? 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ' }}
                </span>
            </div>
            <div class="flex items-center gap-4">
                <button @click="toggleSound" :class="['px-4 py-2 rounded-lg', soundEnabled ? 'bg-green-600' : 'bg-gray-600']">
                    {{ soundEnabled ? 'üîä' : 'üîá' }} –ó–≤—É–∫
                </button>
                <button @click="testSound" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">
                    üéµ –¢–µ—Å—Ç
                </button>
                <button @click="clearEvents" class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                </button>
                <a href="/poslab-crm.html" class="text-gray-400 hover:text-white">‚Üê CRM</a>
            </div>
        </header>

        <main class="p-6">
            <div class="grid grid-cols-4 gap-6">
                <!-- Stats Panel -->
                <div class="col-span-1 space-y-4">
                    <!-- Connection Status -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <h3 class="font-semibold mb-3 text-gray-400">üì° –°—Ç–∞—Ç—É—Å</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">–ú–µ—Ç–æ–¥:</span>
                                <span>{{ connectionMethod }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Last ID:</span>
                                <span>{{ lastEventId }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">–°–æ–±—ã—Ç–∏–π:</span>
                                <span>{{ events.length }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Channel Stats -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <h3 class="font-semibold mb-3 text-gray-400">üìä –ü–æ –∫–∞–Ω–∞–ª–∞–º</h3>
                        <div class="space-y-2">
                            <div v-for="(count, channel) in channelStats" :key="channel" 
                                 class="flex justify-between items-center">
                                <span class="flex items-center gap-2">
                                    <span :class="['w-2 h-2 rounded-full', getChannelColor(channel)]"></span>
                                    {{ channel }}
                                </span>
                                <span class="bg-gray-700 px-2 py-0.5 rounded text-sm">{{ count }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Channel Filters -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <h3 class="font-semibold mb-3 text-gray-400">üîç –§–∏–ª—å—Ç—Ä—ã</h3>
                        <div class="space-y-2">
                            <label v-for="ch in allChannels" :key="ch" class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" v-model="activeChannels" :value="ch" class="rounded">
                                <span>{{ ch }}</span>
                            </label>
                        </div>
                    </div>

                    <!-- Send Test Event -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <h3 class="font-semibold mb-3 text-gray-400">üì§ –¢–µ—Å—Ç</h3>
                        <select v-model="testEvent.channel" class="w-full bg-gray-700 rounded-lg px-3 py-2 mb-2">
                            <option v-for="ch in allChannels" :key="ch" :value="ch">{{ ch }}</option>
                        </select>
                        <select v-model="testEvent.event" class="w-full bg-gray-700 rounded-lg px-3 py-2 mb-2">
                            <option value="new_order">new_order</option>
                            <option value="order_status">order_status</option>
                            <option value="kitchen_ready">kitchen_ready</option>
                            <option value="delivery_new">delivery_new</option>
                        </select>
                        <button @click="sendTestEvent" class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>

                <!-- Events Feed -->
                <div class="col-span-2">
                    <div class="bg-gray-800 rounded-xl overflow-hidden">
                        <div class="px-4 py-3 border-b border-gray-700 flex justify-between items-center">
                            <h3 class="font-semibold">üìã –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π</h3>
                            <span class="text-sm text-gray-500">{{ filteredEvents.length }} —Å–æ–±—ã—Ç–∏–π</span>
                        </div>
                        <div class="max-h-[700px] overflow-y-auto">
                            <div v-if="filteredEvents.length === 0" class="p-8 text-center text-gray-500">
                                <p class="text-4xl mb-2">üì≠</p>
                                <p>–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...</p>
                            </div>
                            <div v-for="event in filteredEvents" :key="event.id" 
                                 class="px-4 py-3 border-b border-gray-700 hover:bg-gray-750 slide-in">
                                <div class="flex items-start gap-3">
                                    <div :class="['w-10 h-10 rounded-lg flex items-center justify-center text-xl', getEventBg(event)]">
                                        {{ getEventIcon(event.event) }}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span :class="['px-2 py-0.5 rounded text-xs font-medium', getChannelBadge(event.channel)]">
                                                {{ event.channel }}
                                            </span>
                                            <span class="text-sm font-medium">{{ event.event }}</span>
                                        </div>
                                        <p v-if="event.data?.message" class="text-gray-300 text-sm">
                                            {{ event.data.message }}
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            {{ formatTime(event.timestamp) }}
                                        </p>
                                    </div>
                                    <button @click="showEventDetail(event)" class="text-gray-500 hover:text-white">
                                        üëÅÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Panel -->
                <div class="col-span-1 space-y-4">
                    <!-- Active Alerts -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <h3 class="font-semibold mb-3 text-gray-400">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                        <div v-if="notifications.length === 0" class="text-center text-gray-500 py-4">
                            –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö
                        </div>
                        <div v-for="(notif, i) in notifications" :key="i" 
                             :class="['mb-2 p-3 rounded-lg fade-in', notif.class]">
                            <div class="flex items-center justify-between">
                                <span class="font-medium">{{ notif.title }}</span>
                                <button @click="dismissNotification(i)" class="text-white/60 hover:text-white">√ó</button>
                            </div>
                            <p class="text-sm opacity-80">{{ notif.message }}</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <h3 class="font-semibold mb-3 text-gray-400">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                        <div class="space-y-2">
                            <button @click="simulateNewOrder" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                                üì• –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑
                            </button>
                            <button @click="simulateKitchenReady" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                                ‚úÖ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤
                            </button>
                            <button @click="simulateDelivery" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                                üõµ –ù–æ–≤–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
                            </button>
                        </div>
                    </div>

                    <!-- Recent Orders Summary -->
                    <div class="bg-gray-800 rounded-xl p-4">
                        <h3 class="font-semibold mb-3 text-gray-400">üì¶ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h3>
                        <div v-if="recentOrders.length === 0" class="text-center text-gray-500 py-4">
                            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                        </div>
                        <div v-for="order in recentOrders" :key="order.order_id" 
                             class="flex items-center justify-between py-2 border-b border-gray-700 last:border-0">
                            <span class="font-medium">#{{ order.order_number }}</span>
                            <span :class="['text-xs px-2 py-0.5 rounded', getStatusBadge(order.status)]">
                                {{ order.status }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Event Detail Modal -->
        <div v-if="selectedEvent" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" @click.self="selectedEvent = null">
            <div class="bg-gray-800 rounded-2xl w-[600px] max-h-[80vh] overflow-hidden fade-in">
                <div class="px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-xl font-bold">üìã –î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è</h3>
                    <button @click="selectedEvent = null" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <p class="text-xs text-gray-400 mb-1">ID</p>
                                <p class="font-mono">{{ selectedEvent.id }}</p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <p class="text-xs text-gray-400 mb-1">–í—Ä–µ–º—è</p>
                                <p>{{ formatTime(selectedEvent.timestamp) }}</p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <p class="text-xs text-gray-400 mb-1">–ö–∞–Ω–∞–ª</p>
                                <p>{{ selectedEvent.channel }}</p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <p class="text-xs text-gray-400 mb-1">–°–æ–±—ã—Ç–∏–µ</p>
                                <p>{{ selectedEvent.event }}</p>
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-3">
                            <p class="text-xs text-gray-400 mb-2">Data (JSON)</p>
                            <pre class="text-sm overflow-x-auto">{{ JSON.stringify(selectedEvent.data, null, 2) }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.show" class="fixed bottom-6 right-6 bg-gray-800 border border-gray-700 px-6 py-3 rounded-xl shadow-lg z-50 fade-in">
            {{ toast.message }}
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                // State
                const connected = ref(false);
                const connectionMethod = ref('');
                const lastEventId = ref(0);
                const events = ref([]);
                const notifications = ref([]);
                const recentOrders = ref([]);
                const soundEnabled = ref(true);
                const selectedEvent = ref(null);
                const toast = ref({ show: false, message: '' });

                const allChannels = ['orders', 'kitchen', 'delivery', 'reservations', 'tables', 'global'];
                const activeChannels = ref([...allChannels]);

                const testEvent = ref({
                    channel: 'orders',
                    event: 'new_order',
                });

                let realtime = null;

                // Computed
                const filteredEvents = computed(() => {
                    return events.value
                        .filter(e => activeChannels.value.includes(e.channel))
                        .slice(-100)
                        .reverse();
                });

                const channelStats = computed(() => {
                    const stats = {};
                    events.value.forEach(e => {
                        stats[e.channel] = (stats[e.channel] || 0) + 1;
                    });
                    return stats;
                });

                // Methods
                const showToast = (message) => {
                    toast.value = { show: true, message };
                    setTimeout(() => toast.value.show = false, 3000);
                };

                const formatTime = (ts) => {
                    if (!ts) return '';
                    const d = new Date(ts);
                    return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                };

                const getChannelColor = (channel) => ({
                    orders: 'bg-blue-500',
                    kitchen: 'bg-orange-500',
                    delivery: 'bg-purple-500',
                    reservations: 'bg-green-500',
                    tables: 'bg-yellow-500',
                    global: 'bg-gray-500',
                }[channel] || 'bg-gray-500');

                const getChannelBadge = (channel) => ({
                    orders: 'bg-blue-500/20 text-blue-400',
                    kitchen: 'bg-orange-500/20 text-orange-400',
                    delivery: 'bg-purple-500/20 text-purple-400',
                    reservations: 'bg-green-500/20 text-green-400',
                    tables: 'bg-yellow-500/20 text-yellow-400',
                    global: 'bg-gray-500/20 text-gray-400',
                }[channel] || 'bg-gray-500/20 text-gray-400');

                const getEventBg = (event) => ({
                    orders: 'bg-blue-500/20',
                    kitchen: 'bg-orange-500/20',
                    delivery: 'bg-purple-500/20',
                    reservations: 'bg-green-500/20',
                }[event.channel] || 'bg-gray-500/20');

                const getEventIcon = (eventType) => ({
                    new_order: 'üì•',
                    order_updated: '‚úèÔ∏è',
                    order_status: 'üîÑ',
                    order_paid: 'üí∞',
                    order_cancelled: '‚ùå',
                    kitchen_new: 'üë®‚Äçüç≥',
                    kitchen_ready: '‚úÖ',
                    delivery_new: 'üõµ',
                    delivery_status: 'üìç',
                    delivery_assigned: 'üë§',
                    reservation_new: 'üìÖ',
                    reservation_confirmed: '‚úì',
                    reservation_cancelled: '‚úó',
                    table_status: 'ü™ë',
                }[eventType] || 'üìå');

                const getStatusBadge = (status) => ({
                    new: 'bg-blue-500/20 text-blue-400',
                    cooking: 'bg-orange-500/20 text-orange-400',
                    ready: 'bg-green-500/20 text-green-400',
                    completed: 'bg-gray-500/20 text-gray-400',
                }[status] || 'bg-gray-500/20 text-gray-400');

                const toggleSound = () => {
                    soundEnabled.value = !soundEnabled.value;
                    if (realtime) realtime.setSoundEnabled(soundEnabled.value);
                };

                const testSound = () => {
                    if (realtime) realtime.playSound('new_order');
                };

                const clearEvents = () => {
                    events.value = [];
                    notifications.value = [];
                    recentOrders.value = [];
                };

                const showEventDetail = (event) => {
                    selectedEvent.value = event;
                };

                const dismissNotification = (index) => {
                    notifications.value.splice(index, 1);
                };

                const addNotification = (title, message, type = 'info') => {
                    const classes = {
                        info: 'bg-blue-600',
                        success: 'bg-green-600',
                        warning: 'bg-yellow-600',
                        error: 'bg-red-600',
                    };
                    notifications.value.unshift({
                        title,
                        message,
                        class: classes[type] || classes.info,
                    });
                    if (notifications.value.length > 5) {
                        notifications.value.pop();
                    }
                };

                const sendTestEvent = async () => {
                    if (realtime) {
                        try {
                            await realtime.send(testEvent.value.channel, testEvent.value.event, {
                                message: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                                order_number: Math.floor(Math.random() * 1000),
                                sound: testEvent.value.event,
                            });
                            showToast('–°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                        } catch (e) {
                            showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                        }
                    }
                };

                const simulateNewOrder = () => {
                    if (realtime) {
                        realtime.send('orders', 'new_order', {
                            order_id: Date.now(),
                            order_number: Math.floor(Math.random() * 1000),
                            type: 'dine_in',
                            total: Math.floor(Math.random() * 5000) + 500,
                            message: `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #${Math.floor(Math.random() * 1000)}`,
                            sound: 'new_order',
                        });
                    }
                };

                const simulateKitchenReady = () => {
                    if (realtime) {
                        realtime.send('kitchen', 'kitchen_ready', {
                            order_id: Date.now(),
                            order_number: Math.floor(Math.random() * 1000),
                            message: `–ó–∞–∫–∞–∑ #${Math.floor(Math.random() * 1000)} –≥–æ—Ç–æ–≤!`,
                            sound: 'order_ready',
                        });
                    }
                };

                const simulateDelivery = () => {
                    if (realtime) {
                        realtime.send('delivery', 'delivery_new', {
                            order_id: Date.now(),
                            order_number: Math.floor(Math.random() * 1000),
                            address: '—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 123',
                            message: `–ù–æ–≤–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ #${Math.floor(Math.random() * 1000)}`,
                            sound: 'delivery_new',
                        });
                    }
                };

                // Initialize
                onMounted(() => {
                    realtime = new PosLabRealtime({
                        channels: allChannels,
                        debug: true,
                        soundEnabled: true,
                    });

                    realtime.on('connected', (data) => {
                        connected.value = true;
                        connectionMethod.value = data.method.toUpperCase();
                        showToast('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    });

                    realtime.on('disconnected', () => {
                        connected.value = false;
                        showToast('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    });

                    realtime.on('event', (event) => {
                        events.value.push(event);
                        lastEventId.value = event.id;

                        // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
                        if (['new_order', 'kitchen_ready', 'delivery_new'].includes(event.event)) {
                            addNotification(
                                getEventIcon(event.event) + ' ' + event.event,
                                event.data?.message || '–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                                event.event === 'kitchen_ready' ? 'success' : 'info'
                            );
                        }

                        // –¢—Ä–µ–∫–∞–µ–º –∑–∞–∫–∞–∑—ã
                        if (event.data?.order_number) {
                            const existing = recentOrders.value.find(o => o.order_number === event.data.order_number);
                            if (existing) {
                                existing.status = event.data.new_status || event.event;
                            } else {
                                recentOrders.value.unshift({
                                    order_id: event.data.order_id,
                                    order_number: event.data.order_number,
                                    status: event.data.new_status || 'new',
                                });
                                if (recentOrders.value.length > 10) recentOrders.value.pop();
                            }
                        }
                    });

                    realtime.connect();
                });

                onUnmounted(() => {
                    if (realtime) {
                        realtime.disconnect();
                    }
                });

                return {
                    connected, connectionMethod, lastEventId, events, notifications, recentOrders,
                    soundEnabled, selectedEvent, toast, allChannels, activeChannels, testEvent,
                    filteredEvents, channelStats,
                    showToast, formatTime, getChannelColor, getChannelBadge, getEventBg, getEventIcon, getStatusBadge,
                    toggleSound, testSound, clearEvents, showEventDetail, dismissNotification,
                    sendTestEvent, simulateNewOrder, simulateKitchenReady, simulateDelivery,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
