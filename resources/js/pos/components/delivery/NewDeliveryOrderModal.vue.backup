<template>
    <Teleport to="body">
        <Transition name="modal">
            <div v-if="show" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50">
                <div class="bg-dark-900 w-full h-full flex overflow-hidden">
                    <!-- Left Panel - Order Form -->
                    <div class="w-[440px] flex flex-col border-r border-dark-700 bg-dark-950">
                        <!-- Left Panel Header -->
                        <div class="flex items-center justify-between px-4 py-3 border-b border-dark-700">
                            <div class="flex items-center gap-3">
                                <button
                                    @click="close"
                                    class="w-9 h-9 flex items-center justify-center rounded-xl bg-dark-800 hover:bg-dark-700 text-gray-400 hover:text-white transition-all"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <h2 class="text-lg font-semibold text-white">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
                            </div>
                            <!-- Order Type Dropdown -->
                            <div class="relative">
                                <button
                                    @click="showOrderTypeDropdown = !showOrderTypeDropdown"
                                    class="flex items-center gap-2 px-3 py-2 rounded-xl bg-dark-800 hover:bg-dark-700 transition-all"
                                >
                                    <span v-if="order.type === 'delivery'">üõµ</span>
                                    <span v-else>üèÉ</span>
                                    <span class="text-white font-medium text-sm">{{ order.type === 'delivery' ? '–î–æ—Å—Ç–∞–≤–∫–∞' : '–°–∞–º–æ–≤—ã–≤–æ–∑' }}</span>
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <!-- Dropdown -->
                                <Transition name="dropdown">
                                    <div v-if="showOrderTypeDropdown" class="absolute top-full right-0 mt-1 bg-dark-800 rounded-xl border border-dark-700 shadow-xl z-50 overflow-hidden min-w-[160px]">
                                        <button
                                            @click="order.type = 'delivery'; showOrderTypeDropdown = false"
                                            :class="[
                                                'w-full flex items-center gap-3 px-4 py-3 text-left transition-colors',
                                                order.type === 'delivery' ? 'bg-accent/20 text-white' : 'text-gray-300 hover:bg-dark-700'
                                            ]"
                                        >
                                            <span class="text-lg">üõµ</span>
                                            <span class="font-medium">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                                            <svg v-if="order.type === 'delivery'" class="w-4 h-4 ml-auto text-accent" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                        <button
                                            @click="order.type = 'pickup'; showOrderTypeDropdown = false"
                                            :class="[
                                                'w-full flex items-center gap-3 px-4 py-3 text-left transition-colors',
                                                order.type === 'pickup' ? 'bg-green-500/20 text-white' : 'text-gray-300 hover:bg-dark-700'
                                            ]"
                                        >
                                            <span class="text-lg">üèÉ</span>
                                            <span class="font-medium">–°–∞–º–æ–≤—ã–≤–æ–∑</span>
                                            <svg v-if="order.type === 'pickup'" class="w-4 h-4 ml-auto text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </Transition>
                                <!-- Backdrop -->
                                <div v-if="showOrderTypeDropdown" class="fixed inset-0 z-40" @click="showOrderTypeDropdown = false"></div>
                            </div>
                        </div>
                        <!-- Left Panel Content -->
                        <div class="flex-1 overflow-y-auto">
                                <!-- Date & Time Section (TOP) -->
                                <div class="relative p-4 border-b border-dark-800">
                                    <!-- Date + Time buttons row -->
                                    <div class="flex gap-2">
                                        <!-- Date Button -->
                                        <button
                                            @click="showCalendar = !showCalendar; showTimePicker = false"
                                            class="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-medium transition-all bg-dark-800 hover:bg-dark-700"
                                            :class="showCalendar ? 'ring-2 ring-accent' : ''"
                                        >
                                            <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <span class="text-white">{{ displayDate }}</span>
                                            <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </button>

                                        <!-- Time Button -->
                                        <button
                                            @click="showTimePicker = !showTimePicker; showCalendar = false"
                                            class="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-medium transition-all bg-dark-800 hover:bg-dark-700"
                                            :class="[
                                                showTimePicker ? 'ring-2 ring-accent' : '',
                                                requiresTime && !hasValidTime ? 'ring-2 ring-red-500 animate-pulse' : ''
                                            ]"
                                        >
                                            <svg :class="requiresTime && !hasValidTime ? 'text-red-400' : 'text-accent'" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span :class="[
                                                order.is_asap && !requiresTime ? 'text-green-400' : '',
                                                requiresTime && !hasValidTime ? 'text-red-400' : 'text-white'
                                            ]">
                                                {{ requiresTime && !hasValidTime ? '–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è' : displayTime }}
                                            </span>
                                            <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </button>
                                    </div>

                                    <!-- Backdrop for closing overlays -->
                                    <div
                                        v-if="showCalendar || showTimePicker"
                                        class="fixed inset-0 z-40"
                                        @click="showCalendar = false; showTimePicker = false"
                                    ></div>

                                    <!-- Calendar Panel (full width) - OVERLAY -->
                                    <Transition name="popup">
                                        <div v-if="showCalendar" class="absolute left-4 right-4 top-full mt-1 bg-dark-800 rounded-xl p-4 shadow-2xl z-50 border border-dark-700/50" @click.stop>
                                            <!-- Calendar Header -->
                                            <div class="flex items-center justify-between mb-4">
                                                <button
                                                    @click="calendarPrevMonth"
                                                    class="w-9 h-9 flex items-center justify-center rounded-lg text-gray-400 hover:bg-dark-700 hover:text-white transition-colors"
                                                >
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                    </svg>
                                                </button>
                                                <span class="text-white font-semibold">{{ calendarMonthYear }}</span>
                                                <button
                                                    @click="calendarNextMonth"
                                                    class="w-9 h-9 flex items-center justify-center rounded-lg text-gray-400 hover:bg-dark-700 hover:text-white transition-colors"
                                                >
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                    </svg>
                                                </button>
                                            </div>

                                            <!-- Weekdays -->
                                            <div class="grid grid-cols-7 gap-1 mb-2">
                                                <div v-for="day in ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å']" :key="day" class="text-center text-xs text-gray-500 py-1 font-medium">
                                                    {{ day }}
                                                </div>
                                            </div>

                                            <!-- Days Grid -->
                                            <div class="grid grid-cols-7 gap-1">
                                                <button
                                                    v-for="day in calendarDays"
                                                    :key="day.date"
                                                    @click="selectDate(day)"
                                                    :disabled="day.disabled"
                                                    :class="[
                                                        'h-9 rounded-lg text-sm font-medium transition-colors flex items-center justify-center',
                                                        day.isToday && !day.isSelected ? 'ring-2 ring-accent ring-inset' : '',
                                                        day.isSelected ? 'bg-accent text-white' : '',
                                                        day.isCurrentMonth && !day.disabled && !day.isSelected ? 'text-gray-300 hover:bg-dark-700 hover:text-white' : '',
                                                        !day.isCurrentMonth ? 'text-gray-700' : '',
                                                        day.disabled ? 'text-gray-700 cursor-not-allowed' : '',
                                                        day.isWeekend && !day.isSelected && day.isCurrentMonth ? 'text-red-400 hover:text-red-300' : ''
                                                    ]"
                                                >
                                                    {{ day.day }}
                                                </button>
                                            </div>

                                            <!-- Quick Select Buttons -->
                                            <div class="flex gap-2 mt-4 pt-3 border-t border-dark-700">
                                                <button
                                                    @click="selectQuickDate('today')"
                                                    :class="[
                                                        'flex-1 py-2 text-sm rounded-lg font-medium transition-colors',
                                                        isToday(order.scheduled_date) ? 'bg-accent text-white' : 'bg-dark-800 text-gray-400 hover:bg-dark-700 hover:text-white'
                                                    ]"
                                                >
                                                    –°–µ–≥–æ–¥–Ω—è
                                                </button>
                                                <button
                                                    @click="selectQuickDate('tomorrow')"
                                                    :class="[
                                                        'flex-1 py-2 text-sm rounded-lg font-medium transition-colors',
                                                        isTomorrow(order.scheduled_date) ? 'bg-accent text-white' : 'bg-dark-800 text-gray-400 hover:bg-dark-700 hover:text-white'
                                                    ]"
                                                >
                                                    –ó–∞–≤—Ç—Ä–∞
                                                </button>
                                                <button
                                                    @click="selectQuickDate('dayafter')"
                                                    :class="[
                                                        'flex-1 py-2 text-sm rounded-lg font-medium transition-colors',
                                                        isDayAfter(order.scheduled_date) ? 'bg-accent text-white' : 'bg-dark-800 text-gray-400 hover:bg-dark-700 hover:text-white'
                                                    ]"
                                                >
                                                    –ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞
                                                </button>
                                            </div>
                                        </div>
                                    </Transition>

                                    <!-- Time Picker Panel - slides down from time button -->
                                    <Transition name="time-picker">
                                        <div v-if="showTimePicker" class="absolute left-0 right-0 top-full mt-2 bg-dark-800 rounded-2xl p-4 shadow-2xl z-50 border border-dark-700/50 flex flex-col max-h-[70vh]" @click.stop>
                                            <!-- Time Display with Validation -->
                                            <div class="text-center mb-3">
                                                <span :class="[
                                                    'text-4xl font-bold font-mono transition-colors',
                                                    timeValidation.isValid ? 'text-white' : 'text-red-400'
                                                ]">{{ timeInput || '00:00' }}</span>
                                                <p v-if="timeValidation.error" class="text-xs text-red-400 mt-1">
                                                    ‚ö†Ô∏è {{ timeValidation.error }}
                                                </p>
                                                <p v-else class="text-xs text-gray-500 mt-1">‚å®Ô∏è –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç</p>
                                            </div>

                                            <!-- ASAP Button - only for today -->
                                            <button
                                                v-if="!requiresTime"
                                                @click="setAsap"
                                                :class="[
                                                    'w-full py-2.5 rounded-xl text-sm font-medium transition-colors mb-3 flex-shrink-0',
                                                    order.is_asap ? 'bg-green-600 text-white' : 'bg-dark-700 text-gray-400 hover:bg-dark-600 hover:text-white'
                                                ]"
                                            >
                                                ‚ö° –ë–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è
                                            </button>
                                            <!-- Warning for future dates -->
                                            <div v-else class="text-center text-xs text-orange-400 mb-3 py-2 bg-orange-500/10 rounded-lg flex-shrink-0">
                                                –î–ª—è –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞ —É–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è
                                            </div>

                                            <!-- Time Slots Grid - Scrollable -->
                                            <div class="flex-1 overflow-y-auto mb-3 -mx-1 px-1">
                                                <div class="grid grid-cols-4 gap-1.5">
                                                    <button
                                                        v-for="slot in availableTimeSlots"
                                                        :key="slot.time"
                                                        @click="selectQuickTime(slot.time)"
                                                        :disabled="slot.disabled"
                                                        :class="[
                                                            'py-2.5 text-sm rounded-lg font-medium transition-all',
                                                            slot.disabled
                                                                ? 'bg-dark-900/50 text-gray-600 cursor-not-allowed line-through'
                                                                : order.scheduled_time === slot.time && !order.is_asap
                                                                    ? 'bg-accent text-white ring-2 ring-accent/50'
                                                                    : slot.isRecommended
                                                                        ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30'
                                                                        : 'bg-dark-700 text-gray-300 hover:bg-dark-600 hover:text-white'
                                                        ]"
                                                    >
                                                        {{ slot.time }}
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Manual Input Toggle -->
                                            <div class="border-t border-dark-700 pt-3 flex-shrink-0">
                                                <button
                                                    @click="showNumpad = !showNumpad"
                                                    class="w-full text-xs text-gray-500 hover:text-gray-300 transition-colors mb-2"
                                                >
                                                    {{ showNumpad ? '‚ñ≤ –°–∫—Ä—ã—Ç—å numpad' : '‚ñº –†—É—á–Ω–æ–π –≤–≤–æ–¥ (numpad)' }}
                                                </button>

                                                <!-- Numpad (collapsible) -->
                                                <Transition name="slide-fade">
                                                    <div v-if="showNumpad" class="grid grid-cols-3 gap-1.5 max-w-[180px] mx-auto mb-3">
                                                        <button
                                                            v-for="n in [1,2,3,4,5,6,7,8,9]"
                                                            :key="n"
                                                            @click="addTimeDigit(n)"
                                                            class="h-10 rounded-lg bg-dark-700 text-gray-300 hover:bg-dark-600 hover:text-white font-semibold text-lg transition-colors"
                                                        >
                                                            {{ n }}
                                                        </button>
                                                        <button
                                                            @click="clearTime"
                                                            class="h-10 rounded-lg bg-dark-700 text-red-400 hover:bg-dark-600 hover:text-red-300 font-semibold text-sm transition-colors"
                                                        >
                                                            C
                                                        </button>
                                                        <button
                                                            @click="addTimeDigit(0)"
                                                            class="h-10 rounded-lg bg-dark-700 text-gray-300 hover:bg-dark-600 hover:text-white font-semibold text-lg transition-colors"
                                                        >
                                                            0
                                                        </button>
                                                        <button
                                                            @click="backspaceTime"
                                                            class="h-10 rounded-lg bg-dark-700 text-gray-400 hover:bg-dark-600 hover:text-white font-semibold transition-colors flex items-center justify-center"
                                                        >
                                                            ‚å´
                                                        </button>
                                                    </div>
                                                </Transition>

                                                <!-- Confirm Button -->
                                                <button
                                                    @click="confirmTime"
                                                    :disabled="!timeValidation.isValid && timeInput.length > 0"
                                                    :class="[
                                                        'w-full py-2.5 text-sm rounded-xl font-medium transition-colors',
                                                        !timeValidation.isValid && timeInput.length > 0
                                                            ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                                            : 'bg-accent hover:bg-accent/80 text-white'
                                                    ]"
                                                >
                                                    OK
                                                </button>
                                            </div>
                                        </div>
                                    </Transition>
                                </div>

                                <!-- Customer Section -->
                                <div class="p-5 border-b border-dark-800">
                                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">–ö–ª–∏–µ–Ω—Ç</h3>

                                    <!-- Phone -->
                                    <div class="relative mb-3">
                                        <label class="block text-xs text-gray-400 mb-1.5">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                        <div class="relative">
                                            <input
                                                v-model="order.phone"
                                                type="tel"
                                                placeholder="+7 999 123-45-67"
                                                @input="searchCustomer"
                                                class="w-full bg-dark-800 border-0 border-b-2 border-dark-600 rounded-t-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 focus:border-accent focus:outline-none transition-colors"
                                            />
                                            <div v-if="searchingCustomer" class="absolute right-3 top-1/2 -translate-y-1/2">
                                                <div class="w-4 h-4 border-2 border-accent border-t-transparent rounded-full animate-spin"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Found Customer Card -->
                                    <Transition name="slide-fade">
                                        <div v-if="foundCustomer" class="bg-accent/10 border border-accent/30 rounded-xl p-3 mb-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center gap-2">
                                                    <div class="w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center">
                                                        <span class="text-accent text-sm font-medium">{{ foundCustomer.name?.charAt(0) || '?' }}</span>
                                                    </div>
                                                    <div>
                                                        <p class="font-medium text-white text-sm">{{ foundCustomer.name }}</p>
                                                        <p class="text-xs text-gray-400">{{ foundCustomer.orders_count || 0 }} –∑–∞–∫–∞–∑–æ–≤</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <button
                                                @click="useCustomer(foundCustomer)"
                                                class="w-full py-2 bg-accent text-white rounded-lg text-xs font-medium hover:bg-blue-600 transition-colors"
                                            >
                                                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                                            </button>
                                        </div>
                                    </Transition>

                                    <!-- Name -->
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1.5">–ò–º—è</label>
                                        <input
                                            v-model="order.customer_name"
                                            type="text"
                                            placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞"
                                            class="w-full bg-dark-800 border-0 border-b-2 border-dark-600 rounded-t-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 focus:border-accent focus:outline-none transition-colors"
                                        />
                                    </div>
                                </div>

                                <!-- Delivery Address Section -->
                                <div v-if="order.type === 'delivery'" class="p-5 border-b border-dark-800">
                                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>

                                    <!-- Address with autocomplete -->
                                    <div class="mb-3 relative">
                                        <label class="block text-xs text-gray-400 mb-1.5">–£–ª–∏—Ü–∞, –¥–æ–º</label>
                                        <input
                                            v-model="order.address"
                                            type="text"
                                            placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 15"
                                            @focus="showAddressSuggestions = true"
                                            @blur="hideAddressSuggestions"
                                            class="w-full bg-dark-800 border-0 border-b-2 border-dark-600 rounded-t-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 focus:border-accent focus:outline-none transition-colors"
                                        />
                                        <!-- Address suggestions dropdown -->
                                        <Transition name="dropdown">
                                            <div
                                                v-if="showAddressSuggestions && filteredAddresses.length > 0"
                                                class="absolute top-full left-0 right-0 mt-1 bg-dark-800 rounded-xl border border-dark-600 shadow-xl z-10 overflow-hidden"
                                            >
                                                <div class="py-1 max-h-48 overflow-y-auto">
                                                    <button
                                                        v-for="addr in filteredAddresses"
                                                        :key="addr"
                                                        @mousedown.prevent="selectAddress(addr)"
                                                        class="w-full px-3 py-2 text-left text-sm text-gray-300 hover:bg-dark-700 hover:text-white transition-colors flex items-center gap-2"
                                                    >
                                                        <svg class="w-4 h-4 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                        </svg>
                                                        <span class="truncate">{{ addr }}</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </Transition>
                                    </div>

                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1.5">–ü–æ–¥—ä–µ–∑–¥</label>
                                            <input
                                                v-model="order.entrance"
                                                type="text"
                                                placeholder="‚Äî"
                                                class="w-full bg-dark-800 border-0 border-b-2 border-dark-600 rounded-t-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 text-center focus:border-accent focus:outline-none transition-colors"
                                            />
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1.5">–≠—Ç–∞–∂</label>
                                            <input
                                                v-model="order.floor"
                                                type="text"
                                                placeholder="‚Äî"
                                                class="w-full bg-dark-800 border-0 border-b-2 border-dark-600 rounded-t-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 text-center focus:border-accent focus:outline-none transition-colors"
                                            />
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1.5">–ö–≤./–æ—Ñ–∏—Å</label>
                                            <input
                                                v-model="order.apartment"
                                                type="text"
                                                placeholder="‚Äî"
                                                class="w-full bg-dark-800 border-0 border-b-2 border-dark-600 rounded-t-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 text-center focus:border-accent focus:outline-none transition-colors"
                                            />
                                        </div>
                                    </div>

                                    <!-- Delivery Info -->
                                    <Transition name="slide-fade">
                                        <div v-if="deliveryInfo && order.address" class="mt-3 bg-dark-800 rounded-xl p-3">
                                            <div class="flex items-center justify-between text-xs mb-1.5">
                                                <span class="text-gray-400">–ó–æ–Ω–∞</span>
                                                <span class="text-white">{{ deliveryInfo.zone_name || '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è' }}</span>
                                            </div>
                                            <div class="flex items-center justify-between text-xs mb-1.5">
                                                <span class="text-gray-400">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                                                <span :class="deliveryInfo.delivery_fee > 0 ? 'text-white' : 'text-green-400 font-medium'">
                                                    {{ deliveryInfo.delivery_fee > 0 ? deliveryInfo.delivery_fee + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' }}
                                                </span>
                                            </div>
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="text-gray-400">–í—Ä–µ–º—è</span>
                                                <span class="text-white">~{{ deliveryInfo.estimated_time || 45 }} –º–∏–Ω</span>
                                            </div>
                                        </div>
                                    </Transition>
                                </div>

                                <!-- Cart Section -->
                                <div class="p-5 border-b border-dark-800">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">–ö–æ—Ä–∑–∏–Ω–∞</h3>
                                        <span class="text-xs text-gray-500">{{ order.items.length }} –ø–æ–∑.</span>
                                    </div>

                                    <!-- Empty Cart -->
                                    <div v-if="order.items.length === 0" class="text-center py-6">
                                        <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-dark-800 flex items-center justify-center">
                                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                                            </svg>
                                        </div>
                                        <p class="text-gray-500 text-xs">–î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –∏–∑ –º–µ–Ω—é</p>
                                    </div>

                                    <!-- Cart Items -->
                                    <div v-else class="space-y-2 max-h-40 overflow-y-auto">
                                        <TransitionGroup name="cart-item">
                                            <div
                                                v-for="(item, index) in order.items"
                                                :key="item.id"
                                                class="bg-dark-800 rounded-lg p-2.5 flex items-center gap-2"
                                            >
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-white text-sm font-medium truncate">{{ item.name }}</p>
                                                    <p class="text-gray-400 text-xs">{{ formatPrice(item.price) }} ‚ÇΩ</p>
                                                </div>
                                                <div class="flex items-center gap-1 bg-dark-700 rounded-lg p-0.5">
                                                    <button
                                                        @click="item.quantity > 1 ? item.quantity-- : removeItem(index)"
                                                        class="w-6 h-6 rounded flex items-center justify-center text-gray-400 hover:text-white hover:bg-dark-600 transition-all"
                                                    >
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                                        </svg>
                                                    </button>
                                                    <span class="w-6 text-center text-white text-sm font-medium">{{ item.quantity }}</span>
                                                    <button
                                                        @click="item.quantity++"
                                                        class="w-6 h-6 rounded flex items-center justify-center text-gray-400 hover:text-white hover:bg-dark-600 transition-all"
                                                    >
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                        </svg>
                                                    </button>
                                                </div>
                                                <span class="text-white text-sm font-semibold w-16 text-right">{{ formatPrice(item.price * item.quantity) }} ‚ÇΩ</span>
                                            </div>
                                        </TransitionGroup>
                                    </div>

                                    <!-- Promo Code -->
                                    <div class="mt-3">
                                        <div class="flex gap-2">
                                            <input
                                                v-model="order.promo_code"
                                                type="text"
                                                placeholder="–ü—Ä–æ–º–æ–∫–æ–¥"
                                                class="flex-1 bg-dark-800 border-0 border-b-2 border-dark-600 rounded-t-lg px-3 py-2 text-white text-sm placeholder-gray-600 focus:border-accent focus:outline-none transition-colors"
                                            />
                                            <button
                                                @click="applyPromoCode"
                                                :disabled="!order.promo_code || applyingPromo"
                                                class="px-4 py-2 bg-dark-800 hover:bg-dark-700 rounded-lg text-gray-400 hover:text-white text-sm transition-all disabled:opacity-50"
                                            >
                                                {{ applyingPromo ? '...' : 'OK' }}
                                            </button>
                                        </div>
                                        <Transition name="slide-fade">
                                            <div v-if="promoDiscount" class="mt-2 flex items-center gap-2 text-green-400">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                                </svg>
                                                <span class="text-xs">–°–∫–∏–¥–∫–∞: -{{ formatPrice(promoDiscount) }} ‚ÇΩ</span>
                                            </div>
                                        </Transition>
                                    </div>
                                </div>

                                <!-- Comment -->
                                <div class="p-5">
                                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
                                    <textarea
                                        v-model="order.comment"
                                        placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É..."
                                        rows="2"
                                        class="w-full bg-dark-800 border-0 border-b-2 border-dark-600 rounded-t-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 focus:border-accent focus:outline-none resize-none transition-colors"
                                    ></textarea>
                                </div>
                            </div>

                            <!-- Footer - Totals & Submit -->
                            <div class="p-4 border-t border-dark-700 bg-dark-900">
                                <!-- Totals -->
                                <div class="space-y-1.5 mb-4">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-gray-400">–¢–æ–≤–∞—Ä—ã</span>
                                        <span class="text-white">{{ formatPrice(subtotal) }} ‚ÇΩ</span>
                                    </div>
                                    <Transition name="slide-fade">
                                        <div v-if="promoDiscount" class="flex justify-between text-xs text-green-400">
                                            <span>–°–∫–∏–¥–∫–∞</span>
                                            <span>-{{ formatPrice(promoDiscount) }} ‚ÇΩ</span>
                                        </div>
                                    </Transition>
                                    <div v-if="order.type === 'delivery'" class="flex justify-between text-xs">
                                        <span class="text-gray-400">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                                        <span :class="deliveryFee > 0 ? 'text-white' : 'text-green-400'">
                                            {{ deliveryFee > 0 ? formatPrice(deliveryFee) + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between text-base font-bold pt-2 border-t border-dark-700">
                                        <span class="text-gray-300">–ò—Ç–æ–≥–æ</span>
                                        <span class="text-white">{{ formatPrice(total) }} ‚ÇΩ</span>
                                    </div>
                                </div>

                                <!-- Payment Method -->
                                <div class="grid grid-cols-3 gap-1.5 mb-4">
                                    <button
                                        @click="order.payment_method = 'cash'"
                                        :class="[
                                            'flex flex-col items-center gap-0.5 py-2 rounded-lg text-xs font-medium transition-all',
                                            order.payment_method === 'cash'
                                                ? 'bg-accent text-white shadow-lg'
                                                : 'bg-dark-800 text-gray-400 hover:text-white'
                                        ]"
                                    >
                                        <span>üíµ</span>
                                        <span>–ù–∞–ª–∏—á–Ω—ã–µ</span>
                                    </button>
                                    <button
                                        @click="order.payment_method = 'card'"
                                        :class="[
                                            'flex flex-col items-center gap-0.5 py-2 rounded-lg text-xs font-medium transition-all',
                                            order.payment_method === 'card'
                                                ? 'bg-accent text-white shadow-lg'
                                                : 'bg-dark-800 text-gray-400 hover:text-white'
                                        ]"
                                    >
                                        <span>üí≥</span>
                                        <span>–ö–∞—Ä—Ç–∞</span>
                                    </button>
                                    <button
                                        @click="order.payment_method = 'online'"
                                        :class="[
                                            'flex flex-col items-center gap-0.5 py-2 rounded-lg text-xs font-medium transition-all',
                                            order.payment_method === 'online'
                                                ? 'bg-accent text-white shadow-lg'
                                                : 'bg-dark-800 text-gray-400 hover:text-white'
                                        ]"
                                    >
                                        <span>üì±</span>
                                        <span>–û–Ω–ª–∞–π–Ω</span>
                                    </button>
                                </div>

                                <!-- Quick change buttons (for cash) -->
                                <Transition name="slide-fade">
                                    <div v-if="order.payment_method === 'cash'" class="mb-4">
                                        <label class="block text-xs text-gray-400 mb-2">–°–¥–∞—á–∞ —Å</label>
                                        <div class="flex gap-1.5 flex-wrap">
                                            <button
                                                @click="order.change_from = null"
                                                :class="[
                                                    'px-3 py-1.5 rounded-lg text-xs font-medium transition-all',
                                                    order.change_from === null
                                                        ? 'bg-green-600 text-white'
                                                        : 'bg-dark-800 text-gray-400 hover:text-white'
                                                ]"
                                            >
                                                –ë–µ–∑ —Å–¥–∞—á–∏
                                            </button>
                                            <button
                                                v-for="amount in changeAmounts"
                                                :key="amount"
                                                @click="order.change_from = amount"
                                                :class="[
                                                    'px-3 py-1.5 rounded-lg text-xs font-medium transition-all',
                                                    order.change_from === amount
                                                        ? 'bg-accent text-white'
                                                        : 'bg-dark-800 text-gray-400 hover:text-white'
                                                ]"
                                            >
                                                {{ amount }}
                                            </button>
                                        </div>
                                        <p v-if="order.change_from && order.change_from > total" class="text-xs text-green-400 mt-2">
                                            –°–¥–∞—á–∞: {{ formatPrice(order.change_from - total) }} ‚ÇΩ
                                        </p>
                                    </div>
                                </Transition>

                                <!-- Submit Button -->
                                <button
                                    @click="createOrder"
                                    :disabled="!canCreate || creating"
                                    :class="[
                                        'w-full py-3.5 rounded-xl text-white font-semibold transition-all',
                                        canCreate && !creating
                                            ? 'bg-gradient-to-r from-accent to-blue-600 hover:from-blue-600 hover:to-accent shadow-lg shadow-accent/30'
                                            : 'bg-dark-700 text-gray-500 cursor-not-allowed'
                                    ]"
                                >
                                    <span v-if="creating" class="flex items-center justify-center gap-2">
                                        <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                        –°–æ–∑–¥–∞–Ω–∏–µ...
                                    </span>
                                    <span v-else>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ‚Äî {{ formatPrice(total) }} ‚ÇΩ</span>
                                </button>
                            </div>
                        </div>

                    <!-- Right Panel - Menu -->
                    <div class="flex-1 flex flex-col bg-dark-900">
                            <!-- Search & Categories -->
                            <div class="px-4 py-3 border-b border-dark-700">
                                <div class="relative mb-3">
                                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                    <input
                                        v-model="dishSearch"
                                        type="text"
                                        placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥–∞..."
                                        class="w-full bg-dark-800 border-0 rounded-lg pl-9 pr-4 py-2.5 text-white text-sm placeholder-gray-500 focus:ring-2 focus:ring-accent focus:outline-none transition-all"
                                    />
                                </div>

                                <!-- Categories -->
                                <div class="flex gap-1.5 overflow-x-auto pb-1 scrollbar-hide">
                                    <button
                                        @click="selectedCategory = null"
                                        :class="[
                                            'px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-all',
                                            selectedCategory === null
                                                ? 'bg-accent text-white shadow-lg'
                                                : 'bg-dark-800 text-gray-400 hover:text-white'
                                        ]"
                                    >
                                        –í—Å–µ
                                    </button>
                                    <button
                                        v-for="category in categories"
                                        :key="category.id"
                                        @click="selectedCategory = category.id"
                                        :class="[
                                            'px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-all',
                                            selectedCategory === category.id
                                                ? 'bg-accent text-white shadow-lg'
                                                : 'bg-dark-800 text-gray-400 hover:text-white'
                                        ]"
                                    >
                                        {{ category.name }}
                                    </button>
                                </div>
                            </div>

                            <!-- Dishes Grid - Compact -->
                            <div class="flex-1 overflow-y-auto p-3">
                                <div class="grid grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-2">
                                    <div
                                        v-for="dish in filteredDishes"
                                        :key="dish.id"
                                        @click="addDish(dish)"
                                        class="group bg-dark-800 rounded-xl overflow-hidden cursor-pointer hover:ring-2 hover:ring-accent/50 transition-all hover:scale-[1.02] relative"
                                    >
                                        <!-- Image - Compact -->
                                        <div class="aspect-square bg-dark-700 relative overflow-hidden">
                                            <img
                                                v-if="dish.image"
                                                :src="dish.image"
                                                :alt="dish.name"
                                                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                                            />
                                            <div v-else class="w-full h-full flex items-center justify-center text-2xl text-gray-600">
                                                üçΩÔ∏è
                                            </div>
                                            <!-- Cart indicator -->
                                            <div
                                                v-if="getItemQuantity(dish.id) > 0"
                                                class="absolute top-1.5 left-1.5 w-6 h-6 bg-green-500 rounded-full text-white text-xs font-bold shadow-lg flex items-center justify-center"
                                            >
                                                {{ getItemQuantity(dish.id) }}
                                            </div>
                                            <!-- Quick add overlay -->
                                            <div class="absolute inset-0 bg-accent/80 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                </svg>
                                            </div>
                                        </div>
                                        <!-- Info - Compact -->
                                        <div class="p-2">
                                            <h3 class="text-xs font-medium text-white mb-1 line-clamp-2 leading-tight min-h-[2rem]">{{ dish.name }}</h3>
                                            <span class="text-sm font-bold text-white">{{ formatPrice(dish.price) }} <span class="text-xs text-gray-400">‚ÇΩ</span></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Empty dishes -->
                                <div v-if="filteredDishes.length === 0" class="flex flex-col items-center justify-center h-64 text-gray-500">
                                    <div class="w-16 h-16 rounded-2xl bg-dark-800 flex items-center justify-center mb-4">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                    <p class="text-sm">–ë–ª—é–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </Transition>
    </Teleport>
</template>

<script setup>
import { ref, reactive, computed, watch, onMounted, onUnmounted } from 'vue';
import api from '../../api';

const props = defineProps({
    show: {
        type: Boolean,
        default: false
    }
});

const emit = defineEmits(['close', 'created']);

// Data
const dishes = ref([]);
const categories = ref([]);
const dishSearch = ref('');
const selectedCategory = ref(null);

// Order type dropdown
const showOrderTypeDropdown = ref(false);

// Customer search
const searchingCustomer = ref(false);
const foundCustomer = ref(null);
let searchTimeout = null;

// Address suggestions
const showAddressSuggestions = ref(false);
const recentAddresses = ref([]);

// Calendar & Time picker
const showCalendar = ref(false);
const showTimePicker = ref(false);
const calendarDate = ref(new Date());
const timeInput = ref('');
const showNumpad = ref(false);

// Restaurant working hours (can be fetched from settings)
const WORKING_HOURS = { start: 10, end: 23 };
const MIN_PREP_TIME = 30; // minimum preparation time in minutes

// Keyboard handler for time picker
const handleTimeKeydown = (e) => {
    if (!showTimePicker.value) return;

    // Handle numeric keys (both main keyboard and numpad)
    if ((e.key >= '0' && e.key <= '9')) {
        e.preventDefault();
        addTimeDigit(parseInt(e.key));
    }
    // Handle Backspace
    else if (e.key === 'Backspace') {
        e.preventDefault();
        backspaceTime();
    }
    // Handle Delete - clear all
    else if (e.key === 'Delete') {
        e.preventDefault();
        clearTime();
    }
    // Handle Enter - confirm
    else if (e.key === 'Enter') {
        e.preventDefault();
        confirmTime();
    }
    // Handle Escape - close
    else if (e.key === 'Escape') {
        e.preventDefault();
        showTimePicker.value = false;
    }
};

// Promo
const applyingPromo = ref(false);
const promoDiscount = ref(0);

// Order creation
const creating = ref(false);

// Delivery info
const deliveryInfo = ref(null);

// Quick change amounts
const changeAmounts = [500, 1000, 2000, 5000];

// Date helper (defined early for use in reactive initialization)
const formatDateForInput = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

// Order form
const order = reactive({
    type: 'delivery',
    phone: '',
    customer_name: '',
    address: '',
    entrance: '',
    floor: '',
    apartment: '',
    is_asap: true,
    scheduled_date: formatDateForInput(new Date()), // Default to today
    scheduled_time: '',
    items: [],
    promo_code: '',
    payment_method: 'cash',
    change_from: null,
    comment: ''
});

// Computed
const filteredDishes = computed(() => {
    let result = dishes.value;

    if (selectedCategory.value) {
        result = result.filter(d => d.category_id === selectedCategory.value);
    }

    if (dishSearch.value) {
        const q = dishSearch.value.toLowerCase();
        result = result.filter(d => d.name.toLowerCase().includes(q));
    }

    return result;
});

const filteredAddresses = computed(() => {
    if (!order.address) return recentAddresses.value.slice(0, 5);
    const q = order.address.toLowerCase();
    return recentAddresses.value
        .filter(addr => addr.toLowerCase().includes(q))
        .slice(0, 5);
});

const subtotal = computed(() => {
    return order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
});

const deliveryFee = computed(() => {
    if (order.type !== 'delivery') return 0;
    return deliveryInfo.value?.delivery_fee || 0;
});

const total = computed(() => {
    return subtotal.value - promoDiscount.value + deliveryFee.value;
});

// Check if time is required (for dates other than today)
const requiresTime = computed(() => {
    if (!order.scheduled_date) return false;
    const today = formatDateForInput(new Date());
    return order.scheduled_date !== today;
});

// Check if time is valid when required
const hasValidTime = computed(() => {
    if (!requiresTime.value) return true; // Today doesn't require time
    if (order.is_asap) return false; // ASAP not allowed for future dates
    return order.scheduled_time && order.scheduled_time.length >= 4; // Has time like "12:00"
});

// Time validation for current input
const timeValidation = computed(() => {
    if (!timeInput.value || timeInput.value.length < 4) {
        return { isValid: true, error: null }; // Not enough digits yet
    }

    const raw = timeInput.value.replace(':', '');
    if (raw.length < 4) {
        return { isValid: true, error: null };
    }

    const hours = parseInt(raw.slice(0, 2));
    const minutes = parseInt(raw.slice(2, 4));

    // Basic format validation
    if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
        return { isValid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è' };
    }

    // Check working hours
    if (hours < WORKING_HOURS.start || hours >= WORKING_HOURS.end) {
        return { isValid: false, error: `–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å ${WORKING_HOURS.start}:00 –¥–æ ${WORKING_HOURS.end}:00` };
    }

    // For today, check if time is not in the past
    const today = formatDateForInput(new Date());
    if (order.scheduled_date === today) {
        const now = new Date();
        const selectedTime = hours * 60 + minutes;
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const minAllowedTime = currentTime + MIN_PREP_TIME;

        if (selectedTime < minAllowedTime) {
            const minHours = Math.floor(minAllowedTime / 60);
            const minMins = minAllowedTime % 60;
            return {
                isValid: false,
                error: `–ú–∏–Ω–∏–º—É–º —á–µ—Ä–µ–∑ ${MIN_PREP_TIME} –º–∏–Ω (–æ—Ç ${minHours}:${minMins.toString().padStart(2, '0')})`
            };
        }
    }

    return { isValid: true, error: null };
});

// Generate available time slots
const availableTimeSlots = computed(() => {
    const slots = [];
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const isToday = order.scheduled_date === formatDateForInput(now);

    // Find the nearest recommended slot (next 30 min interval + prep time)
    let recommendedSlot = null;
    if (isToday) {
        const nextSlotMinutes = Math.ceil((currentMinutes + MIN_PREP_TIME) / 30) * 30;
        const recHours = Math.floor(nextSlotMinutes / 60);
        const recMins = nextSlotMinutes % 60;
        if (recHours < WORKING_HOURS.end) {
            recommendedSlot = `${recHours.toString().padStart(2, '0')}:${recMins.toString().padStart(2, '0')}`;
        }
    }

    // Generate slots every 30 minutes
    for (let h = WORKING_HOURS.start; h < WORKING_HOURS.end; h++) {
        for (let m = 0; m < 60; m += 30) {
            const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            const slotMinutes = h * 60 + m;

            // Check if slot is in the past (for today)
            let disabled = false;
            if (isToday) {
                disabled = slotMinutes < currentMinutes + MIN_PREP_TIME;
            }

            slots.push({
                time,
                disabled,
                isRecommended: time === recommendedSlot
            });
        }
    }

    return slots;
});

const canCreate = computed(() => {
    return order.phone?.trim() &&
           order.customer_name?.trim() &&
           order.items.length > 0 &&
           (order.type === 'pickup' || order.address?.trim()) &&
           hasValidTime.value; // Time must be valid when required
});

// Display computed for date/time buttons
const displayDate = computed(() => {
    if (!order.scheduled_date) {
        return '–°–µ–≥–æ–¥–Ω—è';
    }
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dayAfter = new Date(today);
    dayAfter.setDate(dayAfter.getDate() + 2);

    if (order.scheduled_date === formatDateForInput(today)) {
        return '–°–µ–≥–æ–¥–Ω—è';
    }
    if (order.scheduled_date === formatDateForInput(tomorrow)) {
        return '–ó–∞–≤—Ç—Ä–∞';
    }
    if (order.scheduled_date === formatDateForInput(dayAfter)) {
        return '–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞';
    }

    const date = new Date(order.scheduled_date);
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
});

const displayTime = computed(() => {
    if (order.is_asap) {
        return '–ë–ª–∏–∂–∞–π—à–µ–µ';
    }
    return order.scheduled_time || '–ë–ª–∏–∂–∞–π—à–µ–µ';
});

// Calendar computed
const calendarMonthYear = computed(() => {
    const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                    '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
    return `${months[calendarDate.value.getMonth()]} ${calendarDate.value.getFullYear()}`;
});

const calendarDays = computed(() => {
    const year = calendarDate.value.getFullYear();
    const month = calendarDate.value.getMonth();
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    // Get the day of week for first day (Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6;

    const days = [];

    // Previous month days
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = startDay - 1; i >= 0; i--) {
        const date = new Date(year, month - 1, prevMonthLastDay - i);
        days.push({
            day: prevMonthLastDay - i,
            date: date.toISOString(),
            isCurrentMonth: false,
            isToday: false,
            isSelected: false,
            isWeekend: date.getDay() === 0 || date.getDay() === 6,
            disabled: true
        });
    }

    // Current month days
    for (let i = 1; i <= lastDay.getDate(); i++) {
        const date = new Date(year, month, i);
        const dateStr = formatDateForInput(date);
        const isPast = date < today;
        days.push({
            day: i,
            date: dateStr,
            isCurrentMonth: true,
            isToday: date.getTime() === today.getTime(),
            isSelected: order.scheduled_date === dateStr,
            isWeekend: date.getDay() === 0 || date.getDay() === 6,
            disabled: isPast
        });
    }

    // Next month days to fill the grid
    const remaining = 42 - days.length;
    for (let i = 1; i <= remaining; i++) {
        const date = new Date(year, month + 1, i);
        days.push({
            day: i,
            date: date.toISOString(),
            isCurrentMonth: false,
            isToday: false,
            isSelected: false,
            isWeekend: date.getDay() === 0 || date.getDay() === 6,
            disabled: true
        });
    }

    return days;
});

// Methods
const close = () => {
    emit('close');
};

const formatPrice = (price) => {
    return Number(price || 0).toLocaleString('ru-RU');
};

// Date/Time helpers
const formatDisplayDate = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    if (formatDateForInput(date) === formatDateForInput(today)) {
        return '–°–µ–≥–æ–¥–Ω—è';
    }
    if (formatDateForInput(date) === formatDateForInput(tomorrow)) {
        return '–ó–∞–≤—Ç—Ä–∞';
    }

    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
};

// Calendar methods
const calendarPrevMonth = () => {
    const newDate = new Date(calendarDate.value);
    newDate.setMonth(newDate.getMonth() - 1);
    calendarDate.value = newDate;
};

const calendarNextMonth = () => {
    const newDate = new Date(calendarDate.value);
    newDate.setMonth(newDate.getMonth() + 1);
    calendarDate.value = newDate;
};

const selectDate = (day) => {
    if (day.disabled || !day.isCurrentMonth) return;
    order.scheduled_date = day.date;
    showCalendar.value = false;
};

const selectQuickDate = (type) => {
    const date = new Date();
    if (type === 'tomorrow') {
        date.setDate(date.getDate() + 1);
    } else if (type === 'dayafter') {
        date.setDate(date.getDate() + 2);
    }
    order.scheduled_date = formatDateForInput(date);
    showCalendar.value = false;
};

// Date check helpers
const isToday = (dateStr) => {
    if (!dateStr) return true; // default is today
    return dateStr === formatDateForInput(new Date());
};

const isTomorrow = (dateStr) => {
    if (!dateStr) return false;
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    return dateStr === formatDateForInput(tomorrow);
};

const isDayAfter = (dateStr) => {
    if (!dateStr) return false;
    const dayAfter = new Date();
    dayAfter.setDate(dayAfter.getDate() + 2);
    return dateStr === formatDateForInput(dayAfter);
};

// Set ASAP mode
const setAsap = () => {
    order.is_asap = true;
    order.scheduled_time = '';
    timeInput.value = '';
    showTimePicker.value = false;
};

// Time picker methods
const addTimeDigit = (digit) => {
    const raw = timeInput.value.replace(':', '');
    if (raw.length >= 4) return;

    const newRaw = raw + digit;
    timeInput.value = formatTimeInput(newRaw);
};

const formatTimeInput = (raw) => {
    if (raw.length <= 2) return raw;
    return raw.slice(0, 2) + ':' + raw.slice(2);
};

const clearTime = () => {
    timeInput.value = '';
};

const backspaceTime = () => {
    const raw = timeInput.value.replace(':', '');
    timeInput.value = formatTimeInput(raw.slice(0, -1));
};

const selectQuickTime = (time) => {
    timeInput.value = time;
    order.scheduled_time = time;
    order.is_asap = false;
    showTimePicker.value = false;
};

const confirmTime = () => {
    const raw = timeInput.value.replace(':', '');

    // If no time entered, set as ASAP
    if (!raw || raw.length === 0) {
        setAsap();
        return;
    }

    // Pad with zeros if needed
    if (raw.length < 4) {
        const padded = raw.padEnd(4, '0');
        timeInput.value = padded.slice(0, 2) + ':' + padded.slice(2);
    }

    // Validate time
    const [hours, minutes] = timeInput.value.split(':').map(Number);
    if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
        order.scheduled_time = timeInput.value;
        order.is_asap = false;
        showTimePicker.value = false;
    } else {
        window.$toast?.('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è', 'error');
    }
};

const getItemQuantity = (dishId) => {
    const item = order.items.find(i => i.id === dishId);
    return item ? item.quantity : 0;
};

const loadDishes = async () => {
    try {
        const response = await api.menu.getDishes();
        dishes.value = Array.isArray(response) ? response : (response.data || []);

        // Extract categories
        const cats = {};
        dishes.value.forEach(d => {
            if (d.category && !cats[d.category.id]) {
                cats[d.category.id] = d.category;
            }
        });
        categories.value = Object.values(cats);
    } catch (error) {
        console.error('Failed to load dishes:', error);
    }
};

const loadRecentAddresses = async () => {
    try {
        // Try to get from API
        const response = await api.delivery?.getRecentAddresses?.();
        if (response?.data) {
            recentAddresses.value = response.data;
        } else {
            // Fallback to localStorage
            const stored = localStorage.getItem('recent_delivery_addresses');
            if (stored) {
                recentAddresses.value = JSON.parse(stored);
            }
        }
    } catch (e) {
        // Fallback to localStorage
        const stored = localStorage.getItem('recent_delivery_addresses');
        if (stored) {
            try {
                recentAddresses.value = JSON.parse(stored);
            } catch (e) {
                recentAddresses.value = [];
            }
        }
    }
};

const saveAddressToRecent = (address) => {
    if (!address) return;

    // Remove if already exists
    const filtered = recentAddresses.value.filter(a => a !== address);
    // Add to beginning
    filtered.unshift(address);
    // Keep only last 20
    recentAddresses.value = filtered.slice(0, 20);
    // Save to localStorage
    localStorage.setItem('recent_delivery_addresses', JSON.stringify(recentAddresses.value));
};

const selectAddress = (address) => {
    order.address = address;
    showAddressSuggestions.value = false;
};

const hideAddressSuggestions = () => {
    // Delay to allow click on suggestion
    setTimeout(() => {
        showAddressSuggestions.value = false;
    }, 200);
};

const searchCustomer = () => {
    if (searchTimeout) clearTimeout(searchTimeout);

    if (order.phone.length < 5) {
        foundCustomer.value = null;
        return;
    }

    searchTimeout = setTimeout(async () => {
        searchingCustomer.value = true;
        try {
            const response = await api.customers?.search?.(order.phone);
            if (response?.data?.length > 0) {
                foundCustomer.value = response.data[0];
            } else {
                foundCustomer.value = null;
            }
        } catch (e) {
            foundCustomer.value = null;
        } finally {
            searchingCustomer.value = false;
        }
    }, 500);
};

const useCustomer = (customer) => {
    order.customer_name = customer.name;
    order.phone = customer.phone;
    if (customer.last_address) {
        order.address = customer.last_address;
    }
    foundCustomer.value = null;
};

const addDish = (dish) => {
    const existing = order.items.find(i => i.id === dish.id);
    if (existing) {
        existing.quantity++;
    } else {
        order.items.push({
            id: dish.id,
            name: dish.name,
            price: dish.price,
            quantity: 1
        });
    }
};

const removeItem = (index) => {
    order.items.splice(index, 1);
};

const applyPromoCode = async () => {
    if (!order.promo_code) return;

    applyingPromo.value = true;
    try {
        const response = await api.loyalty?.checkPromoCode?.(order.promo_code, subtotal.value);
        if (response?.discount) {
            promoDiscount.value = response.discount;
            window.$toast?.('–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω', 'success');
        } else {
            window.$toast?.('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω', 'error');
        }
    } catch (e) {
        window.$toast?.('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω', 'error');
    } finally {
        applyingPromo.value = false;
    }
};

const calculateDelivery = async () => {
    if (order.type !== 'delivery' || !order.address) {
        deliveryInfo.value = null;
        return;
    }

    try {
        const response = await api.delivery?.calculateDelivery?.({
            address: order.address,
            total: subtotal.value
        });
        deliveryInfo.value = response?.data || response || {
            zone_name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è',
            delivery_fee: subtotal.value >= 1500 ? 0 : 200,
            estimated_time: 45
        };
    } catch (e) {
        // Fallback delivery info
        deliveryInfo.value = {
            zone_name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è',
            delivery_fee: subtotal.value >= 1500 ? 0 : 200,
            estimated_time: 45
        };
    }
};

const createOrder = async () => {
    if (!canCreate.value) return;

    creating.value = true;
    try {
        const fullAddress = order.type === 'delivery'
            ? [
                order.address,
                order.entrance ? `–ø–æ–¥—ä–µ–∑–¥ ${order.entrance}` : '',
                order.floor ? `—ç—Ç–∞–∂ ${order.floor}` : '',
                order.apartment ? `–∫–≤. ${order.apartment}` : ''
              ].filter(Boolean).join(', ')
            : null;

        // Save address to recent
        if (order.type === 'delivery' && order.address) {
            saveAddressToRecent(order.address);
        }

        const orderData = {
            customer_name: order.customer_name,
            phone: order.phone,
            delivery_address: fullAddress,
            notes: order.comment,
            payment_method: order.payment_method,
            is_asap: order.is_asap,
            scheduled_at: order.scheduled_date
                ? `${order.scheduled_date} ${order.scheduled_time || '00:00'}:00`
                : null,
            items: order.items.map(item => ({
                dish_id: item.id,
                quantity: item.quantity
            })),
            promo_code: order.promo_code || null,
            change_from: order.payment_method === 'cash' ? order.change_from : null
        };

        if (order.type === 'pickup') {
            await api.orders.create({
                type: 'pickup',
                phone: order.phone,
                customer_name: order.customer_name,
                notes: order.comment,
                payment_method: order.payment_method,
                is_asap: order.is_asap,
                scheduled_at: order.scheduled_date
                    ? `${order.scheduled_date} ${order.scheduled_time || '00:00'}:00`
                    : null,
                items: orderData.items
            });
        } else {
            await api.orders.createDelivery(orderData);
        }

        window.$toast?.('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω', 'success');
        emit('created');
        close();
    } catch (error) {
        console.error('Failed to create order:', error);
        const message = error.response?.data?.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞';
        window.$toast?.(message, 'error');
    } finally {
        creating.value = false;
    }
};

// Watchers
// Keyboard event listener for time picker
watch(showTimePicker, (val) => {
    if (val) {
        window.addEventListener('keydown', handleTimeKeydown);
    } else {
        window.removeEventListener('keydown', handleTimeKeydown);
    }
});

watch(() => order.address, () => {
    calculateDelivery();
});

watch(() => subtotal.value, () => {
    if (order.type === 'delivery') {
        calculateDelivery();
    }
});

watch(() => props.show, (val) => {
    if (val) {
        // Reset form
        order.type = 'delivery';
        order.phone = '';
        order.customer_name = '';
        order.address = '';
        order.entrance = '';
        order.floor = '';
        order.apartment = '';
        order.is_asap = true;
        order.scheduled_date = formatDateForInput(new Date()); // Reset to today
        order.scheduled_time = '';
        order.items = [];
        order.promo_code = '';
        order.payment_method = 'cash';
        order.change_from = null;
        order.comment = '';
        promoDiscount.value = 0;
        foundCustomer.value = null;
        deliveryInfo.value = null;
        dishSearch.value = '';
        selectedCategory.value = null;
        showOrderTypeDropdown.value = false;
        showAddressSuggestions.value = false;
        showCalendar.value = false;
        showTimePicker.value = false;
        calendarDate.value = new Date();
        timeInput.value = '';
        showNumpad.value = false;

        loadDishes();
        loadRecentAddresses();
    }
});

onMounted(() => {
    if (props.show) {
        loadDishes();
        loadRecentAddresses();
    }
});

onUnmounted(() => {
    window.removeEventListener('keydown', handleTimeKeydown);
});
</script>

<style scoped>
/* Modal transition */
.modal-enter-active {
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.modal-leave-active {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal-enter-from {
    opacity: 0;
    transform: scale(0.95);
}

.modal-leave-to {
    opacity: 0;
    transform: scale(0.98);
}

/* Slide fade transition */
.slide-fade-enter-active {
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.slide-fade-leave-active {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.slide-fade-enter-from,
.slide-fade-leave-to {
    opacity: 0;
    transform: translateY(-10px);
}

/* Dropdown transition */
.dropdown-enter-active {
    transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
}

.dropdown-leave-active {
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.dropdown-enter-from,
.dropdown-leave-to {
    opacity: 0;
    transform: translateY(-5px);
}

/* Popup transition (calendar) */
.popup-enter-active {
    transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
}

.popup-leave-active {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.popup-enter-from,
.popup-leave-to {
    opacity: 0;
    transform: translateY(10px) scale(0.95);
}

/* Time picker transition - smooth expand */
.time-picker-enter-active {
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.time-picker-leave-active {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.time-picker-enter-from {
    opacity: 0;
    transform: translateY(-10px) scaleY(0.8);
    transform-origin: top center;
}

.time-picker-leave-to {
    opacity: 0;
    transform: translateY(-5px) scaleY(0.95);
    transform-origin: top center;
}

/* Cart item transition */
.cart-item-enter-active {
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.cart-item-leave-active {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.cart-item-enter-from {
    opacity: 0;
    transform: translateX(-20px);
}

.cart-item-leave-to {
    opacity: 0;
    transform: translateX(20px);
}

/* Scrollbar */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

/* Custom scrollbar for main areas */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background-color: rgba(75, 85, 99, 0.5);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background-color: rgba(75, 85, 99, 0.7);
}

/* Line clamp */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
