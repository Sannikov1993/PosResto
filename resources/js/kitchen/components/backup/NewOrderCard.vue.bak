<template>
    <div :class="[
        'border-2 rounded-xl sm:rounded-2xl slide-in',
        compact ? 'p-2 sm:p-3' : 'p-3 sm:p-4',
        urgencyClass,
        order.isNew ? 'shake' : ''
    ]">
        <!-- Urgency indicator bar -->
        <div v-if="waitMinutes >= 5" :class="['h-1 sm:h-1.5 -mx-2 sm:-mx-3 -mt-2 sm:-mt-3 mb-2 sm:mb-3 rounded-t-xl', compact ? '' : 'lg:-mx-4 lg:-mt-4', urgencyBarClass]"></div>

        <!-- COMPACT MODE -->
        <template v-if="compact">
            <div class="flex items-center justify-between gap-2 sm:gap-3">
                <!-- Order number & type -->
                <div class="flex items-center gap-2 sm:gap-3">
                    <p :class="['text-2xl sm:text-3xl font-black whitespace-nowrap', urgencyTextClass]">#{{ order.order_number }}</p>
                    <span class="text-xl sm:text-2xl">{{ getTypeIcon(order.type) }}</span>
                    <span v-if="order.table" class="text-base sm:text-lg text-gray-400">
                        –°—Ç–æ–ª {{ order.table.number }}
                    </span>
                </div>
                <!-- Items count & wait time -->
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="bg-gray-700 px-2 sm:px-3 py-0.5 sm:py-1 rounded-lg">
                        <span class="text-xl sm:text-2xl font-bold text-white">{{ order.items.length }}</span>
                        <span class="text-gray-400 ml-1 text-sm sm:text-base">–ø–æ–∑.</span>
                    </div>
                    <p :class="['text-lg sm:text-xl font-bold', waitTimeClass]">{{ getWaitTime(order.created_at) }}</p>
                </div>
            </div>
            <!-- Compact items preview -->
            <div class="mt-2 flex flex-wrap gap-1.5 sm:gap-2">
                <span v-for="item in order.items.slice(0, 4)" :key="item.id"
                      class="bg-gray-700 px-2 sm:px-3 py-0.5 sm:py-1 rounded-lg text-base sm:text-lg flex items-center gap-1.5 sm:gap-2">
                    <span class="text-lg sm:text-xl">{{ getCategoryIcon(item.dish?.category?.name) }}</span>
                    <span :class="['font-bold', quantityBadgeClass.replace('bg-', 'text-')]">{{ item.quantity }}√ó</span>
                    <span class="text-gray-200 truncate max-w-24 sm:max-w-32">{{ item.name }}</span>
                </span>
                <span v-if="order.items.length > 4" class="bg-gray-600 px-2 sm:px-3 py-0.5 sm:py-1 rounded-lg text-base sm:text-lg text-gray-300">
                    +{{ order.items.length - 4 }}
                </span>
            </div>
            <!-- Compact action button -->
            <button @click="$emit('startCooking', order)"
                    :class="['w-full py-3 sm:py-4 mt-2 sm:mt-3 rounded-xl text-lg sm:text-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer touch:active:scale-95', buttonClass]">
                üë®‚Äçüç≥ –í–ó–Ø–¢–¨
            </button>
        </template>

        <!-- FULL MODE -->
        <template v-else>
            <!-- Order Header -->
            <div class="flex justify-between items-start mb-3 @[400px]:mb-4">
                <div>
                    <p :class="['text-2xl @[300px]:text-3xl @[400px]:text-4xl @[500px]:text-5xl font-black whitespace-nowrap', urgencyTextClass]">#{{ order.order_number }}</p>
                    <p class="text-base @[350px]:text-lg @[450px]:text-xl text-gray-400 mt-1">
                        {{ getTypeIcon(order.type) }}
                        <span v-if="order.type === 'preorder' && order.table" class="text-purple-400">
                            –ë—Ä–æ–Ω—å ¬∑ {{ order.table.name || order.table.number }}
                        </span>
                        <span v-else-if="order.table">–°—Ç–æ–ª {{ order.table.number }}</span>
                        <span v-else>{{ getTypeLabel(order.type) }}</span>
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-xs @[350px]:text-sm text-gray-500">–ü–æ—Å—Ç—É–ø–∏–ª</p>
                    <p class="text-xl @[350px]:text-2xl @[450px]:text-3xl font-bold">{{ formatTime(order.created_at) }}</p>
                    <p :class="['text-base @[350px]:text-lg @[450px]:text-xl font-bold mt-1', waitTimeClass]">{{ getWaitTime(order.created_at) }}</p>
                </div>
            </div>

            <!-- Items count indicator -->
            <div class="flex items-center gap-2 mb-3 bg-gray-700/50 rounded-lg px-3 py-2">
                <span class="text-gray-400 text-sm @[350px]:text-base">–ü–æ–∑–∏—Ü–∏–π:</span>
                <span class="text-xl @[350px]:text-2xl @[450px]:text-3xl font-bold text-white">{{ order.items.length }}</span>
            </div>

            <!-- Items -->
            <div class="space-y-1.5 @[350px]:space-y-2 mb-3 @[400px]:mb-4">
                <div v-for="item in order.items" :key="item.id"
                     class="bg-gray-800 rounded-lg @[350px]:rounded-xl p-2 @[300px]:p-3 @[400px]:p-4 flex items-center justify-between">
                    <div class="flex items-center gap-2 @[300px]:gap-3 @[400px]:gap-4">
                        <!-- Category icon + quantity -->
                        <div :class="['w-10 h-10 @[300px]:w-11 @[300px]:h-11 @[400px]:w-14 @[400px]:h-14 rounded-lg @[350px]:rounded-xl flex flex-col items-center justify-center text-white', quantityBadgeClass]">
                            <span class="text-base @[300px]:text-lg @[400px]:text-xl">{{ getCategoryIcon(item.dish?.category?.name) }}</span>
                            <span class="text-sm @[300px]:text-base @[400px]:text-lg font-black">√ó{{ item.quantity }}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1 @[300px]:gap-2 flex-wrap">
                                <p class="font-bold text-base @[350px]:text-lg @[450px]:text-xl text-white">{{ item.name }}</p>
                                <!-- Info button for recipe/photo -->
                                <button @click.stop="$emit('showDishInfo', item)"
                                        class="w-7 h-7 @[350px]:w-8 @[350px]:h-8 @[450px]:w-9 @[450px]:h-9 rounded-full bg-blue-500/30 hover:bg-blue-500/50 active:bg-blue-500/70 text-blue-300 flex items-center justify-center text-sm @[350px]:text-base transition flex-shrink-0"
                                        title="–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç">
                                    ‚ÑπÔ∏è
                                </button>
                                <span v-if="item.guest_number" class="text-xs @[350px]:text-sm bg-purple-500/30 text-purple-300 px-1.5 @[350px]:px-2 py-0.5 @[350px]:py-1 rounded font-medium">
                                    –ì–æ—Å—Ç—å {{ item.guest_number }}
                                </span>
                            </div>
                            <!-- –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã -->
                            <div v-if="item.modifiers?.length" class="mt-1 space-y-0.5">
                                <p v-for="mod in item.modifiers" :key="mod.option_id || mod.id"
                                   class="text-sm @[350px]:text-base text-blue-300 font-medium">
                                    + {{ mod.option_name || mod.name }}
                                </p>
                            </div>
                            <p v-if="item.comment" class="text-sm @[350px]:text-base text-yellow-400 italic mt-1">üí¨ {{ item.comment }}</p>
                            <p v-if="item.notes" class="text-sm @[350px]:text-base text-yellow-400 mt-1">üìù {{ item.notes }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div v-if="order.notes" class="bg-yellow-500/20 rounded-lg @[350px]:rounded-xl p-2 @[300px]:p-3 @[400px]:p-4 mb-3 @[400px]:mb-4">
                <p class="text-yellow-400 font-bold text-sm @[300px]:text-base @[400px]:text-lg">üìù {{ order.notes }}</p>
            </div>

            <!-- Action Button -->
            <button @click="$emit('startCooking', order)"
                    :class="['w-full py-4 @[400px]:py-5 @[500px]:py-6 rounded-xl text-lg @[350px]:text-xl @[450px]:text-2xl font-black transition flex items-center justify-center gap-2 cursor-pointer touch:active:scale-95', buttonClass]">
                üë®‚Äçüç≥ –í–ó–Ø–¢–¨ –í –†–ê–ë–û–¢–£
            </button>
        </template>
    </div>
</template>

<script setup>
import { computed } from 'vue';
import { getOrderTypeIcon, getOrderTypeLabel, getCategoryIcon, formatWaitTime, formatTimeOnly } from '../utils/format.js';

const props = defineProps({
    order: {
        type: Object,
        required: true,
        validator: (o) => o && typeof o.id !== 'undefined' && typeof o.order_number !== 'undefined' && Array.isArray(o.items),
    },
    compact: {
        type: Boolean,
        default: false,
    },
});

defineEmits(['startCooking', 'showDishInfo']);

// Use shared utilities
const getTypeIcon = getOrderTypeIcon;
const getTypeLabel = getOrderTypeLabel;
const formatTime = formatTimeOnly;
const getWaitTime = formatWaitTime;

// –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö
const waitMinutes = computed(() => {
    if (!props.order.created_at) return 0;
    return Math.floor((new Date() - new Date(props.order.created_at)) / 60000);
});

// –£—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏: normal (0-5–º–∏–Ω), warning (5-10–º–∏–Ω), urgent (10-15–º–∏–Ω), critical (15+–º–∏–Ω)
const urgencyLevel = computed(() => {
    const mins = waitMinutes.value;
    if (mins < 5) return 'normal';
    if (mins < 10) return 'warning';
    if (mins < 15) return 'urgent';
    return 'critical';
});

// –ö–ª–∞—Å—Å —Ä–∞–º–∫–∏ –∏ —Ñ–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
const urgencyClass = computed(() => {
    switch (urgencyLevel.value) {
        case 'warning': return 'bg-yellow-500/10 border-yellow-500';
        case 'urgent': return 'bg-orange-500/10 border-orange-500';
        case 'critical': return 'bg-red-500/10 border-red-500 pulse';
        default: return 'bg-blue-500/10 border-blue-500';
    }
});

// –ö–ª–∞—Å—Å –≤–µ—Ä—Ö–Ω–µ–π –ø–æ–ª–æ—Å–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
const urgencyBarClass = computed(() => {
    switch (urgencyLevel.value) {
        case 'warning': return 'bg-yellow-500';
        case 'urgent': return 'bg-orange-500';
        case 'critical': return 'bg-red-500';
        default: return 'bg-blue-500';
    }
});

// –ö–ª–∞—Å—Å —Ç–µ–∫—Å—Ç–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
const urgencyTextClass = computed(() => {
    switch (urgencyLevel.value) {
        case 'warning': return 'text-yellow-400';
        case 'urgent': return 'text-orange-400';
        case 'critical': return 'text-red-400';
        default: return 'text-blue-400';
    }
});

// –ö–ª–∞—Å—Å —Ç–µ–∫—Å—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è
const waitTimeClass = computed(() => {
    switch (urgencyLevel.value) {
        case 'warning': return 'text-yellow-400';
        case 'urgent': return 'text-orange-400';
        case 'critical': return 'text-red-400 animate-pulse';
        default: return 'text-green-400';
    }
});

// –ö–ª–∞—Å—Å –±–µ–π–¥–∂–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
const quantityBadgeClass = computed(() => {
    switch (urgencyLevel.value) {
        case 'warning': return 'bg-yellow-500';
        case 'urgent': return 'bg-orange-500';
        case 'critical': return 'bg-red-500';
        default: return 'bg-blue-500';
    }
});

// –ö–ª–∞—Å—Å –∫–Ω–æ–ø–∫–∏
const buttonClass = computed(() => {
    switch (urgencyLevel.value) {
        case 'warning': return 'bg-yellow-500 hover:bg-yellow-600 active:bg-yellow-700 text-gray-900';
        case 'urgent': return 'bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white';
        case 'critical': return 'bg-red-500 hover:bg-red-600 active:bg-red-700 text-white';
        default: return 'bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white';
    }
});
</script>

<style scoped>
.slide-in {
    animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}
.shake {
    animation: shake 0.5s ease-in-out;
}
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
.pulse {
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    50% { opacity: 0.85; box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
}
</style>
