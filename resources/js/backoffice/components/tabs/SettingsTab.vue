<template>
    <div>
        <!-- Settings Tabs -->
        <div class="bg-white rounded-xl shadow-sm mb-6">
            <div class="flex border-b overflow-x-auto">
                <button @click="subTab = 'general'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'general' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    –û—Å–Ω–æ–≤–Ω—ã–µ
                </button>
                <button @click="subTab = 'integrations'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'integrations' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
                </button>
                <button @click="subTab = 'printers'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'printers' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    –ü—Ä–∏–Ω—Ç–µ—Ä—ã
                </button>
                <button @click="subTab = 'notifications'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'notifications' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                </button>
                <button @click="subTab = 'receipts'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'receipts' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    üßæ –ß–µ–∫–∏
                </button>
                <button @click="subTab = 'stations'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'stations' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    –¶–µ—Ö–∞ –∫—É—Ö–Ω–∏
                </button>
                <button @click="subTab = 'devices'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'devices' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫—É—Ö–Ω–∏
                </button>
                <button @click="subTab = 'subscription'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'subscription' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    –ü–æ–¥–ø–∏—Å–∫–∞
                </button>
                <button @click="subTab = 'locations'"
                        :class="['px-6 py-4 text-sm font-medium border-b-2 -mb-px whitespace-nowrap transition',
                                 subTab === 'locations' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700']">
                    –¢–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂
                </button>
            </div>
        </div>

        <!-- General Settings -->
        <div v-if="subTab === 'general'" class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h3>
            <div class="max-w-2xl space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                    <input v-model="settings.name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ê–¥—Ä–µ—Å</label>
                    <input v-model="settings.address" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input v-model="settings.phone" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input v-model="settings.email" type="email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                </div>
                <!-- Working Hours by Day -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label>
                    <div class="border rounded-xl overflow-hidden">
                        <div
                            v-for="(day, index) in daysOfWeek"
                            :key="day.key"
                            :class="[
                                'flex items-center gap-4 px-4 py-3',
                                index !== daysOfWeek.length - 1 ? 'border-b' : '',
                                !settings.working_hours[day.key]?.enabled ? 'bg-gray-50' : ''
                            ]"
                        >
                            <!-- Day toggle -->
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input
                                    type="checkbox"
                                    v-model="settings.working_hours[day.key].enabled"
                                    class="sr-only peer"
                                >
                                <div class="w-9 h-5 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
                            </label>

                            <!-- Day name -->
                            <div class="w-28 font-medium" :class="!settings.working_hours[day.key]?.enabled ? 'text-gray-400' : ''">
                                {{ day.label }}
                            </div>

                            <!-- Time inputs or "Closed" -->
                            <div v-if="settings.working_hours[day.key]?.enabled" class="flex items-center gap-2 flex-1">
                                <input
                                    v-model="settings.working_hours[day.key].open"
                                    type="time"
                                    class="px-3 py-1.5 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                                >
                                <span class="text-gray-400">‚Äî</span>
                                <input
                                    v-model="settings.working_hours[day.key].close"
                                    type="time"
                                    class="px-3 py-1.5 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                                >
                            </div>
                            <div v-else class="flex-1 text-gray-400 text-sm">
                                –í—ã—Ö–æ–¥–Ω–æ–π
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">–î–ª—è —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—å—à–µ –æ—Ç–∫—Ä—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12:00 ‚Äî 02:00)</p>
                </div>

                <!-- Business Day Ends At -->
                <div class="border rounded-xl p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</label>
                    <div class="flex items-center gap-4">
                        <select v-model.number="settings.business_day_ends_at" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option :value="0">00:00</option>
                            <option :value="1">01:00</option>
                            <option :value="2">02:00</option>
                            <option :value="3">03:00</option>
                            <option :value="4">04:00</option>
                            <option :value="5">05:00 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
                            <option :value="6">06:00</option>
                            <option :value="7">07:00</option>
                            <option :value="8">08:00</option>
                        </select>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        –î–æ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç —á—Ç–æ –∏–¥—ë—Ç "–≤—á–µ—Ä–∞—à–Ω–∏–π" —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å.
                        –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 05:00 –∏ —Å–µ–π—á–∞—Å 03:00 –Ω–æ—á–∏ - –≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å.
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–í–∞–ª—é—Ç–∞</label>
                    <select v-model="settings.currency" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="RUB">–†—É–±–ª–∏ (‚ÇΩ)</option>
                        <option value="USD">–î–æ–ª–ª–∞—Ä—ã ($)</option>
                        <option value="EUR">–ï–≤—Ä–æ (‚Ç¨)</option>
                        <option value="KZT">–¢–µ–Ω–≥–µ (‚Ç∏)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
                    <select v-model="settings.timezone" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="Europe/Moscow">–ú–æ—Å–∫–≤–∞ (UTC+3)</option>
                        <option value="Europe/Kaliningrad">–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ (UTC+2)</option>
                        <option value="Asia/Yekaterinburg">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (UTC+5)</option>
                        <option value="Asia/Novosibirsk">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ (UTC+7)</option>
                        <option value="Asia/Vladivostok">–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ (UTC+10)</option>
                    </select>
                </div>

                <!-- Rounding setting -->
                <div class="flex items-center justify-between p-4 border rounded-xl">
                    <div>
                        <div class="font-medium">–û–∫—Ä—É–≥–ª—è—Ç—å —Å—É–º–º—ã –¥–æ —Ü–µ–ª—ã—Ö</div>
                        <div class="text-sm text-gray-500">–í—Å–µ —Å—É–º–º—ã –≤ —Å–∏—Å—Ç–µ–º–µ –±—É–¥—É—Ç –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="settings.round_amounts" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                </div>

                <button @click="saveSettings" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>

        <!-- Integrations -->
        <div v-if="subTab === 'integrations'" class="space-y-6">
            <!-- ATOL -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üßæ</span>
                        <div>
                            <h4 class="font-semibold">–ê–¢–û–õ –û–Ω–ª–∞–π–Ω</h4>
                            <p class="text-sm text-gray-500">–§–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–æ–≤ (54-–§–ó)</p>
                        </div>
                    </div>
                    <span :class="['px-3 py-1 rounded-full text-sm font-medium',
                                   integrations.atol?.enabled ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">
                        {{ integrations.atol?.enabled ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–û—Ç–∫–ª—é—á–µ–Ω–æ' }}
                    </span>
                </div>
                <button @click="openIntegrationModal('atol')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                    –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                </button>
            </div>

            <!-- Payment Systems -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üí≥</span>
                        <div>
                            <h4 class="font-semibold">–ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã</h4>
                            <p class="text-sm text-gray-500">–ÆKassa, –°–±–µ—ÄPay, –¢–∏–Ω—å–∫–æ—Ñ—Ñ</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-700">
                        –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
                    </span>
                </div>
                <button @click="openIntegrationModal('payment')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                    –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                </button>
            </div>

            <!-- Telegram -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üì±</span>
                        <div>
                            <h4 class="font-semibold">Telegram –±–æ—Ç</h4>
                            <p class="text-sm text-gray-500">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∑–∞–∫–∞–∑—ã</p>
                        </div>
                    </div>
                    <span :class="['px-3 py-1 rounded-full text-sm font-medium',
                                   integrations.telegram?.enabled ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700']">
                        {{ integrations.telegram?.enabled ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ' }}
                    </span>
                </div>
                <button @click="openIntegrationModal('telegram')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                    –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                </button>
            </div>

            <!-- iiko -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üîó</span>
                        <div>
                            <h4 class="font-semibold">iiko</h4>
                            <p class="text-sm text-gray-500">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–Ω—é –∏ –∑–∞–∫–∞–∑–æ–≤</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-700">
                        –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
                    </span>
                </div>
                <button @click="openIntegrationModal('iiko')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                    –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                </button>
            </div>

            <!-- Yandex Maps / Geocoder -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üó∫Ô∏è</span>
                        <div>
                            <h4 class="font-semibold">–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</h4>
                            <p class="text-sm text-gray-500">–ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∞–≤–∫–∏</p>
                        </div>
                    </div>
                    <span :class="['px-3 py-1 rounded-full text-sm font-medium',
                                   integrations.yandex?.enabled ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700']">
                        {{ integrations.yandex?.enabled ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ' }}
                    </span>
                </div>
                <button @click="openYandexModal" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                    –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                </button>
            </div>
        </div>

        <!-- Printers -->
        <div v-if="subTab === 'printers'" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-semibold">–ü—Ä–∏–Ω—Ç–µ—Ä—ã</h3>
                    <p class="text-sm text-gray-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Ä–º–æ–ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –¥–ª—è —á–µ–∫–æ–≤ –∏ –∫—É—Ö–Ω–∏</p>
                </div>
                <button @click="openPrinterModal()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                    + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä
                </button>
            </div>
            <div class="space-y-3">
                <div v-for="printer in printers" :key="printer.id"
                     class="flex items-center justify-between p-4 border rounded-xl hover:border-orange-300 transition">
                    <div class="flex items-center gap-4">
                        <!-- –ò–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞ -->
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl"
                             :class="getPrinterTypeClass(printer.type)">
                            {{ getPrinterIcon(printer.type) }}
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="font-medium">{{ printer.name }}</h4>
                                <span v-if="printer.is_default" class="text-yellow-500 text-sm" title="–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é">‚≠ê</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->
                                <span v-if="printer.connection_type === 'network'" class="font-mono">
                                    üåê {{ printer.ip_address }}:{{ printer.port }}
                                </span>
                                <span v-else-if="printer.connection_type === 'usb'" class="font-mono">
                                    üîå {{ printer.device_path }}
                                </span>
                                <span v-else class="font-mono">
                                    üìÅ –§–∞–π–ª
                                </span>
                                <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                                <span class="text-gray-300">‚Ä¢</span>
                                <!-- –†–∞–∑–º–µ—Ä -->
                                <span>{{ printer.paper_width }}–º–º</span>
                            </div>
                            <!-- –¶–µ—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                            <div v-if="printer.kitchen_station" class="mt-1">
                                <span class="text-xs px-2 py-0.5 rounded-full"
                                      :style="{ backgroundColor: printer.kitchen_station.color + '20', color: printer.kitchen_station.color }">
                                    {{ printer.kitchen_station.icon }} {{ printer.kitchen_station.name }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- –¢–∏–ø –ø—Ä–∏–Ω—Ç–µ—Ä–∞ -->
                        <span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">
                            {{ getPrinterTypeLabel(printer.type) }}
                        </span>
                        <!-- –°—Ç–∞—Ç—É—Å -->
                        <span :class="['px-2 py-1 rounded text-xs font-medium',
                                       printer.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">
                            {{ printer.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–í—ã–∫–ª' }}
                        </span>
                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <button @click="testPrinter(printer)" class="p-2 hover:bg-gray-100 rounded-lg" title="–¢–µ—Å—Ç –ø–µ—á–∞—Ç–∏">
                            üîß
                        </button>
                        <button @click="openPrinterModal(printer)" class="p-2 hover:bg-gray-100 rounded-lg" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </button>
                        <button v-can="'settings.edit'" @click="deletePrinter(printer)" class="p-2 hover:bg-gray-100 rounded-lg text-red-500" title="–£–¥–∞–ª–∏—Ç—å">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
                <div v-if="printers.length === 0" class="text-center py-12 text-gray-400">
                    <div class="text-4xl mb-2">üñ®Ô∏è</div>
                    <p>–ü—Ä–∏–Ω—Ç–µ—Ä—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</p>
                    <button @click="openPrinterModal()" class="text-orange-500 hover:underline mt-2">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä</button>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–µ—á–∞—Ç–∏ -->
            <div class="mt-6 border rounded-xl p-4">
                <h4 class="font-medium mb-4">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—á–∞—Ç—å</h4>
                <div class="space-y-4">
                    <label class="flex items-center justify-between cursor-pointer">
                        <div>
                            <span class="text-sm font-medium text-gray-700">–ê–≤—Ç–æ–ø–µ—á–∞—Ç—å –Ω–∞ –∫—É—Ö–Ω—é</span>
                            <p class="text-xs text-gray-500">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—á–∞—Ç–∞—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ –∫—É—Ö–Ω—é –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏</p>
                        </div>
                        <div class="relative inline-flex items-center">
                            <input type="checkbox" v-model="printSettings.auto_print_kitchen" @change="savePrintSettings" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                        </div>
                    </label>
                    <label class="flex items-center justify-between cursor-pointer">
                        <div>
                            <span class="text-sm font-medium text-gray-700">–ü–µ—á–∞—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π</span>
                            <p class="text-xs text-gray-500">–ü–µ—á–∞—Ç–∞—Ç—å –Ω–∞ –∫—É—Ö–Ω—é –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑</p>
                        </div>
                        <div class="relative inline-flex items-center">
                            <input type="checkbox" v-model="printSettings.auto_print_new_items" @change="savePrintSettings" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                        </div>
                    </label>
                    <label class="flex items-center justify-between cursor-pointer">
                        <div>
                            <span class="text-sm font-medium text-gray-700">–ê–≤—Ç–æ–ø–µ—á–∞—Ç—å —á–µ–∫–∞</span>
                            <p class="text-xs text-gray-500">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—á–∞—Ç–∞—Ç—å —á–µ–∫ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã</p>
                        </div>
                        <div class="relative inline-flex items-center">
                            <input type="checkbox" v-model="printSettings.auto_print_receipt" @change="savePrintSettings" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞) -->
            <div class="mt-6 border rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="font-medium">–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã</h4>
                        <p class="text-xs text-gray-500">–ü—Ä–∏–Ω—Ç–µ—Ä—ã, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤ Windows. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–Ω–æ–µ –∏–º—è –¥–ª—è USB-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.</p>
                    </div>
                    <button @click="scanSystemPrinters" :disabled="scanningPrinters"
                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-sm flex items-center gap-2">
                        <span v-if="scanningPrinters" class="animate-spin">‚è≥</span>
                        <span v-else>üîç</span>
                        {{ scanningPrinters ? '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...' : '–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å' }}
                    </button>
                </div>
                <div v-if="systemPrinters.length > 0" class="space-y-2">
                    <div v-for="sp in systemPrinters" :key="sp.Name"
                         class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-mono text-sm">{{ sp.Name }}</div>
                            <div class="text-xs text-gray-500">
                                –ü–æ—Ä—Ç: {{ sp.PortName }} | –î—Ä–∞–π–≤–µ—Ä: {{ sp.DriverName }}
                                <span v-if="sp.ShareName"> | –û–±—â–∏–π: {{ sp.ShareName }}</span>
                            </div>
                        </div>
                        <button @click="useSystemPrinter(sp)" class="text-xs px-3 py-1 bg-orange-100 text-orange-600 hover:bg-orange-200 rounded">
                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </div>
                <div v-else-if="scannedOnce" class="text-sm text-gray-500 py-2">
                    –ü—Ä–∏–Ω—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </div>
            </div>

            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
            <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                <h4 class="font-medium text-blue-800 mb-2">–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—á–∞—Ç—å –Ω–∞ –∫—É—Ö–Ω—é –ø–æ —Ü–µ—Ö–∞–º</h4>
                <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
                    <li>–°–æ–∑–¥–∞–π—Ç–µ —Ü–µ—Ö–∞ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–¶–µ—Ö–∞ –∫—É—Ö–Ω–∏" (–≥–æ—Ä—è—á–∏–π, —Ö–æ–ª–æ–¥–Ω—ã–π, –±–∞—Ä)</li>
                    <li>–ù–∞–∑–Ω–∞—á—å—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥ —Ü–µ—Ö–∞–º (–≤ —Ä–∞–∑–¥–µ–ª–µ –ú–µ–Ω—é)</li>
                    <li>–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–Ω—Ç–µ—Ä –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ü–µ—Ö–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ü–µ—Ö</li>
                    <li>–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞ –±–ª—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º</li>
                </ol>
            </div>
        </div>

        <!-- Notifications -->
        <div v-if="subTab === 'notifications'" class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
            <div class="space-y-4 max-w-2xl">
                <div class="flex items-center justify-between p-4 border rounded-xl">
                    <div>
                        <div class="font-medium">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</div>
                        <div class="text-sm text-gray-500">–ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="notifications.newOrder" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between p-4 border rounded-xl">
                    <div>
                        <div class="font-medium">–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤</div>
                        <div class="text-sm text-gray-500">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –∫—É—Ö–Ω—è –æ—Ç–º–µ—Ç–∏–ª–∞ –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤—ã–º</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="notifications.orderReady" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between p-4 border rounded-xl">
                    <div>
                        <div class="font-medium">Email –æ—Ç—á—ë—Ç—ã</div>
                        <div class="text-sm text-gray-500">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç –Ω–∞ email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="notifications.dailyReport" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between p-4 border rounded-xl">
                    <div>
                        <div class="font-medium">Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                        <div class="text-sm text-gray-500">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤–∞–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="notifications.telegram" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                </div>
                <button @click="saveNotifications" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition mt-4">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>

        <!-- Receipt Settings -->
        <div v-if="subTab === 'receipts'" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ–∫–æ–≤</h3>
                    <p class="text-sm text-gray-500">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–µ—á–∞—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
                </div>
                <div class="flex items-center gap-3">
                    <button @click="testPrintReceipt"
                            :disabled="testingPrint"
                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition flex items-center gap-2 disabled:opacity-50">
                        <svg v-if="!testingPrint" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        <span v-else class="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></span>
                        –¢–µ—Å—Ç –ø–µ—á–∞—Ç–∏
                    </button>
                    <button @click="savePrintSettings"
                            class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- –ü–æ–¥—Ç–∞–±—ã –¥–ª—è —Ç–∏–ø–æ–≤ —á–µ–∫–æ–≤ -->
            <div class="flex gap-2 mb-6 border-b">
                <button @click="receiptSubTab = 'guest'"
                        :class="receiptSubTab === 'guest' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                        class="px-4 py-2 text-sm font-medium border-b-2 -mb-px transition">
                    üßæ –ß–µ–∫ –¥–ª—è –≥–æ—Å—Ç—è
                </button>
                <button @click="receiptSubTab = 'delivery'"
                        :class="receiptSubTab === 'delivery' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                        class="px-4 py-2 text-sm font-medium border-b-2 -mb-px transition">
                    üöó –ß–µ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏
                </button>
                <button @click="receiptSubTab = 'kitchen'"
                        :class="receiptSubTab === 'kitchen' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                        class="px-4 py-2 text-sm font-medium border-b-2 -mb-px transition">
                    üë®‚Äçüç≥ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π —á–µ–∫
                </button>
                <button @click="receiptSubTab = 'precheck'"
                        :class="receiptSubTab === 'precheck' ? 'text-orange-500 border-orange-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                        class="px-4 py-2 text-sm font-medium border-b-2 -mb-px transition">
                    üìã –°—á—ë—Ç
                </button>
            </div>

            <!-- ==================== –ß–ï–ö –î–õ–Ø –ì–û–°–¢–Ø ==================== -->
            <div v-if="receiptSubTab === 'guest'" class="flex gap-8">
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="flex-1 space-y-6">
                    <!-- –®–∞–ø–∫–∞ —á–µ–∫–∞ -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs">1</span>
                            –®–∞–ø–∫–∞ —á–µ–∫–∞
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-sm text-gray-600 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                                <input v-model="printSettings.receipt_header_name"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="–ú–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm text-gray-600 mb-1">–ê–¥—Ä–µ—Å</label>
                                <input v-model="printSettings.receipt_header_address"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 1">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input v-model="printSettings.receipt_header_phone"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="+7 (999) 123-45-67">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–ò–ù–ù</label>
                                <input v-model="printSettings.receipt_header_inn"
                                       class="w-full px-3 py-2 border rounded-lg font-mono focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="0000000000">
                            </div>
                        </div>
                    </div>

                    <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs">2</span>
                            –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.show_waiter" class="rounded text-orange-500">
                                <span class="text-sm">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.show_table" class="rounded text-orange-500">
                                <span class="text-sm">–ù–æ–º–µ—Ä —Å—Ç–æ–ª–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.show_guests_count" class="rounded text-orange-500">
                                <span class="text-sm">–ö–æ–ª-–≤–æ –≥–æ—Å—Ç–µ–π</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.show_order_number" class="rounded text-orange-500">
                                <span class="text-sm">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.show_order_time" class="rounded text-orange-500">
                                <span class="text-sm">–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.show_payment_method" class="rounded text-orange-500">
                                <span class="text-sm">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</span>
                            </label>
                        </div>
                    </div>

                    <!-- –§—É—Ç–µ—Ä —á–µ–∫–∞ -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs">3</span>
                            –§—É—Ç–µ—Ä —á–µ–∫–∞
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–°—Ç—Ä–æ–∫–∞ 1</label>
                                <input v-model="printSettings.receipt_footer_line1"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∏–∑–∏—Ç!">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–°—Ç—Ä–æ–∫–∞ 2</label>
                                <input v-model="printSettings.receipt_footer_line2"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="–ñ–¥–µ–º –≤–∞—Å —Å–Ω–æ–≤–∞!">
                            </div>
                        </div>
                    </div>

                    <!-- QR-–∫–æ–¥ -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs">4</span>
                            QR-–∫–æ–¥
                        </h4>
                        <label class="flex items-center gap-3 mb-3 cursor-pointer">
                            <input type="checkbox" v-model="printSettings.print_qr" class="rounded text-orange-500">
                            <span class="text-sm">–ü–µ—á–∞—Ç–∞—Ç—å QR-–∫–æ–¥ –Ω–∞ —á–µ–∫–µ</span>
                        </label>
                        <div v-if="printSettings.print_qr" class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">URL –¥–ª—è QR-–∫–æ–¥–∞</label>
                                <input v-model="printSettings.qr_url"
                                       class="w-full px-3 py-2 border rounded-lg font-mono text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="https://example.com/review/{order_id}">
                                <p class="text-xs text-gray-500 mt-1">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {order_id} –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞</p>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–¢–µ–∫—Å—Ç –ø–æ–¥ QR-–∫–æ–¥–æ–º</label>
                                <input v-model="printSettings.qr_text"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –æ—Ç–∑—ã–≤–∞">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                <div class="flex-shrink-0" :class="previewPrinterWidth === '58' ? 'w-56' : 'w-80'">
                    <div class="sticky top-4">
                        <h4 class="text-sm font-medium text-gray-600 mb-2 text-center">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h4>
                        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —à–∏—Ä–∏–Ω—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ -->
                        <div class="flex justify-center gap-1 mb-3">
                            <button @click="previewPrinterWidth = '58'"
                                    :class="previewPrinterWidth === '58' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                    class="px-3 py-1 text-xs rounded-l-lg font-medium transition-colors">
                                58–º–º
                            </button>
                            <button @click="previewPrinterWidth = '80'"
                                    :class="previewPrinterWidth === '80' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                    class="px-3 py-1 text-xs rounded-r-lg font-medium transition-colors">
                                80–º–º
                            </button>
                        </div>
                        <div class="receipt-preview bg-white border-2 border-gray-200 rounded-lg shadow-lg overflow-hidden">
                            <div class="h-4 bg-gradient-to-b from-gray-100 to-white border-b border-dashed border-gray-300"></div>
                            <div class="p-4 font-mono text-xs leading-relaxed text-gray-800" style="font-size: 11px;">
                                <!-- –®–∞–ø–∫–∞ -->
                                <div class="text-center mb-3">
                                    <div class="font-bold text-base">{{ printSettings.receipt_header_name || '–†–ï–°–¢–û–†–ê–ù' }}</div>
                                    <div v-if="printSettings.receipt_header_address" class="text-gray-600">{{ printSettings.receipt_header_address }}</div>
                                    <div v-if="printSettings.receipt_header_phone" class="text-gray-600">–¢–µ–ª: {{ printSettings.receipt_header_phone }}</div>
                                    <div v-if="printSettings.receipt_header_inn" class="text-gray-600">–ò–ù–ù: {{ printSettings.receipt_header_inn }}</div>
                                </div>
                                <div class="border-t border-dashed border-gray-400 my-2"></div>
                                <div class="text-center font-bold mb-2">–ö–ê–°–°–û–í–´–ô –ß–ï–ö</div>

                                <div v-if="printSettings.show_order_number !== false" class="flex justify-between"><span>–ß–µ–∫ ‚Ññ:</span><span>0001</span></div>
                                <div v-if="printSettings.show_order_time !== false" class="flex justify-between"><span>–î–∞—Ç–∞:</span><span>{{ formatReceiptDate(new Date()) }}</span></div>
                                <div v-if="printSettings.show_table !== false" class="flex justify-between"><span>–°—Ç–æ–ª:</span><span>5</span></div>
                                <div v-if="printSettings.show_waiter !== false" class="flex justify-between"><span>–û—Ñ–∏—Ü–∏–∞–Ω—Ç:</span><span>–ê–Ω–Ω–∞</span></div>
                                <div v-if="printSettings.show_guests_count" class="flex justify-between"><span>–ì–æ—Å—Ç–µ–π:</span><span>2</span></div>

                                <div class="border-t border-dashed border-gray-400 my-2"></div>
                                <div class="font-bold flex text-xs">
                                    <span class="w-6">–ö–æ–ª</span>
                                    <span class="flex-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</span>
                                    <span class="w-14 text-right">–°—É–º–º–∞</span>
                                </div>
                                <div class="border-t border-dashed border-gray-400 my-1"></div>
                                <div class="flex text-xs"><span class="w-6">2x</span><span class="flex-1">–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞</span><span class="w-14 text-right">890.00</span></div>
                                <div class="flex text-xs"><span class="w-6">1x</span><span class="flex-1">–¶–µ–∑–∞—Ä—å</span><span class="w-14 text-right">450.00</span></div>
                                <div class="flex text-xs"><span class="w-6">2x</span><span class="flex-1">–ö–æ–ª–∞ 0.5–ª</span><span class="w-14 text-right">180.00</span></div>

                                <div class="border-t border-dashed border-gray-400 my-2"></div>
                                <div class="flex justify-between"><span>–ü–æ–¥–∏—Ç–æ–≥:</span><span>1 520.00 —Ä.</span></div>
                                <div class="border-t-2 border-gray-600 my-2"></div>
                                <div class="flex justify-between font-bold"><span>–ò–¢–û–ì–û:</span><span>1 520.00 —Ä.</span></div>
                                <div class="border-t border-dashed border-gray-400 my-2"></div>
                                <div v-if="printSettings.show_payment_method !== false" class="flex justify-between"><span>–û–ø–ª–∞—Ç–∞:</span><span>–ö–∞—Ä—Ç–∞</span></div>

                                <div v-if="printSettings.print_qr" class="text-center my-3">
                                    <div class="inline-block p-2 bg-gray-100 rounded">
                                        <div class="w-16 h-16 bg-white border flex items-center justify-center">
                                            <span class="text-2xl">üì±</span>
                                        </div>
                                    </div>
                                    <div class="text-xs mt-1 text-gray-600">{{ printSettings.qr_text || '–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –æ—Ç–∑—ã–≤–∞' }}</div>
                                </div>

                                <div class="text-center mt-3">
                                    <div>{{ printSettings.receipt_footer_line1 || '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∏–∑–∏—Ç!' }}</div>
                                    <div>{{ printSettings.receipt_footer_line2 || '–ñ–¥–µ–º –≤–∞—Å —Å–Ω–æ–≤–∞!' }}</div>
                                    <div class="text-gray-500 mt-2 text-xs">{{ formatReceiptDateTime(new Date()) }}</div>
                                </div>
                            </div>
                            <div class="h-4 bg-gradient-to-t from-gray-100 to-white border-t border-dashed border-gray-300"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== –ß–ï–ö –î–û–°–¢–ê–í–ö–ò ==================== -->
            <div v-if="receiptSubTab === 'delivery'" class="flex gap-8">
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="flex-1 space-y-6">
                    <!-- –®–∞–ø–∫–∞ (–æ–±—â–∞—è —Å –≥–æ—Å—Ç–µ–≤—ã–º) -->
                    <div class="border rounded-xl p-4 bg-gray-50">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            –®–∞–ø–∫–∞ —á–µ–∫–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ "–ß–µ–∫ –¥–ª—è –≥–æ—Å—Ç—è"
                        </div>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs">1</span>
                            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.delivery_show_customer" class="rounded text-orange-500">
                                <span class="text-sm">–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.delivery_show_phone" class="rounded text-orange-500">
                                <span class="text-sm">–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.delivery_show_address" class="rounded text-orange-500">
                                <span class="text-sm">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.delivery_show_entrance" class="rounded text-orange-500">
                                <span class="text-sm">–ü–æ–¥—ä–µ–∑–¥/–≠—Ç–∞–∂/–ö–≤</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.delivery_show_intercom" class="rounded text-orange-500">
                                <span class="text-sm">–î–æ–º–æ—Ñ–æ–Ω</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.delivery_show_courier" class="rounded text-orange-500">
                                <span class="text-sm">–ö—É—Ä—å–µ—Ä</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50 col-span-2">
                                <input type="checkbox" v-model="printSettings.delivery_show_comment" class="rounded text-orange-500">
                                <span class="text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</span>
                            </label>
                        </div>
                    </div>

                    <!-- –§—É—Ç–µ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs">2</span>
                            –§—É—Ç–µ—Ä —á–µ–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–°—Ç—Ä–æ–∫–∞ 1</label>
                                <input v-model="printSettings.delivery_footer_line1"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–°—Ç—Ä–æ–∫–∞ 2</label>
                                <input v-model="printSettings.delivery_footer_line2"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                <div class="flex-shrink-0" :class="previewPrinterWidth === '58' ? 'w-56' : 'w-80'">
                    <div class="sticky top-4">
                        <h4 class="text-sm font-medium text-gray-600 mb-2 text-center">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h4>
                        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —à–∏—Ä–∏–Ω—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ -->
                        <div class="flex justify-center gap-1 mb-3">
                            <button @click="previewPrinterWidth = '58'"
                                    :class="previewPrinterWidth === '58' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                    class="px-3 py-1 text-xs rounded-l-lg font-medium transition-colors">
                                58–º–º
                            </button>
                            <button @click="previewPrinterWidth = '80'"
                                    :class="previewPrinterWidth === '80' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                    class="px-3 py-1 text-xs rounded-r-lg font-medium transition-colors">
                                80–º–º
                            </button>
                        </div>
                        <div class="receipt-preview bg-white border-2 border-gray-200 rounded-lg shadow-lg overflow-hidden">
                            <div class="h-4 bg-gradient-to-b from-gray-100 to-white border-b border-dashed border-gray-300"></div>
                            <div class="p-4 font-mono text-xs leading-relaxed text-gray-800" style="font-size: 11px;">
                                <!-- –®–∞–ø–∫–∞ -->
                                <div class="text-center mb-3">
                                    <div class="font-bold text-base">{{ printSettings.receipt_header_name || '–†–ï–°–¢–û–†–ê–ù' }}</div>
                                    <div v-if="printSettings.receipt_header_address" class="text-gray-600">{{ printSettings.receipt_header_address }}</div>
                                    <div v-if="printSettings.receipt_header_phone" class="text-gray-600">–¢–µ–ª: {{ printSettings.receipt_header_phone }}</div>
                                </div>
                                <div class="border-t border-dashed border-gray-400 my-2"></div>

                                <!-- –ë–µ–π–¥–∂ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                                <div class="text-center my-2">
                                    <span class="bg-gray-800 text-white px-4 py-1 font-bold text-sm">–î–û–°–¢–ê–í–ö–ê</span>
                                </div>

                                <div class="flex justify-between"><span>–ó–∞–∫–∞–∑ ‚Ññ:</span><span>D-0042</span></div>
                                <div class="flex justify-between"><span>–î–∞—Ç–∞:</span><span>{{ formatReceiptDate(new Date()) }}</span></div>

                                <div class="border-t border-dashed border-gray-400 my-2"></div>

                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
                                <div v-if="printSettings.delivery_show_customer !== false" class="font-bold">–ö–õ–ò–ï–ù–¢:</div>
                                <div v-if="printSettings.delivery_show_customer !== false">–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</div>
                                <div v-if="printSettings.delivery_show_phone !== false">–¢–µ–ª: +7 (999) 123-45-67</div>

                                <div v-if="printSettings.delivery_show_address !== false" class="mt-2 font-bold">–ê–î–†–ï–°:</div>
                                <div v-if="printSettings.delivery_show_address !== false">—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10</div>
                                <div v-if="printSettings.delivery_show_entrance !== false">–ü–æ–¥—ä–µ–∑–¥: 2, –≠—Ç–∞–∂: 5, –ö–≤: 42</div>
                                <div v-if="printSettings.delivery_show_intercom !== false">–î–æ–º–æ—Ñ–æ–Ω: 42#</div>

                                <div v-if="printSettings.delivery_show_courier !== false" class="mt-2 flex justify-between">
                                    <span>–ö—É—Ä—å–µ—Ä:</span><span>–ê–ª–µ–∫—Å–µ–π</span>
                                </div>

                                <div v-if="printSettings.delivery_show_comment !== false" class="mt-2 p-2 bg-gray-100 rounded text-xs">
                                    üí¨ –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞ 5 –º–∏–Ω
                                </div>

                                <div class="border-t border-dashed border-gray-400 my-2"></div>
                                <div class="font-bold flex text-xs">
                                    <span class="w-6">–ö–æ–ª</span>
                                    <span class="flex-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</span>
                                    <span class="w-14 text-right">–°—É–º–º–∞</span>
                                </div>
                                <div class="border-t border-dashed border-gray-400 my-1"></div>
                                <div class="flex text-xs"><span class="w-6">2x</span><span class="flex-1">–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏</span><span class="w-14 text-right">990.00</span></div>
                                <div class="flex text-xs"><span class="w-6">1x</span><span class="flex-1">–†–æ–ª–ª –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è</span><span class="w-14 text-right">590.00</span></div>

                                <div class="border-t border-dashed border-gray-400 my-2"></div>
                                <div class="flex justify-between"><span>–ü–æ–¥–∏—Ç–æ–≥:</span><span>1 580.00 —Ä.</span></div>
                                <div class="flex justify-between"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span><span>–ë–ï–°–ü–õ–ê–¢–ù–û</span></div>
                                <div class="border-t-2 border-gray-600 my-2"></div>
                                <div class="flex justify-between font-bold"><span>–ò–¢–û–ì–û:</span><span>1 580.00 —Ä.</span></div>

                                <div class="text-center mt-3">
                                    <div>{{ printSettings.delivery_footer_line1 || '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!' }}</div>
                                    <div>{{ printSettings.delivery_footer_line2 || '–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!' }}</div>
                                    <div class="text-gray-500 mt-2 text-xs">{{ formatReceiptDateTime(new Date()) }}</div>
                                </div>
                            </div>
                            <div class="h-4 bg-gradient-to-t from-gray-100 to-white border-t border-dashed border-gray-300"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ô –ß–ï–ö ==================== -->
            <div v-if="receiptSubTab === 'kitchen'" class="flex gap-8">
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="flex-1 space-y-6">
                    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs">1</span>
                            –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </h4>
                        <div class="space-y-4">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" v-model="printSettings.kitchen_beep" class="rounded text-orange-500">
                                <div>
                                    <span class="text-sm font-medium">–ó–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª</span>
                                    <p class="text-xs text-gray-500">–ü—Ä–∏–Ω—Ç–µ—Ä –∏–∑–¥–∞–µ—Ç –∑–≤—É–∫ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" v-model="printSettings.kitchen_large_font" class="rounded text-orange-500">
                                <div>
                                    <span class="text-sm font-medium">–ö—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç</span>
                                    <p class="text-xs text-gray-500">–ü–æ–∑–∏—Ü–∏–∏ –ø–µ—á–∞—Ç–∞—é—Ç—Å—è —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" v-model="printSettings.kitchen_bold_items" class="rounded text-orange-500">
                                <div>
                                    <span class="text-sm font-medium">–ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –ø–æ–∑–∏—Ü–∏–π</span>
                                    <p class="text-xs text-gray-500">–ù–∞–∑–≤–∞–Ω–∏—è –±–ª—é–¥ –≤—ã–¥–µ–ª—è—é—Ç—Å—è –∂–∏—Ä–Ω—ã–º</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs">2</span>
                            –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.kitchen_show_table" class="rounded text-orange-500">
                                <span class="text-sm">–ù–æ–º–µ—Ä —Å—Ç–æ–ª–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.kitchen_show_waiter" class="rounded text-orange-500">
                                <span class="text-sm">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.kitchen_show_order_number" class="rounded text-orange-500">
                                <span class="text-sm">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.kitchen_show_time" class="rounded text-orange-500">
                                <span class="text-sm">–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.kitchen_show_order_type" class="rounded text-orange-500">
                                <span class="text-sm">–¢–∏–ø –∑–∞–∫–∞–∑–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.kitchen_show_modifiers" class="rounded text-orange-500">
                                <span class="text-sm">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50 col-span-2">
                                <input type="checkbox" v-model="printSettings.kitchen_show_comments" class="rounded text-orange-500">
                                <span class="text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ–∑–∏—Ü–∏—è–º (–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ)</span>
                            </label>
                        </div>
                    </div>

                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs">3</span>
                            –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–µ–∫–∞
                        </h4>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–¢–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞</label>
                            <input v-model="printSettings.kitchen_header_text"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                   placeholder="–ù–û–í–´–ô –ó–ê–ö–ê–ó">
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫—É—Ö–æ–Ω–Ω–æ–≥–æ —á–µ–∫–∞ -->
                <div class="flex-shrink-0" :class="previewPrinterWidth === '58' ? 'w-56' : 'w-80'">
                    <div class="sticky top-4">
                        <h4 class="text-sm font-medium text-gray-600 mb-2 text-center">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h4>
                        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —à–∏—Ä–∏–Ω—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ -->
                        <div class="flex justify-center gap-1 mb-3">
                            <button @click="previewPrinterWidth = '58'"
                                    :class="previewPrinterWidth === '58' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                    class="px-3 py-1 text-xs rounded-l-lg font-medium transition-colors">
                                58–º–º
                            </button>
                            <button @click="previewPrinterWidth = '80'"
                                    :class="previewPrinterWidth === '80' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                    class="px-3 py-1 text-xs rounded-r-lg font-medium transition-colors">
                                80–º–º
                            </button>
                        </div>
                        <div class="receipt-preview bg-white border-2 border-gray-200 rounded-lg shadow-lg overflow-hidden">
                            <div class="h-4 bg-gradient-to-b from-gray-100 to-white border-b border-dashed border-gray-300"></div>
                            <div class="p-4 font-mono leading-relaxed text-gray-800" :class="printSettings.kitchen_large_font ? 'text-sm' : 'text-xs'" style="min-height: 300px;">

                                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                                <div class="text-center mb-3">
                                    <div class="bg-gray-800 text-white py-2 px-4 font-bold" :class="printSettings.kitchen_large_font ? 'text-lg' : 'text-base'">
                                        {{ printSettings.kitchen_header_text || '–ù–û–í–´–ô –ó–ê–ö–ê–ó' }}
                                    </div>
                                </div>

                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                                <div v-if="printSettings.kitchen_show_table !== false" class="text-center font-bold mb-2" :class="printSettings.kitchen_large_font ? 'text-xl' : 'text-lg'">
                                    –°–¢–û–õ: 5
                                </div>

                                <div v-if="printSettings.kitchen_show_order_number !== false" class="flex justify-between">
                                    <span>–ó–∞–∫–∞–∑ ‚Ññ:</span><span>0001</span>
                                </div>
                                <div v-if="printSettings.kitchen_show_time !== false" class="flex justify-between">
                                    <span>–í—Ä–µ–º—è:</span><span>{{ new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}) }}</span>
                                </div>
                                <div v-if="printSettings.kitchen_show_waiter !== false" class="flex justify-between">
                                    <span>–û—Ñ–∏—Ü–∏–∞–Ω—Ç:</span><span>–ê–Ω–Ω–∞</span>
                                </div>

                                <div v-if="printSettings.kitchen_show_order_type !== false" class="text-center my-2">
                                    <span class="bg-gray-200 px-3 py-1 text-xs font-bold">–í –ó–ê–õ–ï</span>
                                </div>

                                <div class="border-t-2 border-gray-600 my-3"></div>

                                <!-- –ü–æ–∑–∏—Ü–∏–∏ -->
                                <div class="space-y-3">
                                    <div>
                                        <div :class="[printSettings.kitchen_large_font ? 'text-base' : 'text-sm', printSettings.kitchen_bold_items !== false ? 'font-bold' : '']">
                                            2x –ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞
                                        </div>
                                        <div v-if="printSettings.kitchen_show_modifiers !== false" class="text-gray-600 ml-4">+ –î–≤–æ–π–Ω–æ–π —Å—ã—Ä</div>
                                    </div>
                                    <div>
                                        <div :class="[printSettings.kitchen_large_font ? 'text-base' : 'text-sm', printSettings.kitchen_bold_items !== false ? 'font-bold' : '']">
                                            1x –¶–µ–∑–∞—Ä—å —Å –∫—É—Ä–∏—Ü–µ–π
                                        </div>
                                        <div v-if="printSettings.kitchen_show_comments !== false" class="bg-gray-800 text-white px-2 py-1 text-xs mt-1">
                                            ‚ö†Ô∏è –ë–µ–∑ –ª—É–∫–∞!
                                        </div>
                                    </div>
                                </div>

                                <div class="border-t-2 border-gray-600 my-3"></div>
                                <div class="text-center text-sm">
                                    >>> –ü–†–ò–ù–Ø–¢ –í {{ new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}) }} <<<
                                </div>

                                <div v-if="printSettings.kitchen_beep" class="text-center mt-3 text-gray-500 text-xs">
                                    üîî –ó–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª
                                </div>
                            </div>
                            <div class="h-4 bg-gradient-to-t from-gray-100 to-white border-t border-dashed border-gray-300"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== –°–ß–Å–¢ ==================== -->
            <div v-if="receiptSubTab === 'precheck'" class="flex gap-8">
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="flex-1 space-y-6">
                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-xs">1</span>
                            –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—á—ë—Ç–∞
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                                <input v-model="printSettings.precheck_title"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="–ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –°–ß–Å–¢">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                                <input v-model="printSettings.precheck_subtitle"
                                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="(–Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏—Å–∫–∞–ª—å–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º)">
                            </div>
                        </div>
                    </div>

                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-xs">2</span>
                            –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.precheck_show_table" class="rounded text-orange-500">
                                <span class="text-sm">–ù–æ–º–µ—Ä —Å—Ç–æ–ª–∞</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.precheck_show_waiter" class="rounded text-orange-500">
                                <span class="text-sm">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.precheck_show_date" class="rounded text-orange-500">
                                <span class="text-sm">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" v-model="printSettings.precheck_show_guests" class="rounded text-orange-500">
                                <span class="text-sm">–ö–æ–ª-–≤–æ –≥–æ—Å—Ç–µ–π</span>
                            </label>
                        </div>
                    </div>

                    <div class="border rounded-xl p-4">
                        <h4 class="font-medium mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-xs">3</span>
                            –§—É—Ç–µ—Ä —Å—á—ë—Ç–∞
                        </h4>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">–¢–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ</label>
                            <input v-model="printSettings.precheck_footer"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                   placeholder="–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!">
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—á—ë—Ç–∞ -->
                <div class="flex-shrink-0" :class="previewPrinterWidth === '58' ? 'w-56' : 'w-80'">
                    <div class="sticky top-4">
                        <h4 class="text-sm font-medium text-gray-600 mb-2 text-center">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h4>
                        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —à–∏—Ä–∏–Ω—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ -->
                        <div class="flex justify-center gap-1 mb-3">
                            <button @click="previewPrinterWidth = '58'"
                                    :class="previewPrinterWidth === '58' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                    class="px-3 py-1 text-xs rounded-l-lg font-medium transition-colors">
                                58–º–º
                            </button>
                            <button @click="previewPrinterWidth = '80'"
                                    :class="previewPrinterWidth === '80' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                    class="px-3 py-1 text-xs rounded-r-lg font-medium transition-colors">
                                80–º–º
                            </button>
                        </div>
                        <div class="receipt-preview bg-white border-2 border-gray-200 rounded-lg shadow-lg overflow-hidden">
                            <div class="h-4 bg-gradient-to-b from-gray-100 to-white border-b border-dashed border-gray-300"></div>
                            <div class="p-4 font-mono text-xs leading-relaxed text-gray-800" style="font-size: 11px;">
                                <div class="text-center mb-3">
                                    <div class="font-bold text-base">{{ printSettings.precheck_title || '–ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –°–ß–Å–¢' }}</div>
                                    <div class="text-gray-500 text-xs">{{ printSettings.precheck_subtitle || '(–Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏—Å–∫–∞–ª—å–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º)' }}</div>
                                </div>

                                <div class="border-t border-dashed border-gray-400 my-2"></div>

                                <div v-if="printSettings.precheck_show_table !== false" class="flex justify-between"><span>–°—Ç–æ–ª ‚Ññ:</span><span>5</span></div>
                                <div v-if="printSettings.precheck_show_date !== false" class="flex justify-between"><span>–î–∞—Ç–∞:</span><span>{{ formatReceiptDate(new Date()) }}</span></div>
                                <div v-if="printSettings.precheck_show_waiter !== false" class="flex justify-between"><span>–û—Ñ–∏—Ü–∏–∞–Ω—Ç:</span><span>–ê–Ω–Ω–∞</span></div>
                                <div v-if="printSettings.precheck_show_guests" class="flex justify-between"><span>–ì–æ—Å—Ç–µ–π:</span><span>2</span></div>

                                <!-- –ì–æ—Å—Ç—å 1 -->
                                <div class="text-center font-bold my-2">--- –ì–æ—Å—Ç—å 1 ---</div>
                                <div class="font-bold flex text-xs">
                                    <span class="w-6">–ö–æ–ª</span>
                                    <span class="flex-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</span>
                                    <span class="w-14 text-right">–°—É–º–º–∞</span>
                                </div>
                                <div class="border-t border-dashed border-gray-400 my-1"></div>
                                <div class="flex text-xs"><span class="w-6">2x</span><span class="flex-1">–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞</span><span class="w-14 text-right">890.00</span></div>
                                <div class="flex text-xs"><span class="w-6">1x</span><span class="flex-1">–ö–æ–ª–∞ 0.5–ª</span><span class="w-14 text-right">90.00</span></div>
                                <div class="border-t border-dashed border-gray-400 my-1"></div>
                                <div class="flex justify-between font-bold text-xs"><span>–ò—Ç–æ–≥–æ –ì–æ—Å—Ç—å 1:</span><span>980.00</span></div>

                                <!-- –ì–æ—Å—Ç—å 2 -->
                                <div class="text-center font-bold my-2">--- –ì–æ—Å—Ç—å 2 ---</div>
                                <div class="font-bold flex text-xs">
                                    <span class="w-6">–ö–æ–ª</span>
                                    <span class="flex-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</span>
                                    <span class="w-14 text-right">–°—É–º–º–∞</span>
                                </div>
                                <div class="border-t border-dashed border-gray-400 my-1"></div>
                                <div class="flex text-xs"><span class="w-6">1x</span><span class="flex-1">–¶–µ–∑–∞—Ä—å —Å –∫—É—Ä–∏—Ü–µ–π</span><span class="w-14 text-right">450.00</span></div>
                                <div class="flex text-xs"><span class="w-6">1x</span><span class="flex-1">–ö–æ–ª–∞ 0.5–ª</span><span class="w-14 text-right">90.00</span></div>
                                <div class="border-t border-dashed border-gray-400 my-1"></div>
                                <div class="flex justify-between font-bold text-xs"><span>–ò—Ç–æ–≥–æ –ì–æ—Å—Ç—å 2:</span><span>540.00</span></div>

                                <div class="border-t-2 border-gray-600 my-2"></div>
                                <div class="flex justify-between font-bold text-sm"><span>–ö –û–ü–õ–ê–¢–ï:</span><span>1 520.00 —Ä.</span></div>

                                <div class="text-center mt-4">
                                    <div>{{ printSettings.precheck_footer || '–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!' }}</div>
                                </div>
                            </div>
                            <div class="h-4 bg-gradient-to-t from-gray-100 to-white border-t border-dashed border-gray-300"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kitchen Stations -->
        <div v-if="subTab === 'stations'" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-semibold">–¶–µ—Ö–∞ –∫—É—Ö–Ω–∏</h3>
                    <p class="text-sm text-gray-500">–ù–∞–∑–Ω–∞—á—å—Ç–µ –±–ª—é–¥–∞ —Ü–µ—Ö–∞–º –¥–ª—è —Ä–∞–∑–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫—É—Ö–æ–Ω–Ω—ã—Ö –¥–∏—Å–ø–ª–µ—è—Ö</p>
                </div>
                <button @click="openStationModal()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                    + –î–æ–±–∞–≤–∏—Ç—å —Ü–µ—Ö
                </button>
            </div>

            <!-- Stations List -->
            <div class="space-y-3">
                <div v-for="station in stations" :key="station.id"
                     class="flex items-center justify-between p-4 border rounded-xl hover:border-orange-300 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl"
                             :style="{ backgroundColor: station.color + '20', color: station.color }">
                            {{ station.icon || 'üç≥' }}
                        </div>
                        <div>
                            <h4 class="font-medium">{{ station.name }}</h4>
                            <p class="text-sm text-gray-500">
                                <span class="font-mono text-xs bg-gray-100 px-1 rounded">{{ station.slug }}</span>
                                <span class="mx-2">¬∑</span>
                                {{ station.dishes_count || 0 }} –±–ª—é–¥
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span v-if="station.is_bar" class="px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-700">
                            üç∏ –ë–∞—Ä
                        </span>
                        <span :class="['px-2 py-1 rounded text-xs font-medium',
                                       station.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">
                            {{ station.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                        </span>
                        <button @click="copyKitchenUrl(station)" class="p-1.5 hover:bg-gray-100 rounded" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL">
                            üîó
                        </button>
                        <button @click="openStationModal(station)" class="p-1.5 hover:bg-gray-100 rounded" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </button>
                        <button @click="toggleStation(station)" class="p-1.5 hover:bg-gray-100 rounded" :title="station.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'">
                            {{ station.is_active ? 'üî¥' : 'üü¢' }}
                        </button>
                        <button v-can="'settings.edit'" @click="deleteStation(station)" class="p-1.5 hover:bg-gray-100 rounded text-red-500" title="–£–¥–∞–ª–∏—Ç—å">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>

                <div v-if="stations.length === 0" class="text-center py-12 text-gray-400">
                    <div class="text-4xl mb-2">üç≥</div>
                    <p>–¶–µ—Ö–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>
                    <button @click="openStationModal()" class="text-orange-500 hover:underline mt-2">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ü–µ—Ö</button>
                </div>
            </div>

            <!-- URL Info -->
            <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                <h4 class="font-medium text-blue-800 mb-2">–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</h4>
                <p class="text-sm text-blue-700">
                    –û—Ç–∫—Ä–æ–π—Ç–µ –∫—É—Ö–æ–Ω–Ω—ã–π –¥–∏—Å–ø–ª–µ–π —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º station –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:
                </p>
                <code class="block mt-2 p-2 bg-blue-100 rounded text-sm text-blue-800 font-mono">
                    /kitchen?station=hot
                </code>
                <p class="text-sm text-blue-600 mt-2">
                    –ë–ª—é–¥–∞ –±–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ü–µ—Ö–∞ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –Ω–∞ –≤—Å–µ—Ö –¥–∏—Å–ø–ª–µ—è—Ö.
                </p>
            </div>
        </div>

        <!-- Kitchen Devices -->
        <div v-if="subTab === 'devices'" class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-semibold">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫—É—Ö–Ω–∏</h3>
                    <p class="text-sm text-gray-500">–ü–ª–∞–Ω—à–µ—Ç—ã –∏ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã –¥–ª—è –∫—É—Ö–æ–Ω–Ω—ã—Ö –¥–∏—Å–ø–ª–µ–µ–≤</p>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="loadDevices" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition flex items-center gap-2">
                        <span>üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button @click="openCreateDeviceModal" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition flex items-center gap-2">
                        <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                    </button>
                </div>
            </div>

            <!-- Devices List -->
            <div class="space-y-3">
                <div v-for="device in devices" :key="device.id"
                     class="p-4 border rounded-xl hover:border-orange-300 transition">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <!-- Status indicator -->
                            <div class="relative">
                                <span class="text-3xl">üì±</span>
                                <span v-if="device.is_linked && isDeviceOnline(device)"
                                      class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></span>
                                <span v-else-if="device.is_linked"
                                      class="absolute -bottom-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></span>
                                <span v-else
                                      class="absolute -bottom-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full border-2 border-white"></span>
                            </div>
                            <div>
                                <h4 class="font-medium">{{ device.name }}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span v-if="device.kitchen_station"
                                          class="text-xs px-2 py-0.5 rounded-full"
                                          :style="{ backgroundColor: device.kitchen_station.color + '20', color: device.kitchen_station.color }">
                                        {{ device.kitchen_station.icon }} {{ device.kitchen_station.name }}
                                    </span>
                                    <span v-else class="text-xs px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700">
                                        –¶–µ—Ö –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                                    </span>
                                    <span v-if="device.is_linked" class="text-xs text-gray-400">
                                        {{ device.last_seen_at ? formatDate(device.last_seen_at) : '' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span :class="['px-2 py-1 rounded text-xs font-medium',
                                           !device.is_linked ? 'bg-blue-100 text-blue-700' :
                                           device.status === 'active' ? 'bg-green-100 text-green-700' :
                                           device.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                           'bg-red-100 text-red-700']">
                                {{ !device.is_linked ? '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω' :
                                   device.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' :
                                   device.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' : '–û—Ç–∫–ª—é—á—ë–Ω' }}
                            </span>
                            <button @click="openDeviceModal(device)" class="p-1.5 hover:bg-gray-100 rounded" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å">
                                ‚öôÔ∏è
                            </button>
                            <button v-can="'settings.edit'" @click="deleteDevice(device)" class="p-1.5 hover:bg-gray-100 rounded text-red-500" title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>

                    <!-- Linking code section (for unlinked devices) -->
                    <div v-if="!device.is_linked" class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-700 font-medium">–ö–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏:</p>
                                <p class="text-xs text-blue-500 mt-0.5">–í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ –≤ /kitchen</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div v-if="device.linking_code?.code" class="text-right">
                                    <span class="font-mono text-2xl font-bold text-blue-700 tracking-[0.2em]">{{ device.linking_code.code }}</span>
                                    <p class="text-xs text-blue-400">{{ Math.ceil(device.linking_code.expires_in_seconds / 60) }} –º–∏–Ω</p>
                                </div>
                                <div v-else class="text-sm text-blue-400">
                                    –ö–æ–¥ –∏—Å—Ç—ë–∫
                                </div>
                                <button
                                    @click="regenerateLinkingCode(device)"
                                    class="p-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition"
                                    title="–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥"
                                >
                                    üîÑ
                                </button>
                                <button
                                    @click="copyLinkingCode(device)"
                                    v-if="device.linking_code?.code"
                                    class="p-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition"
                                    title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
                                >
                                    üìã
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Linked device info -->
                    <div v-else class="mt-3 flex items-center justify-between text-xs text-gray-500">
                        <span class="font-mono">ID: {{ device.device_id }}</span>
                        <button
                            @click="unlinkDevice(device)"
                            class="text-orange-500 hover:text-orange-700 transition"
                        >
                            –û—Ç–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                        </button>
                    </div>
                </div>

                <div v-if="devices.length === 0" class="text-center py-12 text-gray-400">
                    <div class="text-4xl mb-2">üì±</div>
                    <p>–ù–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</p>
                    <p class="text-sm mt-2">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è</p>
                </div>
            </div>

            <!-- How it works -->
            <div class="mt-6 p-4 bg-green-50 rounded-xl">
                <h4 class="font-medium text-green-800 mb-2">–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h4>
                <ol class="text-sm text-green-700 list-decimal list-inside space-y-1">
                    <li>–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –µ–≥–æ (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ—Ö)</li>
                    <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏</li>
                    <li>–û—Ç–∫—Ä–æ–π—Ç–µ <code class="bg-green-100 px-1 rounded">/kitchen</code> –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ</li>
                    <li>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ - —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—Ä–∏–≤—è–∂–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                </ol>
                <p class="text-xs text-green-600 mt-2">–ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç 10 –º–∏–Ω—É—Ç. –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</p>
            </div>
        </div>

        <!-- Device Modal -->
        <Teleport to="body">
            <div v-if="showDeviceModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showDeviceModal = false">
                <div class="bg-white rounded-2xl w-[500px] p-6 shadow-2xl">
                    <h3 class="text-lg font-semibold mb-4">{{ deviceForm.id ? '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞' : '–ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ' }}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input v-model="deviceForm.name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="–ü–ª–∞–Ω—à–µ—Ç –≥–æ—Ä—è—á–µ–≥–æ —Ü–µ—Ö–∞">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ—Ö</label>
                            <select v-model="deviceForm.kitchen_station_id" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option :value="null">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω (–≤—Å–µ –∑–∞–∫–∞–∑—ã)</option>
                                <option v-for="s in stations" :key="s.id" :value="s.id">
                                    {{ s.icon }} {{ s.name }}
                                </option>
                            </select>
                        </div>
                        <div v-if="deviceForm.id">
                            <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å</label>
                            <select v-model="deviceForm.status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option value="pending">–û–∂–∏–¥–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</option>
                                <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
                                <option value="disabled">–û—Ç–∫–ª—é—á—ë–Ω</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">PIN –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞–Ω—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input v-model="deviceForm.pin" type="text" maxlength="6" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono tracking-widest" placeholder="123456">
                            <p class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –ø–æ–≤–∞—Ä —Å–º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å —Ü–µ—Ö —Ç–æ–ª—å–∫–æ –≤–≤–µ–¥—è —ç—Ç–æ—Ç PIN</p>
                        </div>

                        <!-- Device info (only for existing linked devices) -->
                        <div v-if="deviceForm.id && deviceForm.device_id" class="p-3 bg-gray-50 rounded-lg text-sm">
                            <div class="grid grid-cols-2 gap-2 text-gray-600">
                                <div>
                                    <span class="text-gray-400">ID:</span>
                                    <span class="font-mono text-xs ml-1">{{ deviceForm.device_id }}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">IP:</span>
                                    <span class="ml-1">{{ deviceForm.ip_address || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω' }}</span>
                                </div>
                                <div class="col-span-2">
                                    <span class="text-gray-400">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
                                    <span class="ml-1">{{ deviceForm.last_seen_at ? formatDate(deviceForm.last_seen_at) : '–ù–∏–∫–æ–≥–¥–∞' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button @click="showDeviceModal = false" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">–û—Ç–º–µ–Ω–∞</button>
                        <button @click="saveDevice" :disabled="!deviceForm.name" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:bg-gray-300 disabled:text-gray-500 transition">
                            {{ deviceForm.id ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å' }}
                        </button>
                    </div>
                </div>
            </div>
        </Teleport>

        <!-- Station Modal -->
        <Teleport to="body">
            <div v-if="showStationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showStationModal = false">
                <div class="bg-white rounded-2xl w-[500px] p-6 shadow-2xl">
                    <h3 class="text-lg font-semibold mb-4">{{ stationForm.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ—Ö' : '–ù–æ–≤—ã–π —Ü–µ—Ö' }}</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                                <input v-model="stationForm.name" @input="generateSlug" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="–ì–æ—Ä—è—á–∏–π —Ü–µ—Ö">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Slug (URL)</label>
                                <input v-model="stationForm.slug" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono" placeholder="hot">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ò–∫–æ–Ω–∫–∞</label>
                                <div class="flex gap-2">
                                    <input v-model="stationForm.icon" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-center text-xl" placeholder="üî•">
                                    <div class="flex gap-1">
                                        <button v-for="emoji in stationEmojis" :key="emoji" @click="stationForm.icon = emoji"
                                                class="w-10 h-10 border rounded-lg hover:bg-gray-100 text-lg">{{ emoji }}</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–¶–≤–µ—Ç</label>
                                <div class="flex gap-2">
                                    <input v-model="stationForm.color" type="color" class="w-12 h-10 border rounded-lg cursor-pointer">
                                    <input v-model="stationForm.color" class="flex-1 px-4 py-2 border rounded-lg font-mono" placeholder="#EF4444">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <input v-model="stationForm.description" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="–ì–æ—Ä—è—á–∏–µ –±–ª—é–¥–∞, —Å—É–ø—ã, –≥–∞—Ä–Ω–∏—Ä—ã">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üîî –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                            <div class="flex gap-2">
                                <select v-model="stationForm.notification_sound" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="bell">üîî –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫</option>
                                    <option value="chime">üéµ –ü–µ—Ä–µ–∑–≤–æ–Ω</option>
                                    <option value="ding">üì¢ –î–∏–Ω–≥</option>
                                    <option value="kitchen">üç≥ –ö—É—Ö–æ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫</option>
                                    <option value="alert">‚ö†Ô∏è –°–∏–≥–Ω–∞–ª</option>
                                    <option value="gong">üé∂ –ì–æ–Ω–≥</option>
                                </select>
                                <button type="button" @click="playStationSound(stationForm.notification_sound)"
                                        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition flex items-center gap-1"
                                        title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å –∑–≤—É–∫">
                                    ‚ñ∂Ô∏è –¢–µ—Å—Ç
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">–†–∞–∑–Ω—ã–µ –∑–≤—É–∫–∏ –ø–æ–º–æ–≥—É—Ç —Ä–∞–∑–ª–∏—á–∞—Ç—å —Å—Ç–∞–Ω—Ü–∏–∏ –Ω–∞ —Å–ª—É—Ö</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
                                <input v-model.number="stationForm.sort_order" type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                            <div class="flex flex-col gap-3 justify-end">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" v-model="stationForm.is_active" class="w-5 h-5 accent-orange-500">
                                    <span class="text-sm text-gray-700">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" v-model="stationForm.is_bar" class="w-5 h-5 accent-purple-500">
                                    <span class="text-sm text-gray-700">–≠—Ç–æ –±–∞—Ä</span>
                                    <span class="text-xs text-purple-500">(–ø–∞–Ω–µ–ª—å –Ω–∞ POS)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button @click="showStationModal = false" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">–û—Ç–º–µ–Ω–∞</button>
                        <button @click="saveStation" :disabled="!stationForm.name" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition disabled:opacity-50">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </Teleport>

        <!-- Printer Modal -->
        <Teleport to="body">
            <div v-if="showPrinterModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showPrinterModal = false">
                <div class="bg-white rounded-2xl w-[600px] max-h-[90vh] overflow-y-auto p-6 shadow-2xl">
                    <h3 class="text-lg font-semibold mb-4">{{ printerForm.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä' : '–ù–æ–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä' }}</h3>
                    <div class="space-y-4">
                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input v-model="printerForm.name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="–ß–µ–∫–æ–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä - –∫–∞—Å—Å–∞">
                        </div>

                        <!-- –¢–∏–ø –ø—Ä–∏–Ω—Ç–µ—Ä–∞ -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∏–ø –ø—Ä–∏–Ω—Ç–µ—Ä–∞ *</label>
                                <select v-model="printerForm.type" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="receipt">üßæ –ö–∞—Å—Å–∞ (—á–µ–∫–∏, —Å—á–µ—Ç–∞)</option>
                                    <option value="kitchen">üç≥ –ö—É—Ö–Ω—è</option>
                                    <option value="bar">üç∏ –ë–∞—Ä</option>
                                    <option value="delivery">üöó –î–æ—Å—Ç–∞–≤–∫–∞</option>
                                    <option value="label">üè∑Ô∏è –≠—Ç–∏–∫–µ—Ç–∫–∏</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è *</label>
                                <select v-model="printerForm.connection_type" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="network">üåê –°–µ—Ç—å (IP)</option>
                                    <option value="usb">üîå USB / COM</option>
                                    <option value="file">üìÅ –§–∞–π–ª (—Ç–µ—Å—Ç)</option>
                                </select>
                            </div>
                        </div>

                        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –°–µ—Ç—å -->
                        <div v-if="printerForm.connection_type === 'network'" class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IP –∞–¥—Ä–µ—Å *</label>
                                <input v-model="printerForm.ip_address" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono" placeholder="192.168.1.100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ—Ä—Ç</label>
                                <input v-model.number="printerForm.port" type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono" placeholder="9100">
                            </div>
                        </div>

                        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: USB -->
                        <div v-if="printerForm.connection_type === 'usb'">
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ü—É—Ç—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É *</label>
                            <input v-model="printerForm.device_path" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono" placeholder="COM1 –∏–ª–∏ /dev/usb/lp0">
                            <p class="text-xs text-gray-500 mt-1">Windows: COM1, COM2... | Linux: /dev/usb/lp0, /dev/ttyUSB0</p>
                        </div>

                        <!-- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ü–µ—Ö—É (–¥–ª—è –∫—É—Ö–Ω–∏/–±–∞—Ä–∞) -->
                        <div v-if="printerForm.type === 'kitchen' || printerForm.type === 'bar'">
                            <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <select v-model="printerForm.kitchen_station_id" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option :value="null">–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)</option>
                                <option v-for="s in stations" :key="s.id" :value="s.id">
                                    {{ s.icon }} {{ s.name }}
                                </option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ü–µ—Ö, –Ω–∞ —ç—Ç–æ—Ç –ø—Ä–∏–Ω—Ç–µ—Ä –±—É–¥—É—Ç –ø–µ—á–∞—Ç–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –±–ª—é–¥–∞ —ç—Ç–æ–≥–æ —Ü–µ—Ö–∞</p>
                        </div>

                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–º–∞–≥–∏ -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–®–∏—Ä–∏–Ω–∞ –±—É–º–∞–≥–∏</label>
                                <select v-model.number="printerForm.paper_width" @change="updateCharsPerLine" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option :value="80">80 –º–º (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                                    <option :value="58">58 –º–º (—É–∑–∫–∏–π)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–æ–¥–∏—Ä–æ–≤–∫–∞</label>
                                <select v-model="printerForm.encoding" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="cp866">CP866 (DOS —Ä—É—Å—Å–∫–∏–π)</option>
                                    <option value="cp1251">CP1251 (Windows)</option>
                                    <option value="utf8">UTF-8</option>
                                </select>
                            </div>
                        </div>

                        <!-- –û–ø—Ü–∏–∏ –ø–µ—á–∞—Ç–∏ -->
                        <div class="border rounded-xl p-4 space-y-3">
                            <div class="text-sm font-medium text-gray-700 mb-2">–û–ø—Ü–∏–∏ –ø–µ—á–∞—Ç–∏</div>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" v-model="printerForm.cut_paper" class="w-5 h-5 accent-orange-500">
                                    <span class="text-sm text-gray-700">‚úÇÔ∏è –û—Ç—Ä–µ–∑–∫–∞ –±—É–º–∞–≥–∏</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" v-model="printerForm.open_drawer" class="w-5 h-5 accent-orange-500">
                                    <span class="text-sm text-gray-700">üóÉÔ∏è –û—Ç–∫—Ä—ã–≤–∞—Ç—å —è—â–∏–∫</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" v-model="printerForm.print_qr" class="w-5 h-5 accent-orange-500">
                                    <span class="text-sm text-gray-700">üì± QR-–∫–æ–¥ –Ω–∞ —á–µ–∫–µ</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" v-model="printerForm.print_logo" class="w-5 h-5 accent-orange-500">
                                    <span class="text-sm text-gray-700">üñºÔ∏è –õ–æ–≥–æ—Ç–∏–ø</span>
                                </label>
                            </div>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å -->
                        <div class="flex items-center justify-between border rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="printerForm.is_active" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-green-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                </label>
                                <span class="text-sm text-gray-700">–ê–∫—Ç–∏–≤–µ–Ω</span>
                            </div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" v-model="printerForm.is_default" class="w-5 h-5 accent-orange-500">
                                <span class="text-sm text-gray-700">‚≠ê –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button @click="showPrinterModal = false" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">–û—Ç–º–µ–Ω–∞</button>
                        <button @click="savePrinter" :disabled="!canSavePrinter" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition disabled:opacity-50">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </Teleport>

        <!-- Yandex Maps Modal -->
        <Teleport to="body">
            <div v-if="showYandexModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showYandexModal = false">
                <div class="bg-white rounded-2xl w-[550px] p-6 shadow-2xl">
                    <h3 class="text-lg font-semibold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç</h3>

                    <!-- Enable toggle -->
                    <div class="flex items-center justify-between p-4 border rounded-xl mb-4">
                        <div>
                            <div class="font-medium">–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é</div>
                            <div class="text-sm text-gray-500">–ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –∏ —Ä–∞—Å—á—ë—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="yandexForm.enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                        </label>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API –∫–ª—é—á –Ø–Ω–¥–µ–∫—Å *</label>
                            <input v-model="yandexForm.api_key"
                                   type="password"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono"
                                   placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            <p class="text-xs text-gray-500 mt-1">
                                –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –≤ <a href="https://developer.tech.yandex.ru/" target="_blank" class="text-orange-500 hover:underline">–ö–∞–±–∏–Ω–µ—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –Ø–Ω–¥–µ–∫—Å</a>
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ì–æ—Ä–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                            <input v-model="yandexForm.city"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                   placeholder="–ú–æ—Å–∫–≤–∞">
                            <p class="text-xs text-gray-500 mt-1">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–ø–æ–ª–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤</p>
                        </div>

                        <!-- –ê–¥—Ä–µ—Å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ê–¥—Ä–µ—Å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</label>
                            <div class="flex gap-2">
                                <input v-model="yandexForm.restaurant_address"
                                       class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 1"
                                       @keyup.enter="geocodeRestaurantAddress">
                                <button @click="geocodeRestaurantAddress"
                                        :disabled="!yandexForm.api_key || !yandexForm.restaurant_address || geocodingAddress"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition disabled:opacity-50 whitespace-nowrap flex items-center gap-2">
                                    <span v-if="geocodingAddress" class="animate-spin">‚è≥</span>
                                    <span v-else>üìç</span>
                                    –ù–∞–π—Ç–∏
                                </button>
                            </div>
                            <p v-if="geocodeAddressResult" class="text-xs mt-1"
                               :class="geocodeAddressResult.success ? 'text-green-600' : 'text-red-500'">
                                {{ geocodeAddressResult.message }}
                            </p>
                            <p v-else class="text-xs text-gray-500 mt-1">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–®–∏—Ä–æ—Ç–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ *</label>
                                <input v-model="yandexForm.restaurant_lat"
                                       type="number"
                                       step="0.000001"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono"
                                       placeholder="55.751244">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–î–æ–ª–≥–æ—Ç–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ *</label>
                                <input v-model="yandexForm.restaurant_lng"
                                       type="number"
                                       step="0.000001"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono"
                                       placeholder="37.618423">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 -mt-2">
                            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–¥—Ä–µ—Å–∞, –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.
                        </p>

                        <!-- Test connection -->
                        <div class="p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium text-sm">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                                    <div class="text-xs text-gray-500">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≥–µ–æ–∫–æ–¥–µ—Ä–∞</div>
                                </div>
                                <button @click="testYandexConnection"
                                        :disabled="!yandexForm.api_key || yandexTestingConnection"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition disabled:opacity-50 flex items-center gap-2">
                                    <span v-if="yandexTestingConnection" class="animate-spin">‚è≥</span>
                                    <span v-else>üîå</span>
                                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                </button>
                            </div>
                            <div v-if="yandexTestResult" class="mt-3 p-3 rounded-lg text-sm"
                                 :class="yandexTestResult.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                {{ yandexTestResult.message }}
                            </div>
                        </div>

                        <!-- API limits info -->
                        <div class="p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                            <div class="font-medium mb-1">–õ–∏–º–∏—Ç—ã API</div>
                            <ul class="list-disc list-inside text-xs space-y-1">
                                <li>–ì–µ–æ–∫–æ–¥–µ—Ä: 10 000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å—É—Ç–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)</li>
                                <li>JavaScript API: –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</li>
                            </ul>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button @click="showYandexModal = false" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">–û—Ç–º–µ–Ω–∞</button>
                        <button @click="saveYandexSettings"
                                :disabled="!yandexForm.api_key || !yandexForm.restaurant_lat || !yandexForm.restaurant_lng"
                                class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition disabled:opacity-50">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </Teleport>

        <!-- Subscription Settings -->
        <SubscriptionTab v-if="subTab === 'subscription'" />

        <!-- Locations / Points of Sale -->
        <div v-if="subTab === 'locations'" class="space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-semibold">–¢–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂</h3>
                        <p class="text-sm text-gray-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º–∏ –∏ —Ñ–∏–ª–∏–∞–ª–∞–º–∏</p>
                    </div>
                    <button @click="openLocationModal()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É
                    </button>
                </div>

                <!-- Locations list -->
                <div v-if="locations.length === 0" class="text-center py-12 text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <p>–ù–µ—Ç —Ç–æ—á–µ–∫ –ø—Ä–æ–¥–∞–∂</p>
                </div>

                <div v-else class="space-y-3">
                    <div v-for="loc in locations" :key="loc.id"
                         :class="['border rounded-xl overflow-hidden transition', loc.is_current ? 'border-orange-500 bg-orange-50' : '']">
                        <!-- Location Header -->
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold text-lg">{{ loc.name }}</span>
                                        <span v-if="loc.is_main" class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-medium">–ì–ª–∞–≤–Ω–∞—è</span>
                                        <span v-if="loc.is_current" class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">–¢–µ–∫—É—â–∞—è</span>
                                        <span v-if="!loc.is_active" class="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-medium">–û—Ç–∫–ª—é—á–µ–Ω–∞</span>
                                    </div>
                                    <div class="text-sm text-gray-500 space-y-1">
                                        <p v-if="loc.address">{{ loc.address }}</p>
                                        <p v-if="loc.phone || loc.email" class="flex items-center gap-3">
                                            <span v-if="loc.phone">{{ loc.phone }}</span>
                                            <span v-if="loc.email">{{ loc.email }}</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button v-if="!loc.is_current" @click="switchLocation(loc)"
                                            class="px-3 py-1.5 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">
                                        –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è
                                    </button>
                                    <button @click="openLocationModal(loc)"
                                            class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button v-if="!loc.is_main" @click="makeMainLocation(loc)"
                                            class="p-2 text-gray-400 hover:text-orange-500 hover:bg-orange-50 rounded-lg transition"
                                            title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω–æ–π">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                        </svg>
                                    </button>
                                    <button v-if="!loc.is_main" v-can="'settings.edit'" @click="deleteLocation(loc)"
                                            class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Legal Entities Section -->
                        <div class="border-t bg-gray-50">
                            <button @click="toggleLocationLegalEntities(loc.id)"
                                    class="w-full px-4 py-3 flex items-center justify-between text-sm hover:bg-gray-100 transition">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">üè¢</span>
                                    <span class="font-medium text-gray-700">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ª–∏—Ü–∞</span>
                                    <span class="px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full text-xs">
                                        {{ getLocationLegalEntities(loc.id).length }}
                                    </span>
                                </div>
                                <svg :class="['w-5 h-5 text-gray-400 transition-transform', expandedLocationEntities.has(loc.id) ? 'rotate-180' : '']"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>

                            <!-- Expanded Legal Entities -->
                            <div v-if="expandedLocationEntities.has(loc.id)" class="px-4 pb-4">
                                <div v-if="getLocationLegalEntities(loc.id).length === 0" class="text-center py-6 text-gray-500">
                                    <p class="mb-2">–ù–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü</p>
                                    <button @click="openLegalEntityModal(loc.id)"
                                            class="text-orange-500 hover:text-orange-600 text-sm font-medium">
                                        + –î–æ–±–∞–≤–∏—Ç—å —é—Ä–ª–∏—Ü–æ
                                    </button>
                                </div>
                                <div v-else class="space-y-2">
                                    <div v-for="entity in getLocationLegalEntities(loc.id)" :key="entity.id"
                                         class="bg-white rounded-lg p-3 border flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div :class="[
                                                'w-10 h-10 rounded-lg flex items-center justify-center text-xs font-bold',
                                                entity.type === 'llc' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'
                                            ]">
                                                {{ entity.type === 'llc' ? '–û–û–û' : '–ò–ü' }}
                                            </div>
                                            <div>
                                                <div class="flex items-center gap-2">
                                                    <span class="font-medium text-gray-900">{{ entity.name }}</span>
                                                    <span v-if="entity.is_default" class="text-xs px-1.5 py-0.5 bg-orange-100 text-orange-600 rounded">
                                                        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                                                    </span>
                                                </div>
                                                <div class="text-xs text-gray-500">–ò–ù–ù: {{ entity.inn }}</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button @click="openLegalEntityModal(loc.id, entity)"
                                                    class="p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded transition">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </button>
                                            <button v-can="'settings.edit'" @click="deleteLegalEntity(entity)"
                                                    class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <button @click="openLegalEntityModal(loc.id)"
                                            class="w-full py-2 text-sm text-orange-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition">
                                        + –î–æ–±–∞–≤–∏—Ç—å —é—Ä–ª–∏—Ü–æ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Plan limit warning -->
                <div v-if="locationLimitReached" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                    <div class="flex items-start gap-3">
                        <svg class="w-6 h-6 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <div>
                            <p class="font-medium text-yellow-800">–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Ç–æ—á–µ–∫ –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞</p>
                            <p class="text-sm text-yellow-700 mt-1">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π —Ç–∞—Ä–∏—Ñ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ç–æ—á–µ–∫ –ø—Ä–æ–¥–∞–∂.</p>
                            <button @click="subTab = 'subscription'" class="mt-2 text-sm text-orange-600 hover:text-orange-700 font-medium">
                                –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ &rarr;
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Modal -->
        <Teleport to="body">
            <div v-if="showLocationModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showLocationModal = false">
                <div class="bg-white rounded-2xl w-[500px] max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold">{{ locationForm.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É' : '–ù–æ–≤–∞—è —Ç–æ—á–∫–∞ –ø—Ä–æ–¥–∞–∂' }}</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-red-500">*</span></label>
                            <input v-model="locationForm.name" type="text" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞ –ü—É—à–∫–∏–Ω–∞"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å</label>
                            <input v-model="locationForm.address" type="text" placeholder="—É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input v-model="locationForm.phone" type="tel" placeholder="+7 (999) 123-45-67"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input v-model="locationForm.email" type="email" placeholder="branch@example.com"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="flex items-center gap-3 pt-2">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" v-model="locationForm.is_active" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-5"></div>
                            </label>
                            <span class="text-sm text-gray-700">–¢–æ—á–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
                        </div>
                    </div>
                    <div class="p-6 border-t bg-gray-50 flex gap-3">
                        <button @click="showLocationModal = false" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button @click="saveLocation" :disabled="!locationForm.name || savingLocation"
                                class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition disabled:opacity-50">
                            {{ savingLocation ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
                        </button>
                    </div>
                </div>
            </div>
        </Teleport>

        <!-- Legal Entity Modal -->
        <Teleport to="body">
            <div v-if="showLegalEntityModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showLegalEntityModal = false">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="px-6 py-4 border-b flex items-center justify-between">
                        <h3 class="text-lg font-semibold">{{ legalEntityForm.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–æ–µ' }} —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</h3>
                        <button @click="showLegalEntityModal = false" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-3">–û—Å–Ω–æ–≤–Ω–æ–µ</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-sm text-gray-600 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                                    <input v-model="legalEntityForm.name" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           placeholder="–û–û–û –†–µ—Å—Ç–æ—Ä–∞–Ω" />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input v-model="legalEntityForm.short_name" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           placeholder="–û–û–û (–¥–ª—è —á–µ–∫–∞)" />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–¢–∏–ø *</label>
                                    <select v-model="legalEntityForm.type"
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="llc">–û–û–û</option>
                                        <option value="ie">–ò–ü</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–ò–ù–ù *</label>
                                    <input v-model="legalEntityForm.inn" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           :placeholder="legalEntityForm.type === 'ie' ? '12 —Ü–∏—Ñ—Ä' : '10 —Ü–∏—Ñ—Ä'" />
                                </div>
                                <div v-if="legalEntityForm.type === 'llc'">
                                    <label class="block text-sm text-gray-600 mb-1">–ö–ü–ü</label>
                                    <input v-model="legalEntityForm.kpp" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           placeholder="9 —Ü–∏—Ñ—Ä" />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–û–ì–†–ù</label>
                                    <input v-model="legalEntityForm.ogrn" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           :placeholder="legalEntityForm.type === 'ie' ? '–û–ì–†–ù–ò–ü (15 —Ü–∏—Ñ—Ä)' : '–û–ì–†–ù (13 —Ü–∏—Ñ—Ä)'" />
                                </div>
                            </div>
                        </div>

                        <!-- –ê–¥—Ä–µ—Å–∞ -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-3">–ê–¥—Ä–µ—Å–∞</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                                    <input v-model="legalEntityForm.legal_address" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                                    <input v-model="legalEntityForm.actual_address" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                </div>
                            </div>
                        </div>

                        <!-- –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-3">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–§–ò–û</label>
                                    <input v-model="legalEntityForm.director_name" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                                    <input v-model="legalEntityForm.director_position" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           placeholder="–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä" />
                                </div>
                            </div>
                        </div>

                        <!-- –ë–∞–Ω–∫ -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-3">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-sm text-gray-600 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞</label>
                                    <input v-model="legalEntityForm.bank_name" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–ë–ò–ö</label>
                                    <input v-model="legalEntityForm.bank_bik" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           placeholder="9 —Ü–∏—Ñ—Ä" />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–ö–æ—Ä—Ä. —Å—á—ë—Ç</label>
                                    <input v-model="legalEntityForm.bank_corr_account" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           placeholder="20 —Ü–∏—Ñ—Ä" />
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm text-gray-600 mb-1">–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</label>
                                    <input v-model="legalEntityForm.bank_account" type="text"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                           placeholder="20 —Ü–∏—Ñ—Ä" />
                                </div>
                            </div>
                        </div>

                        <!-- –ù–∞–ª–æ–≥–∏ -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-3">–ù–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–µ</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–°–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è</label>
                                    <select v-model="legalEntityForm.taxation_system"
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="osn">–û–°–ù (–æ–±—â–∞—è)</option>
                                        <option value="usn_income">–£–°–ù (–¥–æ—Ö–æ–¥—ã 6%)</option>
                                        <option value="usn_income_expense">–£–°–ù (–¥–æ—Ö–æ–¥—ã-—Ä–∞—Å—Ö–æ–¥—ã 15%)</option>
                                        <option value="patent">–ü–∞—Ç–µ–Ω—Ç</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">–°—Ç–∞–≤–∫–∞ –ù–î–°</label>
                                    <select v-model="legalEntityForm.vat_rate"
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option :value="null">–ë–µ–∑ –ù–î–°</option>
                                        <option :value="0">0%</option>
                                        <option :value="10">10%</option>
                                        <option :value="20">20%</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- –ê–ª–∫–æ–≥–æ–ª—å -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-3">–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ –∞–ª–∫–æ–≥–æ–ª—å</h4>
                            <div class="space-y-3">
                                <label class="flex items-center gap-2">
                                    <input v-model="legalEntityForm.has_alcohol_license" type="checkbox"
                                           class="rounded text-orange-500 focus:ring-orange-500" />
                                    <span class="text-sm text-gray-700">–ï—Å—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ –∞–ª–∫–æ–≥–æ–ª—å</span>
                                </label>
                                <div v-if="legalEntityForm.has_alcohol_license" class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">–ù–æ–º–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–∏</label>
                                        <input v-model="legalEntityForm.alcohol_license_number" type="text"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                                        <input v-model="legalEntityForm.alcohol_license_expires_at" type="date"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å -->
                        <div class="flex items-center gap-6">
                            <label class="flex items-center gap-2">
                                <input v-model="legalEntityForm.is_active" type="checkbox"
                                       class="rounded text-orange-500 focus:ring-orange-500" />
                                <span class="text-sm text-gray-700">–ê–∫—Ç–∏–≤–µ–Ω</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input v-model="legalEntityForm.is_default" type="checkbox"
                                       class="rounded text-orange-500 focus:ring-orange-500" />
                                <span class="text-sm text-gray-700">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                            </label>
                        </div>
                    </div>

                    <div class="px-6 py-4 border-t flex justify-end gap-3">
                        <button @click="showLegalEntityModal = false"
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button @click="saveLegalEntity" :disabled="!legalEntityForm.name || !legalEntityForm.inn || savingLegalEntity"
                                class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition disabled:opacity-50">
                            {{ savingLegalEntity ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : (legalEntityForm.id ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å') }}
                        </button>
                    </div>
                </div>
            </div>
        </Teleport>
    </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useBackofficeStore } from '../../stores/backoffice';
import SubscriptionTab from './SubscriptionTab.vue';

const store = useBackofficeStore();

// State
const subTab = ref('general');

// Locations state
const locations = ref<any[]>([]);
const showLocationModal = ref(false);
const savingLocation = ref(false);
const locationLimitReached = ref(false);
const locationForm = ref({
    id: null as any,
    name: '',
    address: '',
    phone: '',
    email: '',
    is_active: true
});

// Legal Entities state
const legalEntities = ref<any[]>([]);
const expandedLocationEntities = ref(new Set());
const showLegalEntityModal = ref(false);
const savingLegalEntity = ref(false);
const legalEntityForm = ref({
    id: null as any,
    restaurant_id: null as any,
    name: '',
    short_name: '',
    type: 'llc',
    inn: '',
    kpp: '',
    ogrn: '',
    legal_address: '',
    actual_address: '',
    director_name: '',
    director_position: '',
    bank_name: '',
    bank_bik: '',
    bank_account: '',
    bank_corr_account: '',
    taxation_system: 'usn_income',
    vat_rate: null as any,
    has_alcohol_license: false,
    alcohol_license_number: '',
    alcohol_license_expires_at: null as any,
    is_active: true,
    is_default: false
});

const showPrinterModal = ref(false);
const showStationModal = ref(false);
const showDeviceModal = ref(false);
const showYandexModal = ref(false);
const yandexTestingConnection = ref(false);
const yandexTestResult = ref<any>(null);
const geocodingAddress = ref(false);
const geocodeAddressResult = ref<any>(null);

// Settings
const settings = ref({
    name: '',
    address: '',
    phone: '',
    email: '',
    currency: 'RUB',
    timezone: 'Europe/Moscow',
    round_amounts: false,
    business_day_ends_at: 5, // –ß–∞—Å –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 05:00)
    working_hours: {
        monday: { enabled: true, open: '10:00', close: '23:00' },
        tuesday: { enabled: true, open: '10:00', close: '23:00' },
        wednesday: { enabled: true, open: '10:00', close: '23:00' },
        thursday: { enabled: true, open: '10:00', close: '23:00' },
        friday: { enabled: true, open: '10:00', close: '23:00' },
        saturday: { enabled: true, open: '10:00', close: '23:00' },
        sunday: { enabled: true, open: '10:00', close: '23:00' }
    } as Record<string, { enabled: boolean; open: string; close: string }>
});

// Days of week for working hours
const daysOfWeek = [
    { key: 'monday', label: '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', short: '–ü–Ω' },
    { key: 'tuesday', label: '–í—Ç–æ—Ä–Ω–∏–∫', short: '–í—Ç' },
    { key: 'wednesday', label: '–°—Ä–µ–¥–∞', short: '–°—Ä' },
    { key: 'thursday', label: '–ß–µ—Ç–≤–µ—Ä–≥', short: '–ß—Ç' },
    { key: 'friday', label: '–ü—è—Ç–Ω–∏—Ü–∞', short: '–ü—Ç' },
    { key: 'saturday', label: '–°—É–±–±–æ—Ç–∞', short: '–°–±' },
    { key: 'sunday', label: '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', short: '–í—Å' }
];

const integrations = ref({
    atol: { enabled: false },
    telegram: { enabled: false },
    yandex: { enabled: false }
});

// Yandex Form
const yandexForm = ref({
    enabled: false,
    api_key: '',
    city: '',
    restaurant_address: '',
    restaurant_lat: '',
    restaurant_lng: ''
});

const printers = ref<any[]>([]);
const systemPrinters = ref<any[]>([]);
const scanningPrinters = ref(false);
const scannedOnce = ref(false);

// –¢–∏–ø –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —á–µ–∫–∞
const receiptPreviewType = ref('dine_in');
const receiptSubTab = ref('guest');
const testingPrint = ref(false);
const previewPrinterWidth = ref('80'); // 58 –∏–ª–∏ 80 –º–º

const printSettings = ref({
    // –ê–≤—Ç–æ–ø–µ—á–∞—Ç—å
    auto_print_kitchen: true,
    auto_print_new_items: true,
    auto_print_receipt: false,
    receipt_copies: 1,
    kitchen_copies: 1,

    // –®–∞–ø–∫–∞ —á–µ–∫–∞
    receipt_header_name: '',
    receipt_header_address: '',
    receipt_header_phone: '',
    receipt_header_inn: '',

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—á–∞—Ç–∏
    print_logo: false,
    print_qr: false,
    qr_url: '',
    qr_text: '–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –æ—Ç–∑—ã–≤–∞',

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —á–µ–∫–µ –≥–æ—Å—Ç—è
    show_waiter: true,
    show_table: true,
    show_guests_count: false,
    show_order_number: true,
    show_order_time: true,
    show_payment_method: true,

    // –§—É—Ç–µ—Ä —á–µ–∫–∞
    receipt_footer_line1: '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∏–∑–∏—Ç!',
    receipt_footer_line2: '–ñ–¥–µ–º –≤–∞—Å —Å–Ω–æ–≤–∞!',

    // –§—É—Ç–µ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏
    delivery_footer_line1: '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!',
    delivery_footer_line2: '–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!',

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —á–µ–∫–µ –¥–æ—Å—Ç–∞–≤–∫–∏
    delivery_show_customer: true,
    delivery_show_phone: true,
    delivery_show_address: true,
    delivery_show_entrance: true,
    delivery_show_intercom: true,
    delivery_show_courier: true,
    delivery_show_comment: true,

    // –ö—É—Ö–Ω—è
    kitchen_beep: true,
    kitchen_large_font: true,
    kitchen_bold_items: true,
    kitchen_header_text: '–ù–û–í–´–ô –ó–ê–ö–ê–ó',
    kitchen_show_table: true,
    kitchen_show_waiter: true,
    kitchen_show_order_number: true,
    kitchen_show_time: true,
    kitchen_show_order_type: true,
    kitchen_show_modifiers: true,
    kitchen_show_comments: true,

    // –ü—Ä–µ—á–µ–∫
    precheck_title: '–ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –°–ß–Å–¢',
    precheck_subtitle: '(–Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏—Å–∫–∞–ª—å–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º)',
    precheck_show_table: true,
    precheck_show_waiter: true,
    precheck_show_date: true,
    precheck_show_guests: false,
    precheck_footer: '–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!',
});

const stations = ref<any[]>([]);

const devices = ref<any[]>([]);

const notifications = ref({
    newOrder: true,
    orderReady: true,
    dailyReport: false,
    telegram: false
});

// Forms
const printerForm = ref({
    id: null as any,
    name: '',
    type: 'receipt',
    kitchen_station_id: null as any,
    connection_type: 'network',
    ip_address: '',
    port: 9100,
    device_path: '',
    paper_width: 80,
    chars_per_line: 48,
    encoding: 'cp866',
    cut_paper: true,
    open_drawer: false,
    print_logo: false,
    print_qr: true,
    is_active: true,
    is_default: false
});

const stationForm = ref({
    id: null as any,
    name: '',
    slug: '',
    icon: '',
    color: '#6366F1',
    description: '',
    notification_sound: 'bell',
    sort_order: 0,
    is_active: true,
    is_bar: false
});

const deviceForm = ref({
    id: null as any,
    device_id: '',
    name: '',
    kitchen_station_id: null as any,
    status: 'pending',
    pin: '',
    ip_address: '',
    last_seen_at: null as any
});

// Constants
const stationEmojis = ['üî•', '‚ùÑÔ∏è', 'ü•©', 'üçï', 'üç£', 'üç∏', 'üç∞', 'ü•ó'];
const printerDestinations = [
    { key: 'receipt', label: '–ß–µ–∫–∏' },
    { key: 'precheck', label: '–°—á–µ—Ç–∞' },
    { key: 'kitchen', label: '–ö—É—Ö–Ω—è' },
    { key: 'bar', label: '–ë–∞—Ä' }
];

// Methods
async function loadSettings() {
    try {
        const res = await store.api('/backoffice/settings') as Record<string, any>;
        if (res.settings) {
            const s = res.settings as Record<string, any>;
            // Defaults for fields stored in cache
            const defaults = {
                working_hours: {
                    monday: { enabled: true, open: '10:00', close: '23:00' },
                    tuesday: { enabled: true, open: '10:00', close: '23:00' },
                    wednesday: { enabled: true, open: '10:00', close: '23:00' },
                    thursday: { enabled: true, open: '10:00', close: '23:00' },
                    friday: { enabled: true, open: '10:00', close: '23:00' },
                    saturday: { enabled: true, open: '10:00', close: '23:00' },
                    sunday: { enabled: true, open: '10:00', close: '23:00' }
                },
                timezone: 'Europe/Moscow',
                currency: 'RUB',
                round_amounts: false
            };
            settings.value = {
                ...settings.value,
                ...s,
                working_hours: s.working_hours || defaults.working_hours,
                timezone: s.timezone || defaults.timezone,
                currency: s.currency || defaults.currency,
                round_amounts: s.round_amounts ?? defaults.round_amounts,
                business_day_ends_at: s.business_day_ends_at ?? 5
            };
        }
        if (res.integrations) integrations.value = res.integrations as typeof integrations.value;
        if (res.notifications) notifications.value = res.notifications as typeof notifications.value;
    } catch (e: any) {
        console.error('Failed to load settings:', e);
    }
}

async function saveSettings() {
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞–µ—Ç API
        const payload = {
            name: settings.value.name,
            address: settings.value.address,
            phone: settings.value.phone,
            email: settings.value.email,
            round_amounts: settings.value.round_amounts,
            working_hours: settings.value.working_hours,
            timezone: settings.value.timezone,
            currency: settings.value.currency,
            business_day_ends_at: settings.value.business_day_ends_at
        };
        await store.api('/backoffice/settings', {
            method: 'PUT',
            body: JSON.stringify(payload)
        });
        store.showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

async function saveNotifications() {
    try {
        await store.api('/backoffice/settings/notifications', {
            method: 'PUT',
            body: JSON.stringify(notifications.value)
        });
        store.showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

function openIntegrationModal(type: any) {
    store.showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

// Yandex Maps settings
async function loadYandexSettings() {
    try {
        const res = await store.api('/backoffice/settings/yandex') as Record<string, any>;
        if (res) {
            yandexForm.value = {
                enabled: res.enabled || false,
                api_key: res.api_key || '',
                city: res.city || '',
                restaurant_address: res.restaurant_address || '',
                restaurant_lat: res.restaurant_lat || '',
                restaurant_lng: res.restaurant_lng || ''
            };
            integrations.value.yandex = { enabled: res.enabled || false };
        }
    } catch (e: any) {
        console.error('Failed to load Yandex settings:', e);
    }
}

function openYandexModal() {
    yandexTestResult.value = null;
    geocodeAddressResult.value = null;
    showYandexModal.value = true;
}

async function geocodeRestaurantAddress() {
    if (!yandexForm.value.api_key || !yandexForm.value.restaurant_address) return;

    geocodingAddress.value = true;
    geocodeAddressResult.value = null;

    try {
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –∫ –∞–¥—Ä–µ—Å—É –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
        let address = yandexForm.value.restaurant_address;
        if (yandexForm.value.city && !address.toLowerCase().includes(yandexForm.value.city.toLowerCase())) {
            address = yandexForm.value.city + ', ' + address;
        }

        const res = await store.api('/backoffice/settings/yandex/geocode', {
            method: 'POST',
            body: JSON.stringify({
                address: address,
                api_key: yandexForm.value.api_key
            })
        }) as Record<string, any>;

        if (res.success && res.lat && res.lng) {
            yandexForm.value.restaurant_lat = String(res.lat);
            yandexForm.value.restaurant_lng = String(res.lng);
            geocodeAddressResult.value = {
                success: true,
                message: `–ù–∞–π–¥–µ–Ω–æ: ${res.formatted_address || address}`
            };
        } else {
            geocodeAddressResult.value = {
                success: false,
                message: res.error || '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω'
            };
        }
    } catch (e: any) {
        geocodeAddressResult.value = {
            success: false,
            message: '–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è'
        };
    } finally {
        geocodingAddress.value = false;
    }
}

async function saveYandexSettings() {
    if (!yandexForm.value.api_key || !yandexForm.value.restaurant_lat || !yandexForm.value.restaurant_lng) return;

    try {
        await store.api('/backoffice/settings/yandex', {
            method: 'PUT',
            body: JSON.stringify(yandexForm.value)
        });

        integrations.value.yandex = { enabled: yandexForm.value.enabled };
        showYandexModal.value = false;
        store.showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

async function testYandexConnection() {
    if (!yandexForm.value.api_key) return;

    yandexTestingConnection.value = true;
    yandexTestResult.value = null;

    try {
        const res = await store.api('/backoffice/settings/yandex/test', {
            method: 'POST',
            body: JSON.stringify({ api_key: yandexForm.value.api_key })
        });

        yandexTestResult.value = {
            success: res.success,
            message: res.success ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –ì–µ–æ–∫–æ–¥–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç.' : (res.error || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è')
        };
    } catch (e: any) {
        yandexTestResult.value = {
            success: false,
            message: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'
        };
    } finally {
        yandexTestingConnection.value = false;
    }
}

// Printers
async function loadPrinters() {
    try {
        const res = await store.api('/backoffice/printers') as Record<string, any>;
        printers.value = res.printers || [];
    } catch (e: any) {
        console.error('Failed to load printers:', e);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
function getPrinterIcon(type: any) {
    return ({
        receipt: 'üßæ',
        kitchen: 'üç≥',
        bar: 'üç∏',
        delivery: 'üöó',
        label: 'üè∑Ô∏è'
    } as Record<string, string>)[type] || 'üñ®Ô∏è';
}

function getPrinterTypeLabel(type: any) {
    return ({
        receipt: '–ö–∞—Å—Å–∞',
        kitchen: '–ö—É—Ö–Ω—è',
        bar: '–ë–∞—Ä',
        delivery: '–î–æ—Å—Ç–∞–≤–∫–∞',
        label: '–≠—Ç–∏–∫–µ—Ç–∫–∏'
    } as Record<string, string>)[type] || type;
}

function getPrinterTypeClass(type: any) {
    return ({
        receipt: 'bg-blue-100',
        kitchen: 'bg-orange-100',
        bar: 'bg-purple-100',
        delivery: 'bg-green-100',
        label: 'bg-gray-100'
    } as Record<string, string>)[type] || 'bg-gray-100';
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—á–∞—Ç–∏
async function loadPrintSettings() {
    try {
        const res = await store.api('/settings/print');
        if (res.data) {
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–µ—Ñ–æ–ª—Ç–∞–º–∏
            printSettings.value = {
                ...printSettings.value,
                ...res.data
            };
        }
    } catch (e: any) {
        console.error('Failed to load print settings:', e);
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—á–∞—Ç–∏
async function savePrintSettings() {
    try {
        await store.api('/settings/print', {
            method: 'PUT',
            body: JSON.stringify(printSettings.value)
        });
        window.$toast?.('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    } catch (e: any) {
        console.error('Failed to save print settings:', e);
        window.$toast?.('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

async function testPrintReceipt() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä—ã –¥–ª—è —á–µ–∫–æ–≤
    const receiptPrinter = printers.value.find((p: any) => p.type === 'receipt' && p.is_active);
    const kitchenPrinter = printers.value.find((p: any) => p.type === 'kitchen' && p.is_active);
    const deliveryPrinter = printers.value.find((p: any) => p.type === 'delivery' && p.is_active);

    let printerId = null;
    let testType = receiptSubTab.value;

    // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —á–µ–∫–∞
    if (testType === 'kitchen') {
        if (!kitchenPrinter) {
            window.$toast?.('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫—É—Ö–æ–Ω–Ω–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞', 'error');
            return;
        }
        printerId = kitchenPrinter.id;
    } else if (testType === 'delivery') {
        // –î–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –∫–∞—Å—Å–æ–≤—ã–π
        const printer = deliveryPrinter || receiptPrinter;
        if (!printer) {
            window.$toast?.('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏', 'error');
            return;
        }
        printerId = printer.id;
    } else {
        if (!receiptPrinter) {
            window.$toast?.('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ —á–µ–∫–æ–≤', 'error');
            return;
        }
        printerId = receiptPrinter.id;
    }

    testingPrint.value = true;
    try {
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        await store.api('/settings/print', {
            method: 'PUT',
            body: JSON.stringify(printSettings.value)
        });

        // –ó–∞—Ç–µ–º –ø–µ—á–∞—Ç–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —á–µ–∫
        const response = await store.api(`/backoffice/printers/${printerId}/test-receipt`, {
            method: 'POST',
            body: JSON.stringify({ type: testType })
        });

        if (response?.success) {
            window.$toast?.('–¢–µ—Å—Ç–æ–≤—ã–π —á–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å', 'success');
        } else {
            window.$toast?.(response?.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏', 'error');
        }
    } catch (e: any) {
        console.error('Test print error:', e);
        window.$toast?.(e.message || '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–µ—á–∞—Ç–∏', 'error');
    } finally {
        testingPrint.value = false;
    }
}

function openPrinterModal(printer: any = null) {
    if (printer) {
        printerForm.value = {
            id: printer.id,
            name: printer.name || '',
            type: printer.type || 'receipt',
            kitchen_station_id: printer.kitchen_station_id || null,
            connection_type: printer.connection_type || 'network',
            ip_address: printer.ip_address || '',
            port: printer.port || 9100,
            device_path: printer.device_path || '',
            paper_width: printer.paper_width || 80,
            chars_per_line: printer.chars_per_line || 48,
            encoding: printer.encoding || 'cp866',
            cut_paper: printer.cut_paper ?? true,
            open_drawer: printer.open_drawer ?? false,
            print_logo: printer.print_logo ?? false,
            print_qr: printer.print_qr ?? true,
            is_active: printer.is_active ?? true,
            is_default: printer.is_default ?? false
        };
    } else {
        printerForm.value = {
            id: null as any,
            name: '',
            type: 'receipt',
            kitchen_station_id: null as any,
            connection_type: 'network',
            ip_address: '',
            port: 9100,
            device_path: '',
            paper_width: 80,
            chars_per_line: 48,
            encoding: 'cp866',
            cut_paper: true,
            open_drawer: false,
            print_logo: false,
            print_qr: true,
            is_active: true,
            is_default: false
        };
    }
    showPrinterModal.value = true;
}

// Computed –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞
const canSavePrinter = computed(() => {
    if (!printerForm.value.name) return false;
    if (printerForm.value.connection_type === 'network' && !printerForm.value.ip_address) return false;
    if (printerForm.value.connection_type === 'usb' && !printerForm.value.device_path) return false;
    return true;
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —à–∏—Ä–∏–Ω—ã –±—É–º–∞–≥–∏
function updateCharsPerLine() {
    printerForm.value.chars_per_line = printerForm.value.paper_width === 80 ? 48 : 32;
}

async function savePrinter() {
    if (!canSavePrinter.value) return;

    try {
        const url = printerForm.value.id
            ? `/backoffice/printers/${printerForm.value.id}`
            : '/backoffice/printers';
        const method = printerForm.value.id ? 'PUT' : 'POST';

        await store.api(url, {
            method,
            body: JSON.stringify(printerForm.value)
        });

        showPrinterModal.value = false;
        loadPrinters();
        store.showToast('–ü—Ä–∏–Ω—Ç–µ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

async function deletePrinter(printer: any) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä "${printer.name}"?`)) return;

    try {
        await store.api(`/backoffice/printers/${printer.id}`, { method: 'DELETE' });
        loadPrinters();
        store.showToast('–ü—Ä–∏–Ω—Ç–µ—Ä —É–¥–∞–ª—ë–Ω', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
    }
}

async function testPrinter(printer: any) {
    try {
        store.showToast('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–µ—á–∞—Ç–∏...', 'info');
        const res = await store.api(`/backoffice/printers/${printer.id}/test`, { method: 'POST' });
        store.showToast(res.message || '–¢–µ—Å—Ç–æ–≤–∞—è –ø–µ—á–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', 'success');
    } catch (e: any) {
        console.error('Print error object:', e);
        console.error('Print error response:', e.response);
        console.error('Print error data:', e.response?.data);

        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç
        let errorData = e.response?.data || e.data || {};

        // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç - —Å—Ç—Ä–æ–∫–∞, –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
        if (typeof errorData === 'string') {
            try {
                errorData = JSON.parse(errorData);
            } catch (parseErr: any) {
                console.error('Failed to parse error response:', errorData);
            }
        }

        const message = errorData.message || e.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏';
        const debug = errorData.debug;

        console.error('Error message:', message);
        console.error('Error debug:', debug);

        if (debug) {
            console.error('=== PRINT DEBUG LOG ===');
            console.error(debug);
            console.error('=== END DEBUG LOG ===');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤ debug –≤ toast
            const shortDebug = debug.substring(0, 300);
            store.showToast(`${message}\n\n${shortDebug}...`, 'error');
        } else {
            store.showToast(message, 'error');
        }
    }
}

async function scanSystemPrinters() {
    scanningPrinters.value = true;
    scannedOnce.value = true;
    try {
        const res = await store.api('/backoffice/printers/system') as Record<string, any>;
        systemPrinters.value = res.printers || [];
        store.showToast(res.message || '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'success');
    } catch (e: any) {
        console.error('Failed to scan printers:', e);
        store.showToast('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤', 'error');
    } finally {
        scanningPrinters.value = false;
    }
}

function useSystemPrinter(sp: any) {
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
    printerForm.value = {
        id: null as any,
        name: sp.Name,
        type: 'receipt',
        kitchen_station_id: null as any,
        connection_type: 'usb',
        ip_address: '',
        port: 9100,
        device_path: sp.Name, // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω–æ–µ –∏–º—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏–∑ Windows
        paper_width: 58,
        chars_per_line: 32,
        encoding: 'cp866',
        cut_paper: true,
        open_drawer: false,
        print_logo: false,
        print_qr: false,
        is_active: true,
        is_default: false
    };
    showPrinterModal.value = true;
}

// Stations
async function loadStations() {
    try {
        const res = await store.api('/kitchen-stations') as Record<string, any>;
        stations.value = res.data || [];
    } catch (e: any) {
        console.error('Failed to load stations:', e);
    }
}

function openStationModal(station: any = null) {
    if (station) {
        stationForm.value = { ...station };
    } else {
        stationForm.value = {
            id: null as any,
            name: '',
            slug: '',
            icon: 'üî•',
            color: '#6366F1',
            description: '',
            notification_sound: 'bell',
            sort_order: stations.value.length,
            is_active: true,
            is_bar: false
        };
    }
    showStationModal.value = true;
}

function generateSlug() {
    if (!stationForm.value.id) {
        const translitMap: Record<string, string> = {
            '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'e',
            '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
            '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
            '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch', '—ä': '',
            '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya', ' ': '-'
        };
        stationForm.value.slug = stationForm.value.name
            .toLowerCase()
            .split('')
            .map((c: any) => translitMap[c] || c)
            .join('')
            .replace(/[^a-z0-9-]/g, '')
            .replace(/-+/g, '-');
    }
}

async function saveStation() {
    if (!stationForm.value.name) return;

    try {
        const url = stationForm.value.id
            ? `/kitchen-stations/${stationForm.value.id}`
            : '/kitchen-stations';
        const method = stationForm.value.id ? 'PUT' : 'POST';

        await store.api(url, {
            method,
            body: JSON.stringify(stationForm.value)
        });

        showStationModal.value = false;
        loadStations();
        store.showToast('–¶–µ—Ö —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

async function deleteStation(station: any) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ü–µ—Ö "${station.name}"? –ë–ª—é–¥–∞ —ç—Ç–æ–≥–æ —Ü–µ—Ö–∞ —Å—Ç–∞–Ω—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –≤—Å–µ—Ö –¥–∏—Å–ø–ª–µ—è—Ö.`)) return;

    try {
        await store.api(`/kitchen-stations/${station.id}`, { method: 'DELETE' });
        loadStations();
        store.showToast('–¶–µ—Ö —É–¥–∞–ª—ë–Ω', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
    }
}

async function toggleStation(station: any) {
    try {
        await store.api(`/kitchen-stations/${station.id}/toggle`, { method: 'PATCH' });
        loadStations();
        store.showToast(station.is_active ? '–¶–µ—Ö –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¶–µ—Ö –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞', 'error');
    }
}

function copyKitchenUrl(station: any) {
    const url = `${window.location.origin}/kitchen?station=${station.slug}`;
    navigator.clipboard.writeText(url);
    store.showToast('URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
}

// Web Audio API Synthesizer –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–≤—É–∫–æ–≤
let settingsAudioContext: any = null;

function getSettingsAudioContext() {
    if (!settingsAudioContext) {
        settingsAudioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    return settingsAudioContext;
}

// –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∑–≤—É–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function playStationSound(type: any) {
    const ctx = getSettingsAudioContext();
    const now = ctx.currentTime;

    switch (type) {
        case 'bell': {
            // –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ —Å –≥–∞—Ä–º–æ–Ω–∏–∫–∞–º–∏
            const fundamental = 880;
            [1, 2, 3, 4.2, 5.4].forEach((harmonic: any, i: any) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = fundamental * harmonic;
                gain.gain.setValueAtTime(0.3 / (i + 1), now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(now);
                osc.stop(now + 1.5);
            });
            break;
        }
        case 'chime': {
            // –ú–µ–ª–æ–¥–∏—á–Ω—ã–π –ø–µ—Ä–µ–∑–≤–æ–Ω - 3 –Ω–æ—Ç—ã –º–∞–∂–æ—Ä–Ω–æ–≥–æ –∞–∫–∫–æ—Ä–¥–∞
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            notes.forEach((freq: any, i: any) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = freq;
                const startTime = now + i * 0.15;
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.25, startTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 1.0);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(startTime);
                osc.stop(startTime + 1.0);
            });
            break;
        }
        case 'ding': {
            // –Ø—Ä–∫–∏–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –∑–≤—É–∫ —Å –æ–±–µ—Ä—Ç–æ–Ω–æ–º
            const osc1 = ctx.createOscillator();
            const osc2 = ctx.createOscillator();
            const gain = ctx.createGain();
            osc1.type = 'sine';
            osc1.frequency.value = 1046.5; // C6
            osc2.type = 'sine';
            osc2.frequency.value = 2093; // C7 (–æ–∫—Ç–∞–≤–∞ –≤—ã—à–µ)
            gain.gain.setValueAtTime(0.35, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
            osc1.connect(gain);
            osc2.connect(gain);
            gain.connect(ctx.destination);
            osc1.start(now);
            osc2.start(now);
            osc1.stop(now + 0.8);
            osc2.stop(now + 0.8);
            break;
        }
        case 'kitchen': {
            // –î–≤–æ–π–Ω–æ–π –∑–≤–æ–Ω–æ–∫ –¥–∏–Ω-–¥–∏–Ω
            [0, 0.2].forEach((delay: any) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = 740; // F#5
                const startTime = now + delay;
                gain.gain.setValueAtTime(0.3, startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.3);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(startTime);
                osc.stop(startTime + 0.3);
            });
            break;
        }
        case 'alert': {
            // –î–≤—É—Ö—Ç–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–∏—è—Ç–Ω—ã–π —Å–∏–≥–Ω–∞–ª
            const frequencies = [587.33, 783.99]; // D5, G5
            frequencies.forEach((freq: any, i: any) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = freq;
                const startTime = now + i * 0.12;
                gain.gain.setValueAtTime(0.25, startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.4);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(startTime);
                osc.stop(startTime + 0.4);
            });
            break;
        }
        case 'gong': {
            // –ì–ª—É–±–æ–∫–∏–π –≥–æ–Ω–≥ —Å –¥–ª–∏–Ω–Ω—ã–º –∑–∞—Ç—É—Ö–∞–Ω–∏–µ–º
            const fundamental = 110; // A2
            [1, 2.4, 3.5, 4.7].forEach((harmonic: any, i: any) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = fundamental * harmonic;
                gain.gain.setValueAtTime(0.2 / (i + 1), now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 3.0);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(now);
                osc.stop(now + 3.0);
            });
            break;
        }
        default: {
            // Fallback - –ø—Ä–æ—Å—Ç–æ–π beep
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 880;
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(now);
            osc.stop(now + 0.5);
        }
    }
}

// Devices
async function loadDevices() {
    try {
        const res = await store.api('/kitchen-devices') as Record<string, any>;
        devices.value = res.data || [];
    } catch (e: any) {
        console.error('Failed to load devices:', e);
    }
}

function openCreateDeviceModal() {
    deviceForm.value = {
        id: null as any,
        device_id: null as any,
        name: '',
        kitchen_station_id: null as any,
        status: 'pending',
        pin: '',
        ip_address: null as any,
        last_seen_at: null as any
    };
    showDeviceModal.value = true;
}

function openDeviceModal(device: any) {
    deviceForm.value = {
        id: device.id,
        device_id: device.device_id,
        name: device.name,
        kitchen_station_id: device.kitchen_station_id,
        status: device.status,
        pin: device.has_pin ? '******' : '',
        ip_address: device.ip_address,
        last_seen_at: device.last_seen_at
    };
    showDeviceModal.value = true;
}

async function saveDevice() {
    try {
        const data: Record<string, any> = {
            name: deviceForm.value.name,
            kitchen_station_id: deviceForm.value.kitchen_station_id,
        };

        // Only send PIN if it was changed (not the masked value)
        if (deviceForm.value.pin && deviceForm.value.pin !== '******') {
            data.pin = deviceForm.value.pin;
        } else if (!deviceForm.value.pin) {
            data.pin = null;
        }

        if (deviceForm.value.id) {
            // Update existing device
            data.status = deviceForm.value.status;
            await store.api(`/kitchen-devices/${deviceForm.value.id}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
            store.showToast('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        } else {
            // Create new device
            await store.api('/kitchen-devices', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            store.showToast('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–æ', 'success');
        }

        showDeviceModal.value = false;
        loadDevices();
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

async function deleteDevice(device: any) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "${device.name}"?`)) return;

    try {
        await store.api(`/kitchen-devices/${device.id}`, { method: 'DELETE' });
        loadDevices();
        store.showToast('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
    }
}

async function regenerateLinkingCode(device: any) {
    try {
        await store.api(`/kitchen-devices/${device.id}/regenerate-code`, {
            method: 'POST'
        });
        loadDevices();
        store.showToast('–ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞', 'error');
    }
}

function copyLinkingCode(device: any) {
    if (device.linking_code?.code) {
        navigator.clipboard.writeText(device.linking_code.code);
        store.showToast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
    }
}

async function unlinkDevice(device: any) {
    if (!confirm(`–û—Ç–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "${device.name}"?\n\n–ü–æ—Å–ª–µ –æ—Ç–≤—è–∑–∫–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ.`)) return;

    try {
        await store.api(`/kitchen-devices/${device.id}/unlink`, {
            method: 'POST'
        });
        loadDevices();
        store.showToast('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–≤—è–∑–∞–Ω–æ', 'success');
    } catch (e: any) {
        store.showToast('–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏', 'error');
    }
}

function isDeviceOnline(device: any) {
    if (!device.last_seen_at) return false;
    const lastSeen = new Date(device.last_seen_at);
    const now = new Date();
    const diffMinutes = (now.getTime() - lastSeen.getTime()) / 1000 / 60;
    return diffMinutes < 5; // Online if seen in last 5 minutes
}

function formatDate(dateStr: any) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMinutes = Math.floor((now.getTime() - date.getTime()) / 1000 / 60);

    if (diffMinutes < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diffMinutes < 60) return `${diffMinutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
    if (diffMinutes < 1440) {
        const hours = Math.floor(diffMinutes / 60);
        return `${hours} —á. –Ω–∞–∑–∞–¥`;
    }

    return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è –ø—Ä–µ–≤—å—é —á–µ–∫–æ–≤
function formatReceiptDate(date: any) {
    return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatReceiptDateTime(date: any) {
    return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU');
}

// Init
// === Location Management ===
async function loadLocations() {
    try {
        const res = await store.api('/tenant/restaurants') as Record<string, any>;
        if (res.data) {
            locations.value = res.data;
        }
    } catch (e: any) {
        console.error('Failed to load locations:', e);
    }
}

function openLocationModal(loc: any = null) {
    if (loc) {
        locationForm.value = {
            id: loc.id,
            name: loc.name || '',
            address: loc.address || '',
            phone: loc.phone || '',
            email: loc.email || '',
            is_active: loc.is_active !== false
        };
    } else {
        locationForm.value = {
            id: null as any,
            name: '',
            address: '',
            phone: '',
            email: '',
            is_active: true
        };
    }
    showLocationModal.value = true;
}

async function saveLocation() {
    if (!locationForm.value.name) return;

    savingLocation.value = true;
    try {
        if (locationForm.value.id) {
            // Update existing
            await store.api(`/tenant/restaurants/${locationForm.value.id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    name: locationForm.value.name,
                    address: locationForm.value.address,
                    phone: locationForm.value.phone,
                    email: locationForm.value.email,
                    is_active: locationForm.value.is_active
                })
            });
            store.showToast('–¢–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
        } else {
            // Create new
            const res = await store.api('/tenant/restaurants', {
                method: 'POST',
                body: JSON.stringify({
                    name: locationForm.value.name,
                    address: locationForm.value.address,
                    phone: locationForm.value.phone,
                    email: locationForm.value.email
                })
            });
            if (res.upgrade_required) {
                locationLimitReached.value = true;
                store.showToast('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Ç–æ—á–µ–∫ –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞', 'error');
                return;
            }
            store.showToast('–¢–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
        }
        showLocationModal.value = false;
        await loadLocations();
        await store.loadRestaurants();
    } catch (e: any) {
        if (e.message?.includes('–ª–∏–º–∏—Ç') || e.message?.includes('upgrade')) {
            locationLimitReached.value = true;
        }
        store.showToast(e.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    } finally {
        savingLocation.value = false;
    }
}

async function deleteLocation(loc: any) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É "${loc.name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

    try {
        await store.api(`/tenant/restaurants/${loc.id}`, { method: 'DELETE' });
        store.showToast('–¢–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        await loadLocations();
        await store.loadRestaurants();
    } catch (e: any) {
        store.showToast(e.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
    }
}

async function makeMainLocation(loc: any) {
    if (!confirm(`–°–¥–µ–ª–∞—Ç—å "${loc.name}" –≥–ª–∞–≤–Ω–æ–π —Ç–æ—á–∫–æ–π?`)) return;

    try {
        await store.api(`/tenant/restaurants/${loc.id}/make-main`, { method: 'POST' });
        store.showToast('–ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
        await loadLocations();
        await store.loadRestaurants();
    } catch (e: any) {
        store.showToast(e.message || '–û—à–∏–±–∫–∞', 'error');
    }
}

async function switchLocation(loc: any) {
    try {
        await store.switchRestaurant(loc.id);
        await loadLocations();
        store.showToast(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ${loc.name}`, 'success');
    } catch (e: any) {
        store.showToast(e.message || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è', 'error');
    }
}

// Legal Entity methods
async function loadLegalEntities() {
    try {
        const res = await store.api('/legal-entities') as Record<string, any>;
        if (res.data) {
            legalEntities.value = res.data;
        }
    } catch (e: any) {
        console.error('Failed to load legal entities:', e);
    }
}

function getLocationLegalEntities(locationId: any) {
    return legalEntities.value.filter((e: any) => e.restaurant_id === locationId);
}

function toggleLocationLegalEntities(locationId: any) {
    if (expandedLocationEntities.value.has(locationId)) {
        expandedLocationEntities.value.delete(locationId);
    } else {
        expandedLocationEntities.value.add(locationId);
    }
}

function openLegalEntityModal(restaurantId: any, entity: any = null) {
    if (entity) {
        legalEntityForm.value = { ...entity };
    } else {
        legalEntityForm.value = {
            id: null as any,
            restaurant_id: restaurantId,
            name: '',
            short_name: '',
            type: 'llc',
            inn: '',
            kpp: '',
            ogrn: '',
            legal_address: '',
            actual_address: '',
            director_name: '',
            director_position: '',
            bank_name: '',
            bank_bik: '',
            bank_account: '',
            bank_corr_account: '',
            taxation_system: 'usn_income',
            vat_rate: null as any,
            has_alcohol_license: false,
            alcohol_license_number: '',
            alcohol_license_expires_at: null as any,
            is_active: true,
            is_default: false
        };
    }
    showLegalEntityModal.value = true;
}

async function saveLegalEntity() {
    if (!legalEntityForm.value.name || !legalEntityForm.value.inn) return;

    savingLegalEntity.value = true;
    try {
        const method = legalEntityForm.value.id ? 'PUT' : 'POST';
        const endpoint = legalEntityForm.value.id
            ? `/legal-entities/${legalEntityForm.value.id}`
            : '/legal-entities';

        await store.api(endpoint, {
            method,
            body: JSON.stringify(legalEntityForm.value)
        });

        store.showToast(legalEntityForm.value.id ? '–Æ—Ä–ª–∏—Ü–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : '–Æ—Ä–ª–∏—Ü–æ —Å–æ–∑–¥–∞–Ω–æ', 'success');
        showLegalEntityModal.value = false;
        await loadLegalEntities();
    } catch (e: any) {
        store.showToast(e.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    } finally {
        savingLegalEntity.value = false;
    }
}

async function deleteLegalEntity(entity: any) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —é—Ä–ª–∏—Ü–æ "${entity.name}"?`)) return;

    try {
        await store.api(`/legal-entities/${entity.id}`, { method: 'DELETE' });
        store.showToast('–Æ—Ä–ª–∏—Ü–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
        await loadLegalEntities();
    } catch (e: any) {
        store.showToast(e.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
    }
}

onMounted(() => {
    loadSettings();
    loadPrinters();
    loadPrintSettings();
    loadStations();
    loadDevices();
    loadYandexSettings();
    loadLocations();
    loadLegalEntities();
});
</script>

<style scoped>
.receipt-preview {
    background: linear-gradient(to bottom, #fafafa 0%, #ffffff 3%, #ffffff 97%, #fafafa 100%);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
}

.receipt-preview .font-mono {
    font-family: 'Courier New', Courier, monospace;
    letter-spacing: -0.5px;
}
</style>
